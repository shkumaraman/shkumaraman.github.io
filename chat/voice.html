<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-User Voice Room</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body{font-family:sans-serif;background:#111;color:#eee;padding:15px}
button{padding:6px 10px;margin-left:5px}
#users div{margin-top:6px;padding:6px;background:#222;border-radius:4px}
#status{margin-top:10px;font-weight:bold}
</style>
</head>
<body>

<h3>4-User Voice Room</h3>
<input id="roomId" placeholder="Room ID">
<button id="joinBtn">Join</button>
<div id="status">Idle</div>
<h4>Users</h4>
<div id="users"></div>

<script>
const MAX_USERS=4
let peer,localStream,isHost=false
const peers=new Set()
const calls=new Map()
const dataConns=new Map()
const statusEl=document.getElementById("status")
const usersEl=document.getElementById("users")

function setStatus(t){statusEl.textContent=t}

function renderUsers(){
  usersEl.innerHTML=""
  peers.forEach(id=>{
    const d=document.createElement("div")
    d.textContent=id===peer.id?`${id} (You)`:id
    if(isHost && id!==peer.id){
      const b=document.createElement("button")
      b.textContent="Kick"
      b.onclick=()=>kick(id)
      d.appendChild(b)
    }
    usersEl.appendChild(d)
  })
}

async function getAudio(){
  return navigator.mediaDevices.getUserMedia({audio:true})
}

document.getElementById("joinBtn").onclick=async()=>{
  const roomId=document.getElementById("roomId").value.trim()
  if(!roomId)return

  peer=new Peer(roomId)
  isHost=true

  peer.on("error",()=>{
    peer.destroy()
    peer=new Peer()
    isHost=false

    peer.on("open",async()=>{
      localStream=await getAudio()
      const c=peer.connect(roomId)
      registerDataConn(c)
      setStatus("Connected")
    })
  })

  peer.on("open",async()=>{
    localStream=await getAudio()
    peers.add(peer.id)
    renderUsers()
    setStatus("Connected (Host)")
  })

  peer.on("call",call=>{
    call.answer(localStream)
    registerCall(call)
  })

  peer.on("connection",registerDataConn)
}

function registerDataConn(conn){
  conn.on("open",()=>{
    dataConns.set(conn.peer,conn)
    conn.on("data",m=>handleData(conn.peer,m))
    if(!isHost)conn.send({type:"join"})
  })
}

function handleData(from,msg){
  if(msg.type==="peers"){
    peers.clear()
    msg.list.forEach(p=>peers.add(p))
    renderUsers()
    msg.list.forEach(p=>p!==peer.id && connectAudio(p))
  }

  if(isHost && msg.type==="join"){
    if(peers.size>=MAX_USERS){
      dataConns.get(from).send({type:"kick"})
      return
    }
    peers.add(from)
    broadcast()
  }

  if(msg.type==="kick"){
    cleanup()
    setStatus("Kicked")
  }
}

function broadcast(){
  const list=[...peers]
  renderUsers()
  dataConns.forEach(c=>c.send({type:"peers",list}))
}

function connectAudio(id){
  if(calls.has(id))return
  registerCall(peer.call(id,localStream))
}

function registerCall(call){
  calls.set(call.peer,call)
  call.on("stream",s=>{
    const a=document.createElement("audio")
    a.srcObject=s
    a.autoplay=true
    document.body.appendChild(a)
  })
}

function kick(id){
  dataConns.get(id)?.send({type:"kick"})
  peers.delete(id)
  broadcast()
}

function cleanup(){
  calls.forEach(c=>c.close())
  dataConns.forEach(c=>c.close())
  document.querySelectorAll("audio").forEach(a=>a.remove())
  localStream?.getTracks().forEach(t=>t.stop())
  peer?.destroy()
}
</script>
</body>
</html>
