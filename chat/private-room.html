---
layout: default
title: "Private Chat Room"
description: "Create a secure 2-person private chat room. Share a code, enjoy safe text or video chat, and have private conversations anytime, anywhere."
---

<style>
:root {
  --dark-bg: #121212;
  --dark-header-bg: #181818;
  --dark-header-border: #2a2a2a;
  --dark-chat-bg: #1e1e1e;
  --dark-text: #fff;
  --dark-secondary-text: #aaa;
  --dark-input-bg: #333;
  --dark-input-focus: #444;
  --dark-icon-color: #ccc;
  --dark-icon-hover-bg: rgba(255,255,255,0.1);
  --dark-scroll-thumb: #444;
  --dark-scroll-hover: #555;
  --dark-btn-primary: #007bff;
  --light-bg: #f5f5f5;
  --light-header-bg: #ffffff;
  --light-header-border: #e0e0e0;
  --light-chat-bg: #f9f9f9;
  --light-msg-bg: #e9e9e9;
  --light-text: #333;
  --light-secondary-text: #666;
  --light-input-bg: #e0e0e0;
  --light-input-focus: #d0d0d0;
  --light-icon-color: #666;
  --light-icon-hover-bg: rgba(0,0,0,0.05);
  --light-scroll-thumb: #ccc;
  --light-scroll-hover: #aaa;
  --skip-btn: #ff4d4d;
  --skip-btn-hover: #ff3333;
  --error: #dc3545;
}

* { box-sizing: border-box; }
html, body { overflow-x: hidden; }

body {
  margin: 0; padding: 0;
  font-family: 'Segoe UI', sans-serif;
  background: var(--dark-bg);
  color: var(--dark-text);
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: background 0.3s, color 0.3s;
}

body.light-mode { background: var(--light-bg); color: var(--light-text); }

.app-header {
  position: fixed !important;
  top: 0; left: 0;
  width: 100%; height: 50px;
  background: var(--dark-header-bg);
  padding: 8px 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  border-bottom: 1px solid var(--dark-header-border);
  z-index: 10000;
}

.light-mode .app-header { background: var(--light-header-bg); border-bottom: 1px solid var(--light-header-border); }
.header-left, .header-right { display: flex; align-items: center; gap: 10px; }
.logo { height: 40px; width: 40px; border-radius: 10px; }
.app-title { font-size: 1em; color: var(--dark-text); margin: 0; }
.light-mode .app-title { color: var(--light-text); }

.header-toggle {
  background: none; border: none;
  color: var(--dark-icon-color);
  font-size: 1.1em; cursor: pointer;
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%; transition: all 0.3s;
}

.header-toggle:hover { background: var(--dark-icon-hover-bg); }
.light-mode .header-toggle { color: var(--light-icon-color); }
.light-mode .header-toggle:hover { background: var(--light-icon-hover-bg); }

.chat-container { display: flex; flex-direction: column; position: relative; padding: 50px 0 0 0; }

#chatLog {
  padding: 12px;
  overflow-y: auto;
  background: var(--dark-chat-bg);
  display: flex;
  flex-direction: column;
}

.light-mode #chatLog { background: var(--light-chat-bg); }

.msg {
  margin: 5px 0; padding: 5px 8px;
  background: var(--light-msg-bg);
  color: var(--light-text);
  border: 1px solid var(--dark-secondary-text);
  border-radius: 15px;
  max-width: 80%;
  word-wrap: break-word;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.me { align-self: flex-end; border-bottom-right-radius: 5px; }
.stranger { align-self: flex-start; border-bottom-left-radius: 5px; }
.timestamp { font-size: 0.7em; color: var(--dark-secondary-text); text-align: right; }

.chat-controls {
  position: fixed; bottom: 0;
  display: flex; align-items: center;
  padding: 5px;
  background: var(--dark-header-bg);
  width: 100%; z-index: 1000; gap: 8px;
}

.light-mode .chat-controls { background: var(--light-header-bg); }

#skipBtn {
  background: var(--skip-btn); border: none;
  padding: 12px; border-radius: 25px;
  color: white; cursor: pointer;
  font-size: 1em; display: flex;
  align-items: center; justify-content: center;
  transition: background 0.2s;
}

#skipBtn:hover { background: var(--skip-btn-hover); }
.input-area { flex: 1; position: relative; }

#msgInput {
  width: 100%;
  padding: 12px 80px 12px 15px;
  border-radius: 25px; border: none;
  background: var(--dark-input-bg);
  color: var(--dark-text);
  font-size: 1em; outline: none;
}

#msgInput:focus { background: var(--dark-input-focus); }
.light-mode #msgInput { background: var(--light-input-bg); color: var(--light-text); }
.light-mode #msgInput:focus { background: var(--light-input-focus); }

#msgInput::placeholder { color: var(--dark-secondary-text); }
.light-mode #msgInput::placeholder { color: var(--light-secondary-text); }

.input-icons {
  position: absolute; right: 8px; top: 50%;
  transform: translateY(-50%); display: flex;
}

.icon-btn {
  background: none; border: none;
  color: var(--dark-icon-color);
  font-size: 1.1em; cursor: pointer;
  transition: color 0.2s;
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
}

.icon-btn:hover { color: var(--dark-text); background: var(--dark-icon-hover-bg); }
.light-mode .icon-btn { color: var(--light-icon-color); }
.light-mode .icon-btn:hover { color: var(--light-text); background: var(--light-icon-hover-bg); }

#imgInput, #gifInput { display: none; }
.msg img { max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 5px; }

.system-msg {
  align-self: center;
  background: transparent;
  color: var(--dark-secondary-text);
  text-align: center;
  padding: 5px 0; font-size: 0.9em;
}

.light-mode .system-msg { color: var(--light-secondary-text); }

#chatLog::-webkit-scrollbar { width: 8px; }
#chatLog::-webkit-scrollbar-track { background: var(--dark-chat-bg); }
#chatLog::-webkit-scrollbar-thumb { background: var(--dark-scroll-thumb); border-radius: 4px; }
#chatLog::-webkit-scrollbar-thumb:hover { background: var(--dark-scroll-hover); }
.light-mode #chatLog::-webkit-scrollbar-track { background: var(--light-chat-bg); }
.light-mode #chatLog::-webkit-scrollbar-thumb { background: var(--light-scroll-thumb); }
.light-mode #chatLog::-webkit-scrollbar-thumb:hover { background: var(--light-scroll-hover); }

.gif-modal {
  display: none;
  position: fixed; bottom: 80px; right: 20px;
  width: 300px; max-height: 400px;
  background: var(--dark-msg-bg);
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  z-index: 1001; padding: 15px; overflow: hidden;
}

.light-mode .gif-modal { background: var(--light-msg-bg); }

.gif-search {
  width: 100%; padding: 8px 12px;
  border-radius: 20px; border: none;
  background: var(--dark-input-bg);
  color: var(--dark-text); margin-bottom: 10px;
}

.gif-search::placeholder { color: var(--dark-secondary-text); }
.light-mode .gif-search { background: var(--light-input-bg); color: var(--light-text); }
.light-mode .gif-search::placeholder { color: var(--light-secondary-text); }

.gif-results {
  height: 300px; overflow-y: auto;
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
}

.gif-item {
  width: 100%; height: 100px;
  object-fit: cover; border-radius: 5px;
  cursor: pointer; transition: transform 0.2s;
}

.gif-item:hover { transform: scale(1.05); }

#typingIndicator {
  position: absolute; bottom: 0; left: 12px;
  font-style: italic; color: var(--dark-secondary-text);
  display: none; pointer-events: none;
}

.light-mode #typingIndicator { color: var(--light-secondary-text); }

.pr-modal {
  display: none; position: fixed;
  z-index: 999; left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.4);
}

.pr-modal-content {
  position: relative;
  background-color: var(--dark-msg-bg);
  color: var(--dark-text);
  margin: 100px auto; padding: 20px;
  border-radius: 10px;
  width: 90%; max-width: 400px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.light-mode .pr-modal-content { background-color: var(--light-msg-bg); color: var(--light-text); }

.pr-room-code-display {
  text-align: center; font-size: 2em;
  font-weight: bold; letter-spacing: 5px;
  margin: 20px 0; padding: 10px;
  background: rgba(0,0,0,0.1); border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  color: var(--dark-text);
}

.light-mode .pr-room-code-display { background: rgba(0,0,0,0.05); color: var(--light-text); }

.pr-code-input {
  display: flex; gap: 10px;
  margin-bottom: 20px;
  width: 100%; max-width: 100%;
}

.pr-code-input input {
  flex: 1; padding: 10px 15px;
  border-radius: 5px; border: 1px solid #ccc;
  font-size: 1.2em; text-align: center;
  letter-spacing: 5px;
  max-width: calc(100% - 100px);
  color: var(--dark-text);
  background: var(--dark-input-bg);
}

.light-mode .pr-code-input input { background: white; color: black; }

#prJoinRoomBtn {
  padding: 10px 20px; border: none;
  border-radius: 5px; cursor: pointer;
  font-size: 1em; transition: background-color 0.3s;
  background-color: var(--dark-btn-primary);
  color: white; white-space: nowrap;
  width: 90px; flex-shrink: 0;
}

.pr-btn {
  padding: 10px 20px; border: none;
  border-radius: 5px; cursor: pointer;
  font-size: 1em; transition: background-color 0.3s;
}

.pr-btn-primary { background-color: var(--dark-btn-primary); color: white; }
.pr-btn-primary:hover { opacity: 0.9; }
.pr-modal-buttons { display: flex; gap: 10px; justify-content: center; }

.pr-error-message {
  color: var(--error); text-align: center;
  margin-top: 10px; display: none;
}

.pr-copy-btn {
  background: none; border: none;
  color: var(--dark-icon-color);
  cursor: pointer; font-size: 1em;
  margin-left: 10px; width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 4px; transition: all 0.2s;
}

.pr-copy-btn:hover { color: var(--dark-text); background: var(--dark-icon-hover-bg); }
.light-mode .pr-copy-btn { color: var(--light-icon-color); }
.light-mode .pr-copy-btn:hover { color: var(--light-text); background: var(--light-icon-hover-bg); }

.video-call-container {
  display: none; position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 10002; flex-direction: column;
  justify-content: center; align-items: center;
}

.video-controls {
  position: absolute; bottom: 20px;
  left: 0; width: 100%;
  display: flex; justify-content: center;
  gap: 15px; z-index: 10003;
}

.video-control-btn {
  width: 50px; height: 50px;
  border-radius: 50%; border: none;
  background: rgba(255,255,255,0.2);
  color: white; font-size: 1.2em;
  cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  transition: all 0.3s;
}

.video-control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
.video-control-btn.end-call { background: #ff4d4d; }
.video-control-btn.end-call:hover { background: #ff3333; }

.video-grid {
  display: flex; width: 90%;
  max-width: 1200px; height: 70%; gap: 10px;
}

.video-container {
  flex: 1; position: relative;
  border-radius: 10px; overflow: hidden; background: #000;
}

.video-container video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1) !important; }

.video-label {
  position: absolute; bottom: 10px; left: 10px;
  background: rgba(0,0,0,0.6);
  color: white; padding: 5px 10px;
  border-radius: 5px; font-size: 0.9em;
}

.call-request-modal {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: var(--dark-chat-bg);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  border: 1px solid var(--dark-header-border);
  min-width: 300px;
  z-index: 10010;
}

.light-mode .call-request-modal { background: var(--light-chat-bg); color: var(--light-text); border: 1px solid var(--light-header-border); }
.call-request-modal h3 { margin-top: 0; margin-bottom: 10px; }
.call-request-buttons { display: flex; gap: 10px; margin-top: 15px; }

.call-modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10009;
}

.call-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
.call-btn.accept { background: #4CAF50; color: white; }
.call-btn.accept:hover { opacity: 0.85; }
.call-btn.decline { background: #f44336; color: white; }
.call-btn.decline:hover { opacity: 0.85; }

@media (max-width: 600px) {
  .msg { max-width: 85%; }
  #skipBtn { padding: 15px; font-size: 0.9em; }
  .gif-modal { width: 90%; left: 5%; right: 5%; }
  .header-right { gap: 5px; }
  .video-grid { flex-direction: column; height: 80%; }
  .video-container { flex: 1; }
  .video-controls { bottom: 10px; }
  .video-control-btn { width: 45px; height: 45px; }
}
</style>

<div id="prRoomModal" class="pr-modal">
  <div class="pr-modal-content">
    <div id="prCreateRoomSection">
      <p>Create a new 2 person private room and share the code with someone:</p>
      <div class="pr-room-code-display">
        <span id="prRoomCodeDisplay">-----</span>
        <button class="pr-copy-btn" id="prShareRoom" title="Share Room Link">
          <i class="fa-solid fa-arrow-up-from-bracket"></i>
        </button>
      </div>
      <div class="pr-modal-buttons">
        <button class="pr-btn pr-btn-primary" id="prCreateRoomBtn">Create Private Room</button>
      </div>
    </div>
    <div id="prJoinRoomSection" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
      <p>Join an existing room with a code:</p>
      <div class="pr-code-input">
        <input type="text" id="prRoomCodeInput" maxlength="5" placeholder="12345">
        <button class="pr-btn pr-btn-primary" id="prJoinRoomBtn">Join</button>
      </div>
      <div id="prJoinError" class="pr-error-message">Invalid room code</div>
    </div>
  </div>
</div>

<div id="callRequestModal" class="call-request-modal">
  <h3>Incoming Video Call</h3>
  <p id="callRequestText">Stranger wants to start a video call!</p>
  <div class="call-request-buttons">
    <button class="call-btn accept" id="acceptCallBtn"><i class="fas fa-phone"></i> Accept</button>
    <button class="call-btn decline" id="declineCallBtn"><i class="fas fa-phone-slash"></i> Decline</button>
  </div>
</div>

<div id="videoCallContainer" class="video-call-container">
  <div class="video-grid">
    <div class="video-container">
      <video id="localVideo" autoplay muted></video>
      <div class="video-label">You</div>
    </div>
    <div class="video-container">
      <video id="remoteVideo" autoplay></video>
      <div class="video-label">Stranger</div>
    </div>
  </div>
  <div class="video-controls">
    <button class="video-control-btn" id="toggleVideoBtn" title="Toggle Video"><i class="fas fa-video"></i></button>
    <button class="video-control-btn" id="toggleAudioBtn" title="Toggle Audio"><i class="fas fa-microphone"></i></button>
    <button class="video-control-btn end-call" id="endCallBtn" title="End Call"><i class="fas fa-phone-slash"></i></button>
  </div>
</div>

<div class="chat-container">
  <header class="app-header">
    <div class="header-left">
      <button class="menu-btn" onclick="toggleMenu()">&#9776;</button>
      <img src="logo.png" alt="TalkRush Logo" class="logo">
      <h1 class="app-title">Private Room</h1>
    </div>
    <div class="header-right">
      <button class="header-toggle" id="themeToggle" title="Toggle Dark/Light Mode"><i class="fas fa-moon"></i></button>
      <button class="header-toggle" id="roomBtn"><i class="fas fa-door-closed"></i></button>
      <button class="header-toggle" id="videoCallBtn" title="Start Video Call" style="display: none;"><i class="fas fa-video"></i></button>
    </div>
  </header>

  <div id="chatLog"></div>
  <div id="typingIndicator">Stranger is typing...</div>

  <div class="chat-controls">
    <button id="skipBtn"><i class="fas fa-times"></i></button>
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type your message..." />
      <div class="input-icons">
        <label for="imgInput" class="icon-btn" title="Send Image"><i class="fas fa-image"></i></label>
        <label for="gifInput" class="icon-btn" title="Send GIF"><i class="fas fa-film"></i></label>
        <button id="sendBtn" class="icon-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <input type="file" id="imgInput" accept="image/*" />
  <input type="file" id="gifInput" accept="image/gif" />

  <div class="gif-modal" id="gifModal">
    <input type="text" class="gif-search" id="gifSearch" placeholder="Search GIFs..." />
    <div class="gif-results" id="gifResults"></div>
  </div>
</div>

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7059052735946479"
     data-ad-slot="8592327962"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

{% include scripts.html %}
{% include menu.html %}

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

  const firebaseConfig = {
    databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let GIPHY_API_KEY = '';

  async function loadKeys() {
    const res = await fetch('/key.json');
    const keys = await res.json();
    GIPHY_API_KEY = keys.giphy;
  }

  const state = {
    peer: null, myConn: null, myId: null,
    currentSystemMessage: null, isConnected: false,
    escPressedOnce: false, escTimer: null,
    currentRoomCode: null, typingTimeout: null,
    localStream: null, remoteStream: null,
    isVideoCallActive: false,
    isVideoCallRequested: false,
    isVideoCallRequestPending: false
  };

  const el = {
    prRoomModal: document.getElementById("prRoomModal"),
    prRoomCodeDisplay: document.getElementById("prRoomCodeDisplay"),
    prRoomCodeInput: document.getElementById("prRoomCodeInput"),
    prCreateRoomBtn: document.getElementById("prCreateRoomBtn"),
    prJoinRoomBtn: document.getElementById("prJoinRoomBtn"),
    prJoinError: document.getElementById("prJoinError"),
    roomBtn: document.getElementById("roomBtn"),
    prShareRoom: document.getElementById("prShareRoom"),
    videoCallBtn: document.getElementById("videoCallBtn"),
    callRequestModal: document.getElementById("callRequestModal"),
    acceptCallBtn: document.getElementById("acceptCallBtn"),
    declineCallBtn: document.getElementById("declineCallBtn"),
    videoCallContainer: document.getElementById("videoCallContainer"),
    localVideo: document.getElementById("localVideo"),
    remoteVideo: document.getElementById("remoteVideo"),
    toggleVideoBtn: document.getElementById("toggleVideoBtn"),
    toggleAudioBtn: document.getElementById("toggleAudioBtn"),
    endCallBtn: document.getElementById("endCallBtn"),
    chatLog: document.getElementById("chatLog"),
    msgInput: document.getElementById("msgInput"),
    sendBtn: document.getElementById("sendBtn"),
    imgInput: document.getElementById("imgInput"),
    gifModal: document.getElementById("gifModal"),
    gifSearch: document.getElementById("gifSearch"),
    gifResults: document.getElementById("gifResults"),
    gifBtn: document.querySelector('[for="gifInput"]'),
    skipBtn: document.getElementById("skipBtn"),
    typingIndicator: document.getElementById("typingIndicator")
  };

  const utils = {
    generateRoomCode: () => Math.floor(10000 + Math.random() * 90000).toString(),
    scrollToBottom: () => el.chatLog.scrollTop = el.chatLog.scrollHeight,
    formatTime: () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    show: (e) => e.style.display = "flex",
    showBlock: (e) => e.style.display = "block",
    hide: (e) => e.style.display = "none",
    copyToClipboard: async (text) => {
      try { await navigator.clipboard.writeText(text); return true; }
      catch { return false; }
    }
  };

  const storage = {
    saveRoomCode: () => localStorage.setItem('chatRoomData', JSON.stringify({ roomCode: state.currentRoomCode })),
    loadRoomCode: () => { try { const d = localStorage.getItem('chatRoomData'); return d ? JSON.parse(d) : null; } catch { return null; } },
    savePeerId: (id) => localStorage.setItem('talkrush_peerid', id),
    loadPeerId: () => localStorage.getItem('talkrush_peerid'),
    clearRoomCode: () => { localStorage.removeItem('chatRoomData'); state.currentRoomCode = null; el.prRoomCodeInput.value = ''; },
    clearPeerId: () => { localStorage.removeItem('talkrush_peerid'); state.myId = null; }
  };

  const msg = {
    append: (sender, content, type = 'text') => {
      const div = document.createElement("div");
      div.className = `msg ${sender}`;
      if (type === 'text') {
        div.textContent = content;
      } else {
        const img = document.createElement("img");
        img.src = content;
        img.alt = type;
        div.appendChild(img);
      }
      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = utils.formatTime();
      div.appendChild(time);
      el.chatLog.appendChild(div);
      utils.scrollToBottom();
    },
    system: (text) => {
      msg.clearSystem();
      const div = document.createElement("div");
      div.className = "msg system-msg";
      div.textContent = text;
      el.chatLog.appendChild(div);
      state.currentSystemMessage = div;
      utils.scrollToBottom();
    },
    clearSystem: () => {
      state.currentSystemMessage?.parentNode?.removeChild(state.currentSystemMessage);
      state.currentSystemMessage = null;
    },
    showTyping: () => {
      el.typingIndicator.style.display = "block";
      clearTimeout(state.typingTimeout);
      state.typingTimeout = setTimeout(() => { el.typingIndicator.style.display = "none"; }, 1000);
    }
  };

  const room = {
    create: async () => {
      const code = utils.generateRoomCode();
      el.prRoomCodeDisplay.textContent = code;
      try {
        await set(ref(db, "rooms/" + code), { participants: [state.myId], createdAt: serverTimestamp() });
        state.currentRoomCode = code;
        storage.saveRoomCode();
        msg.system("Room created! Share this code with someone to chat.");
        utils.hide(el.prRoomModal);
        room.setupListener(code);
      } catch {
        msg.system("Error creating room. Please try again.");
      }
    },

    join: async () => {
      const code = el.prRoomCodeInput.value.trim();
      if (code.length !== 5) { room.showError("Room code must be 5 digits"); return; }
      try {
        const snapshot = await new Promise((res, rej) => onValue(ref(db, "rooms/" + code), res, { onlyOnce: true }));
        if (!snapshot.exists()) throw new Error("Room not found");
        const data = snapshot.val();
        if (data.participants?.length >= 2) throw new Error("Room is full");
        state.currentRoomCode = code;
        storage.saveRoomCode();
        await set(ref(db, "rooms/" + code), { ...data, participants: [...(data.participants || []), state.myId] });
        for (const id of (data.participants || [])) {
          if (id !== state.myId) await conn.connectTo(id);
        }
        utils.hide(el.prRoomModal);
      } catch (e) {
        room.showError(e.message === "Room is full" ? "Room is full. Only 2 participants allowed." : "Room not found. Please check the code.");
      }
    },

    setupListener: (code) => {
      onValue(ref(db, "rooms/" + code + "/participants"), (snap) => {
        const participants = snap.val() || [];
        participants.forEach((id) => { if (id !== state.myId && !state.isConnected) conn.connectTo(id); });
      });
    },

    showError: (message) => {
      el.prJoinError.textContent = message;
      utils.showBlock(el.prJoinError);
      setTimeout(() => utils.hide(el.prJoinError), 3000);
    },

    autoRejoin: async () => {
      if (!state.currentRoomCode || !state.myId) { utils.showBlock(el.prRoomModal); return; }
      try {
        const snap = await new Promise((res) => onValue(ref(db, "rooms/" + state.currentRoomCode), res, { onlyOnce: true }));
        if (!snap.exists()) throw new Error("Room no longer exists");
        const data = snap.val();
        const participants = data.participants || [];
        if (!participants.includes(state.myId)) {
          await set(ref(db, "rooms/" + state.currentRoomCode), { ...data, participants: [...participants, state.myId] });
        }
        msg.system("Reconnected to your previous room!");
        for (const id of participants) { if (id !== state.myId) await conn.connectTo(id); }
      } catch {
        storage.clearRoomCode();
        msg.system("Please create or join a new room.");
        utils.showBlock(el.prRoomModal);
      }
    },

    destroy: async () => {
      if (!state.currentRoomCode) return;
      try { await remove(ref(db, "rooms/" + state.currentRoomCode)); } catch {}
      storage.clearRoomCode();
      state.currentRoomCode = null;
    }
  };

  const conn = {
    start: () => {
      msg.clearSystem();
      state.isConnected = false;
      if (state.peer) state.peer.destroy();
      const savedId = storage.loadPeerId();
      state.peer = new Peer(savedId, {
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' }
          ]
        }
      });
      state.peer.on('open', (id) => { state.myId = id; storage.savePeerId(id); room.autoRejoin(); });
      state.peer.on('connection', conn.handleNew);
      state.peer.on('error', (err) => {
        if (err.type === 'unavailable-id') { storage.clearPeerId(); conn.start(); }
        else msg.system("Connection error. Please refresh the page to try again.");
      });
    },

    handleNew: (c) => {
      if (state.isConnected) { c.close(); return; }
      conn.setup(c);
      msg.system("Connected to room participant!");
      el.videoCallBtn.style.display = "flex";
    },

    connectTo: async (peerId) => {
      if (state.isConnected || !state.peer) return;
      const c = state.peer.connect(peerId, { reliable: true });
      c.on('open', () => { conn.setup(c); msg.system("Connected to room participant!"); });
      c.on('error', () => msg.system("Failed to connect to participant"));
    },

    setup: (c) => {
      if (state.myConn) state.myConn.close();
      state.myConn = c;
      state.isConnected = true;
      c.on("data", conn.handleData);
      c.on("close", () => conn.end("Participant disconnected! ðŸ’”"));
      c.on("error", () => conn.end("Connection error"));
    },

    handleData: (data) => {
      if (typeof data === 'string') { msg.append("stranger", data); return; }
      if (!data?.type) return;
      const handlers = {
        'image': () => msg.append("stranger", data.blob, 'image'),
        'gif': () => msg.append("stranger", data.url, 'gif'),
        'typing': () => msg.showTyping(),
        'video-call-request': () => video.handleRequest(),
        'video-call-accepted': () => video.handleAccepted(),
        'video-call-declined': () => video.handleDeclined(),
        'video-call-ended': () => video.handleEnded()
      };
      handlers[data.type]?.();
    },

    end: (message) => {
      msg.system(message);
      if (state.myConn) { state.myConn.close(); state.myConn = null; }
      state.isConnected = false;
      video.end();
      setTimeout(conn.start, 1000);
    },

    send: () => {
      const text = el.msgInput.value.trim();
      if (!text || !state.myConn || !state.isConnected) return;
      state.myConn.send(text);
      msg.append("me", text);
      el.msgInput.value = "";
    },

    sendFile: (file, type) => {
      if (!file || !state.myConn || !state.isConnected) return;
      const reader = new FileReader();
      reader.onload = () => { state.myConn.send({ type, blob: reader.result }); msg.append("me", reader.result, 'image'); };
      reader.readAsDataURL(file);
    }
  };

  const video = {
    start: async () => {
      if (!state.isConnected || !state.myConn) { msg.system("You need to be connected to someone to start a video call"); return; }
      if (state.isVideoCallActive) { msg.system("Video call is already active"); return; }
      if (state.isVideoCallRequestPending) { msg.system("You already have a pending video call request"); return; }
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        state.myConn.send({ type: "video-call-request" });
        state.isVideoCallRequested = true;
        msg.system("Video call request sent. Waiting for response...");
        setTimeout(() => {
          if (!state.isVideoCallActive && state.isVideoCallRequested) {
            msg.system("No response to your video call request");
            video.cleanupLocal();
          }
        }, 30000);
      } catch { msg.system("Could not access camera/microphone. Please check permissions."); }
    },

    handleRequest: () => {
      if (state.isVideoCallActive || state.isVideoCallRequestPending) {
        state.myConn.send({ type: "video-call-declined" }); return;
      }
      state.isVideoCallRequestPending = true;
      const overlay = document.createElement('div');
      overlay.className = 'call-modal-overlay';
      overlay.id = 'callModalOverlay';
      document.body.appendChild(overlay);
      utils.showBlock(el.callRequestModal);
      setTimeout(() => {
        if (el.callRequestModal.style.display !== 'none') {
          video.closeModal();
          if (state.myConn) state.myConn.send({ type: 'video-call-declined' });
          msg.system('Video call request expired.');
        }
      }, 30000);
    },

    closeModal: () => {
      utils.hide(el.callRequestModal);
      document.getElementById('callModalOverlay')?.remove();
      state.isVideoCallRequestPending = false;
    },

    accept: () => {
      video.closeModal();
      state.myConn.send({ type: "video-call-accepted" });
      video.startStream();
    },

    decline: () => {
      video.closeModal();
      state.myConn.send({ type: "video-call-declined" });
      msg.system("Video call declined");
    },

    handleAccepted: () => {
      if (!state.isVideoCallRequested) return;
      state.isVideoCallRequested = false;
      msg.system("Video call accepted! Starting call...");
      video.startStream();
    },

    handleDeclined: () => {
      state.isVideoCallRequested = false;
      msg.system("Video call was declined");
      video.cleanupLocal();
    },

    startStream: async () => {
      try {
        if (!state.localStream) state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        el.localVideo.srcObject = state.localStream;
        const call = state.peer.call(state.myConn.peer, state.localStream);
        call.on('stream', (remoteStream) => {
          el.remoteVideo.srcObject = remoteStream;
          state.isVideoCallActive = true;
          utils.show(el.videoCallContainer);
          msg.system("Video call started!");
        });
        call.on('close', video.end);
        state.peer.on('call', (incomingCall) => {
          incomingCall.answer(state.localStream);
          incomingCall.on('stream', (remoteStream) => {
            el.remoteVideo.srcObject = remoteStream;
            state.isVideoCallActive = true;
            utils.show(el.videoCallContainer);
            msg.system("Video call started!");
          });
        });
      } catch { msg.system("Error starting video call"); }
    },

    end: () => {
      if (state.isVideoCallActive && state.myConn) state.myConn.send({ type: "video-call-ended" });
      video.cleanupAll();
      state.isVideoCallActive = false;
      state.isVideoCallRequested = false;
      state.isVideoCallRequestPending = false;
      utils.hide(el.videoCallContainer);
      msg.system("Video call ended");
    },

    handleEnded: () => { video.end(); msg.system("Stranger ended the video call"); },

    toggleVideo: () => {
      const track = state.localStream?.getVideoTracks()[0];
      if (!track) return;
      track.enabled = !track.enabled;
      el.toggleVideoBtn.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
    },

    toggleAudio: () => {
      const track = state.localStream?.getAudioTracks()[0];
      if (!track) return;
      track.enabled = !track.enabled;
      el.toggleAudioBtn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
    },

    cleanupLocal: () => { state.localStream?.getTracks().forEach(t => t.stop()); state.localStream = null; },
    cleanupAll: () => {
      video.cleanupLocal();
      if (el.remoteVideo.srcObject) { el.remoteVideo.srcObject.getTracks().forEach(t => t.stop()); el.remoteVideo.srcObject = null; }
    }
  };

  const gifs = {
    fetch: async () => {
      try {
        const res = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20`);
        gifs.display((await res.json()).data);
      } catch { msg.system("Failed to load GIFs"); }
    },

    search: async (query) => {
      if (!query.trim()) { gifs.fetch(); return; }
      try {
        const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`);
        gifs.display((await res.json()).data);
      } catch { msg.system("Failed to search GIFs"); }
    },

    display: (data) => {
      el.gifResults.innerHTML = "";
      data.forEach(gif => {
        const url = gif.images.fixed_height.url;
        const img = document.createElement("img");
        img.src = url; img.className = "gif-item"; img.alt = "GIF";
        img.onclick = () => {
          if (state.myConn && state.isConnected) {
            state.myConn.send({ type: "gif", url });
            msg.append("me", url, 'gif');
            utils.hide(el.gifModal);
          }
        };
        el.gifResults.appendChild(img);
      });
    }
  };

  function setupEvents() {
    el.roomBtn.onclick = () => {
      const visible = el.prRoomModal.style.display === "block";
      utils[visible ? 'hide' : 'showBlock'](el.prRoomModal);
      if (!visible && state.currentRoomCode) el.prRoomCodeInput.value = state.currentRoomCode;
    };

    el.prCreateRoomBtn.onclick = room.create;
    el.prJoinRoomBtn.onclick = room.join;

    el.prShareRoom.onclick = async () => {
      if (!state.currentRoomCode) { msg.system("Create or join a room first to share"); return; }
      const shareData = {
        title: 'TalkRush Private Chat Room',
        text: `Join my private chat room on TalkRush! Use room code: ${state.currentRoomCode}`,
        url: `${window.location.href.split('?')[0]}?room=${state.currentRoomCode}`
      };
      try {
        if (navigator.share) { await navigator.share(shareData); msg.system("Sharing options opened!"); }
        else if (await utils.copyToClipboard(shareData.url)) msg.system("Room link copied to clipboard!");
      } catch (e) {
        if (e.name !== 'AbortError' && await utils.copyToClipboard(shareData.url)) msg.system("Room link copied to clipboard!");
      }
    };

    el.msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") conn.send(); });
    el.msgInput.addEventListener("input", () => { if (state.myConn && state.isConnected) state.myConn.send({ type: "typing" }); });
    el.sendBtn.onclick = conn.send;

    el.imgInput.addEventListener("change", (e) => { const f = e.target.files[0]; if (f) conn.sendFile(f, "image"); e.target.value = ""; });

    el.skipBtn.onclick = async () => {
      if (state.myConn) state.myConn.close();
      state.isConnected = false;
      video.end();
      await room.destroy();
      msg.system("Finding someone new...");
      setTimeout(() => { el.chatLog.innerHTML = ""; conn.start(); }, 1000);
    };

    el.videoCallBtn.onclick = video.start;
    el.acceptCallBtn.onclick = video.accept;
    el.declineCallBtn.onclick = video.decline;
    el.endCallBtn.onclick = video.end;
    el.toggleVideoBtn.onclick = video.toggleVideo;
    el.toggleAudioBtn.onclick = video.toggleAudio;

    el.gifBtn.onclick = (e) => {
      e.preventDefault();
      const visible = el.gifModal.style.display === "block";
      utils[visible ? 'hide' : 'showBlock'](el.gifModal);
      if (!visible) gifs.fetch();
    };

    el.gifSearch.addEventListener("keypress", (e) => { if (e.key === "Enter") gifs.search(el.gifSearch.value); });

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      if (!state.escPressedOnce) {
        state.escPressedOnce = true;
        msg.system("Press Esc again to skip this chat and find someone new");
        state.escTimer = setTimeout(() => { state.escPressedOnce = false; msg.clearSystem(); }, 3000);
      } else {
        clearTimeout(state.escTimer);
        state.escPressedOnce = false;
        el.skipBtn.click();
      }
    });

    window.addEventListener("click", (e) => {
      if (e.target === el.gifModal) utils.hide(el.gifModal);
      if (e.target.id === 'callModalOverlay') { video.closeModal(); if (state.myConn) state.myConn.send({ type: 'video-call-declined' }); msg.system('Video call declined.'); }
    });
    window.addEventListener('beforeunload', (e) => {
      if (state.isConnected) { e.preventDefault(); e.returnValue = 'Are you sure you want to leave? Your chat will be disconnected.'; }
    });
  }

  window.addEventListener('load', async () => {
    await loadKeys();
    const savedRoom = storage.loadRoomCode();
    if (savedRoom) { state.currentRoomCode = savedRoom.roomCode; if (state.currentRoomCode) el.prRoomCodeInput.value = state.currentRoomCode; }
    const savedPeer = storage.loadPeerId();
    if (savedPeer) state.myId = savedPeer;
    setupEvents();
    conn.start();
    const urlParams = new URLSearchParams(window.location.search);
    const roomFromUrl = urlParams.get('room');
    if (roomFromUrl) {
      el.prRoomCodeInput.value = roomFromUrl;
      setTimeout(() => { if (!state.isConnected) el.prJoinRoomBtn.click(); }, 1000);
    }
  });
</script>
