---
layout: default
title: "Private Room Chat"
description: "Create a secure 2-person private chat room. Share a code, enjoy safe text or video chat, and have private conversations anytime, anywhere."
---

<style>
:root {
    /* Dark Theme Colors */
    --dark-bg: #121212;
    --dark-header-bg: #181818;
    --dark-header-border: #2a2a2a;
    --dark-chat-bg: #1e1e1e;
    --dark-text: #fff;
    --dark-secondary-text: #aaa;
    --dark-input-bg: #333;
    --dark-input-focus: #444;
    --dark-icon-color: #ccc;
    --dark-icon-hover-bg: rgba(255,255,255,0.1);
    --dark-scroll-thumb: #444;
    --dark-scroll-hover: #555;
    --dark-btn-primary: #007bff;
    --dark-btn-primary-hover: #0056b3;
    --dark-btn-secondary: #6c757d;
    --dark-btn-secondary-hover: #545b62;

    /* Light Theme Colors */
    --light-bg: #f5f5f5;
    --light-header-bg: #ffffff;
    --light-header-border: #e0e0e0;
    --light-chat-bg: #f9f9f9;
    --light-msg-bg: #e9e9e9;
    --light-text: #333;
    --light-secondary-text: #666;
    --light-input-bg: #e0e0e0;
    --light-input-focus: #d0d0d0;
    --light-icon-color: #666;
    --light-icon-hover-bg: rgba(0,0,0,0.05);
    --light-scroll-thumb: #ccc;
    --light-scroll-hover: #aaa;
    --light-btn-primary: #007bff;
    --light-btn-primary-hover: #0056b3;
    --light-btn-secondary: #6c757d;
    --light-btn-secondary-hover: #545b62;

    /* Common Colors */
    --skip-btn: #ff4d4d;
    --skip-btn-hover: #ff3333;
    --room-btn: #25D366;
    --success: #28a745;
    --error: #dc3545;
}

* {
    box-sizing: border-box;
}

html, body {
    overflow-x: hidden;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--dark-bg);
    color: var(--dark-text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: background 0.3s, color 0.3s;
}

body.light-mode {
    background: var(--light-bg);
    color: var(--light-text);
}

.app-header {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px;
    background: var(--dark-header-bg);
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    border-bottom: 1px solid var(--dark-header-border);
    z-index: 10000;
}

.light-mode .app-header {
    background: var(--light-header-bg);
    border-bottom: 1px solid var(--light-header-border);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo {
    height: 40px;
    width: 40px;
    border-radius: 10px;
}

.app-title {
    font-size: 1em;
    color: var(--dark-text);
    margin: 0;
}

.light-mode .app-title {
    color: var(--light-text);
}

.room-btn {
    background: var(--room-btn);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9em;
    transition: background 0.2s;
}
    
.theme-toggle {
    background: none;
    border: none;
    color: var(--dark-icon-color);
    font-size: 1.1em;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.theme-toggle:hover {
    background: var(--dark-icon-hover-bg);
}

.light-mode .theme-toggle {
    color: var(--light-icon-color);
}

.light-mode .theme-toggle:hover {
    background: var(--light-icon-hover-bg);
}

.chat-container {
    display: flex;
    flex-direction: column;
    position: relative;
    padding: 50px 0 0 0; 
}

#chatLog {
  padding: 12px;
  overflow-y: auto;
  background: var(--dark-chat-bg);
  display: flex;
  flex-direction: column;
}

.light-mode #chatLog {
    background: var(--light-chat-bg);
}

.msg {
  margin: 5px 0;
  padding: 5px 8px;
  background: var(--light-msg-bg);
  color: var(--light-text);
  border: 1px solid var(--dark-secondary-text);
  border-radius: 15px;
  max-width: 80%;
  word-wrap: break-word;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.me { 
    align-self: flex-end;
    border-bottom-right-radius: 5px;
}

.stranger { 
    align-self: flex-start;
    border-bottom-left-radius: 5px;
}

.timestamp {
    font-size: 0.7em;
    color: var(--dark-secondary-text);
    text-align: right;
}

.chat-controls {
    position: fixed;
    bottom: 0;
    display: flex;
    align-items: center;
    padding: 5px;
    background: var(--dark-header-bg);
    width: 100%;
    z-index: 1000;
    gap: 8px;
}

.light-mode .chat-controls {
    background: var(--light-header-bg);
}

#skipBtn {
    background: var(--skip-btn);
    border: none;
    padding: 12px;
    border-radius: 25px;
    color: white;
    cursor: pointer;
    font-size: 1em;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

#skipBtn:hover {
    background: var(--skip-btn-hover);
}

.input-area {
    flex: 1;
    position: relative;
}

#msgInput {
    width: 100%;
    padding: 12px 80px 12px 15px;
    border-radius: 25px;
    border: none;
    background: var(--dark-input-bg);
    color: var(--dark-text);
    font-size: 1em;
    outline: none;
}

#msgInput:focus {
    background: var(--dark-input-focus);
}

.light-mode #msgInput {
    background: var(--light-input-bg);
    color: var(--light-text);
}

.light-mode #msgInput:focus {
    background: var(--light-input-focus);
}

.input-icons {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
}

.icon-btn {
    background: none;
    border: none;
    color: var(--dark-icon-color);
    font-size: 1.1em;
    cursor: pointer;
    transition: color 0.2s;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.icon-btn:hover { 
    color: var(--dark-text);
    background: var(--dark-icon-hover-bg);
}

.light-mode .icon-btn {
    color: var(--light-icon-color);
}

.light-mode .icon-btn:hover { 
    color: var(--light-text);
    background: var(--light-icon-hover-bg);
}

#imgInput, #gifInput { display: none; }

/* Message images */
.msg img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-bottom: 5px;
}

/* System messages */
.system-msg {
    align-self: center;
    background: transparent;
    color: var(--dark-secondary-text);
    text-align: center;
    padding: 5px 0;
    font-size: 0.9em;
}

.light-mode .system-msg {
    color: var(--light-secondary-text);
}

/* Scrollbar styling */
#chatLog::-webkit-scrollbar {
    width: 8px;
}

#chatLog::-webkit-scrollbar-track {
    background: var(--dark-chat-bg);
}

#chatLog::-webkit-scrollbar-thumb {
    background: var(--dark-scroll-thumb);
    border-radius: 4px;
}

#chatLog::-webkit-scrollbar-thumb:hover {
    background: var(--dark-scroll-hover);
}

.light-mode #chatLog::-webkit-scrollbar-track {
    background: var(--light-chat-bg);
}

.light-mode #chatLog::-webkit-scrollbar-thumb {
    background: var(--light-scroll-thumb);
}

.light-mode #chatLog::-webkit-scrollbar-thumb:hover {
    background: var(--light-scroll-hover);
}

/* GIF search modal */
.gif-modal {
    display: none;
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 300px;
    max-height: 400px;
    background: var(--dark-msg-bg);
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 1001;
    padding: 15px;
    overflow: hidden;
}

.light-mode .gif-modal {
    background: var(--light-msg-bg);
}

.gif-search {
    width: 100%;
    padding: 8px 12px;
    border-radius: 20px;
    border: none;
    background: var(--dark-input-bg);
    color: var(--dark-text);
    margin-bottom: 10px;
}

.light-mode .gif-search {
    background: var(--light-input-bg);
    color: var(--light-text);
}

.gif-results {
    height: 300px;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.gif-item {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.gif-item:hover {
    transform: scale(1.05);
}

#typingIndicator {
    position: absolute;
    bottom: 0;
    left: 12px;
    font-style: italic;
    color: var(--dark-secondary-text);
    display: none;
    pointer-events: none;
}

.light-mode #typingIndicator {
    color: var(--light-secondary-text);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    padding-top: 60px;
    background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
    position: relative;
    background-color: var(--dark-msg-bg);
    color: var(--dark-text);
    margin: 15% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.light-mode .modal-content {
    background-color: var(--light-msg-bg);
    color: var(--light-text);
}

.modal-title {
    margin-top: 0;
    margin-bottom: 20px;
    text-align: center;
}

.room-code-display {
    text-align: center;
    font-size: 2em;
    font-weight: bold;
    letter-spacing: 5px;
    margin: 20px 0;
    padding: 10px;
    background: rgba(0,0,0,0.1);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-text);
}

.light-mode .room-code-display {
    background: rgba(0,0,0,0.05);
    color: var(--light-text);
}

.code-input {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.code-input input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 1.2em;
    text-align: center;
    letter-spacing: 5px;
    max-width: calc(100% - 100px);
    box-sizing: border-box;
    color: var(--dark-text);
    background: var(--dark-input-bg);
}

.light-mode .code-input input {
    background: white;
    color: black;
}

#joinRoomBtn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
    background-color: var(--dark-btn-primary);
    color: white;
    white-space: nowrap;
    width: 90px;
    flex-shrink: 0;
}

#joinRoomBtn:hover {
    background-color: var(--dark-btn-primary-hover);
}

.light-mode #joinRoomBtn {
    background-color: var(--light-btn-primary);
}

.light-mode #joinRoomBtn:hover {
    background-color: var(--light-btn-primary-hover);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
}

.btn-primary {
    background-color: var(--dark-btn-primary);
    color: white;
}

.btn-primary:hover {
    background-color: var(--dark-btn-primary-hover);
}

.btn-secondary {
    background-color: var(--dark-btn-secondary);
    color: white;
}

.btn-secondary:hover {
    background-color: var(--dark-btn-secondary-hover);
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.error-message {
    color: var(--error);
    text-align: center;
    margin-top: 10px;
    display: none;
}

.success-message {
    color: var(--success);
    text-align: center;
    margin-top: 10px;
    display: none;
}

.copy-btn {
    background: none;
    border: none;
    color: var(--dark-icon-color);
    cursor: pointer;
    font-size: 1em;
    margin-left: 10px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.copy-btn:hover {
    color: var(--dark-text);
    background: var(--dark-icon-hover-bg);
}

.light-mode .copy-btn {
    color: var(--light-icon-color);
}

.light-mode .copy-btn:hover {
    color: var(--light-text);
    background: var(--light-icon-hover-bg);
}

/* Input placeholder color */
#msgInput::placeholder {
    color: var(--dark-secondary-text);
}

.light-mode #msgInput::placeholder {
    color: var(--light-secondary-text);
}

.gif-search::placeholder {
    color: var(--dark-secondary-text);
}

.light-mode .gif-search::placeholder {
    color: var(--light-secondary-text);
}

/* Loading Screen */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark-bg);
    color: var(--dark-text);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s;
}

.light-mode .loading-screen {
    background: var(--light-bg);
    color: var(--light-text);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--dark-btn-primary);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
}

.light-mode .loading-spinner {
    border: 5px solid rgba(0, 0, 0, 0.1);
    border-top-color: var(--light-btn-primary);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.2em;
    text-align: center;
}

/* Video Call Styles */
.video-call-container {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10002;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.video-controls {
    position: absolute;
    bottom: 20px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 15px;
    z-index: 10003;
}

.video-control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 1.2em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.video-control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.video-control-btn.end-call {
    background: #ff4d4d;
}

.video-control-btn.end-call:hover {
    background: #ff3333;
}

.video-grid {
    display: flex;
    width: 90%;
    max-width: 1200px;
    height: 70%;
    gap: 10px;
}

.video-container {
    flex: 1;
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
}

.video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1) !important;
}

.video-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9em;
}

.call-request-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
}

.call-request-content {
    background: var(--dark-msg-bg);
    color: var(--dark-text);
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.light-mode .call-request-content {
    background: var(--light-msg-bg);
    color: var(--light-text);
}

.call-request-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.call-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s;
}

.call-btn.accept {
    background: #25D366;
    color: white;
}

.call-btn.accept:hover {
    background: #1da851;
}

.call-btn.decline {
    background: #ff4d4d;
    color: white;
}

.call-btn.decline:hover {
    background: #ff3333;
}

.video-call-btn {
    background: none;
    border: none;
    color: var(--dark-icon-color);
    font-size: 1.1em;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.video-call-btn:hover {
    color: var(--dark-text);
    background: var(--dark-icon-hover-bg);
}

.light-mode .video-call-btn {
    color: var(--light-icon-color);
}

.light-mode .video-call-btn:hover {
    color: var(--light-text);
    background: var(--light-icon-hover-bg);
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .msg {
        max-width: 85%;
    }
    
    #skipBtn {
        padding: 15px;
        font-size: 0.9em;
    }
    
    .gif-modal {
        width: 90%;
        left: 5%;
        right: 5%;
    }

    .header-right {
        gap: 5px;
    }

    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .room-btn span {
        display: none;
    }
    
    .room-btn {
        padding: 8px;
    }
    
    .code-input {
        flex-direction: column;
        gap: 10px;
    }
    
    .code-input input {
        max-width: 100%;
        width: 100%;
    }
    
    #joinRoomBtn {
        width: 100%;
    }
    
    .copy-btn {
        width: 22px;
        height: 22px;
        font-size: 0.9em;
    }
    
    /* Video call responsive */
    .video-grid {
        flex-direction: column;
        height: 80%;
    }
    
    .video-container {
        flex: 1;
    }
    
    .video-controls {
        bottom: 10px;
    }
    
    .video-control-btn {
        width: 45px;
        height: 45px;
    }
}
</style>

<!-- Loading Screen -->
<div id="loadingScreen" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Initializing chat...</div>
</div>

<!-- Room Code Modal -->
<div id="roomModal" class="modal">
    <div class="modal-content">
     <h2 class="modal-title">Private Chat Room</h2>
        <div id="createRoomSection">
            <p>Create a new private room and share the code with someone:</p>
            <div class="room-code-display">
                <span id="roomCodeDisplay">-----</span>
                <button class="copy-btn" id="copyRoomCode" title="Copy code">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="copy-btn" id="shareRoom" title="Share Room Link">
                     <i class="fas fa-link"></i>
                </button>      
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="createRoomBtn">Create Room</button>
            </div>
        </div>
        
        <div id="joinRoomSection" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
            <p>Join an existing room with a code:</p>
            <div class="code-input">
                <input type="text" id="roomCodeInput" maxlength="5" placeholder="12345">
                <button class="btn btn-primary" id="joinRoomBtn">Join</button>
            </div>
            <div id="joinError" class="error-message">Invalid room code</div>
        </div>
    </div>
</div>

<!-- Video Call Request Modal -->
<div id="callRequestModal" class="call-request-modal">
    <div class="call-request-content">
        <h2>Incoming Video Call</h2>
        <p>Stranger wants to start a video call with you</p>
        <div class="call-request-buttons">
            <button class="call-btn accept" id="acceptCallBtn">
                <i class="fas fa-phone"></i> Accept
            </button>
            <button class="call-btn decline" id="declineCallBtn">
                <i class="fas fa-phone-slash"></i> Decline
            </button>
        </div>
    </div>
</div>

<!-- Video Call Container -->
<div id="videoCallContainer" class="video-call-container">
    <div class="video-grid">
        <div class="video-container">
            <video id="localVideo" autoplay muted></video>
            <div class="video-label">You</div>
        </div>
        <div class="video-container">
            <video id="remoteVideo" autoplay></video>
            <div class="video-label">Stranger</div>
        </div>
    </div>
    <div class="video-controls">
        <button class="video-control-btn" id="toggleVideoBtn" title="Toggle Video">
            <i class="fas fa-video"></i>
        </button>
        <button class="video-control-btn" id="toggleAudioBtn" title="Toggle Audio">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="video-control-btn end-call" id="endCallBtn" title="End Call">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>
</div>

<div class="chat-container">
    <header class="app-header">
<div class="header-left">
    <button class="menu-btn" onclick="toggleMenu()">&#9776;</button>
    <img src="logo.png" alt="TalkRush Logo" class="logo">
      <h1 class="app-title">TalkRush Room</h1>
     </div>
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Mode">
                <i class="fas fa-moon"></i>
            </button>
            <button class="video-call-btn" id="videoCallBtn" title="Start Video Call">
                <i class="fas fa-video"></i>
            </button>
            <button id="roomBtn" class="room-btn">
                <i class="fas fa-door-closed"></i>
                <span>Room</span>
            </button>
        </div>
    </header>

    <div id="chatLog"></div>
    <div id="typingIndicator">Stranger is typing...</div>
    
    <div class="chat-controls">
        <button id="skipBtn"><i class="fas fa-random"></i></button>
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Type your message..." />
            <div class="input-icons">
                <label for="imgInput" class="icon-btn" title="Send Image"><i class="fas fa-image"></i></label>
                <label for="gifInput" class="icon-btn" title="Send GIF"><i class="fas fa-film"></i></label>
                <button id="sendBtn" class="icon-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <input type="file" id="imgInput" accept="image/*" />
    <input type="file" id="gifInput" accept="image/gif" />
    
    <!-- GIF Search Modal -->
    <div class="gif-modal" id="gifModal">
        <input type="text" class="gif-search" id="gifSearch" placeholder="Search GIFs..." />
        <div class="gif-results" id="gifResults"></div>
    </div>
</div>

<!-- Display Ads -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7059052735946479"
       data-ad-slot="8592327962"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

{% include scripts.html %}
{% include menu.html %}

<script>
const firebaseConfig = {
    databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const GIPHY_API_KEY = 'EKvv5S1CcXqYuHgxPNVKiNuiuNHRTzFk';

const state = {
    peer: null,
    myConn: null,
    myId: null,
    currentSystemMessage: null,
    isConnected: false,
    escPressedOnce: false,
    escTimer: null,
    currentRoomCode: null,
    typingTimeout: null,
    localStream: null,
    remoteStream: null,
    isVideoCallActive: false,
    isVideoCallRequested: false,
    isVideoCallRequestPending: false
};

const elements = {
    loadingScreen: document.getElementById("loadingScreen"),
    loadingText: document.getElementById("loadingText"),
    roomModal: document.getElementById("roomModal"),
    roomCodeDisplay: document.getElementById("roomCodeDisplay"),
    roomCodeInput: document.getElementById("roomCodeInput"),
    createRoomBtn: document.getElementById("createRoomBtn"),
    joinRoomBtn: document.getElementById("joinRoomBtn"),
    copyRoomCodeBtn: document.getElementById("copyRoomCode"),
    joinError: document.getElementById("joinError"),
    roomBtn: document.getElementById("roomBtn"),
    videoCallBtn: document.getElementById("videoCallBtn"),
    callRequestModal: document.getElementById("callRequestModal"),
    acceptCallBtn: document.getElementById("acceptCallBtn"),
    declineCallBtn: document.getElementById("declineCallBtn"),
    videoCallContainer: document.getElementById("videoCallContainer"),
    localVideo: document.getElementById("localVideo"),
    remoteVideo: document.getElementById("remoteVideo"),
    toggleVideoBtn: document.getElementById("toggleVideoBtn"),
    toggleAudioBtn: document.getElementById("toggleAudioBtn"),
    endCallBtn: document.getElementById("endCallBtn"),
    chatLog: document.getElementById("chatLog"),
    msgInput: document.getElementById("msgInput"),
    sendBtn: document.getElementById("sendBtn"),
    imgInput: document.getElementById("imgInput"),
    gifInput: document.getElementById("gifInput"),
    skipBtn: document.getElementById("skipBtn"),
    typingIndicator: document.getElementById("typingIndicator"),
    gifModal: document.getElementById("gifModal"),
    gifSearch: document.getElementById("gifSearch"),
    gifResults: document.getElementById("gifResults"),
    gifBtn: document.querySelector('[for="gifInput"]'),
    shareRoom: document.getElementById("shareRoom")
};

const utils = {
    generateRoomCode: () => Math.floor(10000 + Math.random() * 90000).toString(),
    scrollToBottom: () => elements.chatLog.scrollTop = elements.chatLog.scrollHeight,
    formatTime: () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    show: (element) => element.style.display = "flex",
    showBlock: (element) => element.style.display = "block",
    hide: (element) => element.style.display = "none",
    copyToClipboard: async (text) => {
        try {
            await navigator.clipboard.writeText(text);
            return true;
        } catch (error) {
            console.error('Failed to copy:', error);
            return false;
        }
    }
};

const storage = {
    save: () => {
        const roomData = { roomCode: state.currentRoomCode };
        localStorage.setItem('chatRoomData', JSON.stringify(roomData));
    },
    load: () => {
        try {
            const savedData = localStorage.getItem('chatRoomData');
            if (!savedData) return null;
            
            const data = JSON.parse(savedData);
            return data;
        } catch (error) {
            console.error('Error loading from storage:', error);
            return null;
        }
    },
    clear: () => {
        localStorage.removeItem('chatRoomData');
        state.currentRoomCode = null;
        elements.roomCodeInput.value = '';
    }
};

const messageHandler = {
    appendMessage: (sender, content, type = 'text') => {
        const div = document.createElement("div");
        div.className = `msg ${sender}`;
        
        if (type === 'text') div.textContent = content;
        else if (type === 'image' || type === 'gif') {
            const img = document.createElement("img");
            img.src = content;
            img.alt = type === 'gif' ? 'GIF' : 'Image';
            div.appendChild(img);
        }
        
        const time = document.createElement("div");
        time.className = "timestamp";
        time.textContent = utils.formatTime();
        div.appendChild(time);
        
        elements.chatLog.appendChild(div);
        utils.scrollToBottom();
    },
    logSystem: (msg) => {
        messageHandler.clearSystemMessage();
        const div = document.createElement("div");
        div.className = "msg system-msg";
        div.textContent = msg;
        elements.chatLog.appendChild(div);
        state.currentSystemMessage = div;
        utils.scrollToBottom();
    },
    clearSystemMessage: () => {
        if (state.currentSystemMessage?.parentNode) {
            state.currentSystemMessage.parentNode.removeChild(state.currentSystemMessage);
        }
        state.currentSystemMessage = null;
    },
    showTypingIndicator: () => {
        elements.typingIndicator.style.display = "block";
        clearTimeout(state.typingTimeout);
        state.typingTimeout = setTimeout(() => {
            elements.typingIndicator.style.display = "none";
        }, 1000);
    }
};

const roomManager = {
    createRoom: async () => {
        const code = utils.generateRoomCode();
        elements.roomCodeDisplay.textContent = code;
        utils.show(elements.loadingScreen);
        elements.loadingText.textContent = "Creating room...";
        
        try {
            const participants = {};
            participants[state.myId] = "active";
            
            await db.ref("rooms/" + code).set({
                participants: participants,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            state.currentRoomCode = code;
            storage.save();
            
            messageHandler.logSystem(`Room created with code: ${code}. Share this code with someone to chat.`);
            utils.hide(elements.roomModal);
            utils.hide(elements.loadingScreen);
            roomManager.setupParticipantListener(code);
            
        } catch (error) {
            console.error("Error creating room:", error);
            utils.hide(elements.loadingScreen);
            messageHandler.logSystem("Error creating room. Please try again.");
        }
    },
    joinRoom: async () => {
        const code = elements.roomCodeInput.value.trim();
        if (code.length !== 5) {
            roomManager.showJoinError("Room code must be 5 digits");
            return;
        }
        
        utils.show(elements.loadingScreen);
        elements.loadingText.textContent = "Joining room...";
        
        try {
            const snapshot = await db.ref("rooms/" + code).once('value');
            if (!snapshot.exists()) throw new Error("Room not found");
            
            const roomData = snapshot.val();
            if (roomData.participants && Object.keys(roomData.participants).length >= 2) {
                throw new Error("Room is full");
            }
            
            state.currentRoomCode = code;
            storage.save();
            
            await db.ref("rooms/" + code + "/participants").update({ [state.myId]: "active" });
            
            const participants = Object.keys(roomData.participants || {});
            for (const participantId of participants) {
                if (participantId !== state.myId) await connectionManager.connectToPeer(participantId);
            }
            
            utils.hide(elements.roomModal);
            utils.hide(elements.loadingScreen);
            
        } catch (error) {
            console.error("Error joining room:", error);
            utils.hide(elements.loadingScreen);
            roomManager.showJoinError(
                error.message === "Room is full" 
                    ? "Room is full. Only 2 participants allowed."
                    : "Room not found. Please check the code."
            );
        }
    },
    setupParticipantListener: (roomCode) => {
        const ref = db.ref("rooms/" + roomCode + "/participants");
        ref.on("child_added", (snapshot) => {
            if (snapshot.key !== state.myId && snapshot.val() === "active") {
                connectionManager.connectToPeer(snapshot.key);
            }
        });
        ref.on("child_removed", (snapshot) => {
            if (snapshot.key !== state.myId) messageHandler.logSystem("Participant left the room");
        });
    },
    showJoinError: (message) => {
        elements.joinError.textContent = message;
        utils.showBlock(elements.joinError);
        setTimeout(() => utils.hide(elements.joinError), 3000);
    },
    autoRejoinRoom: async () => {
        if (!state.currentRoomCode || !state.myId) {
            utils.hide(elements.loadingScreen);
            utils.showBlock(elements.roomModal);
            return;
        }
        
        utils.show(elements.loadingScreen);
        elements.loadingText.textContent = "Reconnecting to room...";
        
        try {
            const snapshot = await db.ref("rooms/" + state.currentRoomCode).once('value');
            if (!snapshot.exists()) throw new Error("Room no longer exists");
            
            const roomData = snapshot.val();
            const participants = Object.keys(roomData.participants || {});
            
            if (!participants.includes(state.myId)) {
                await db.ref("rooms/" + state.currentRoomCode + "/participants").update({ [state.myId]: "active" });
            }
            
            messageHandler.logSystem(`Reconnected to room: ${state.currentRoomCode}`);
            
            for (const participantId of participants) {
                if (participantId !== state.myId) await connectionManager.connectToPeer(participantId);
            }
            
            utils.hide(elements.loadingScreen);
            
        } catch (error) {
            console.error("Error rejoining room:", error);
            utils.hide(elements.loadingScreen);
            storage.clear();
            messageHandler.logSystem("Room no longer exists. Please create or join a new room.");
            utils.showBlock(elements.roomModal);
        }
    },
    destroyRoom: async () => {
        if (state.currentRoomCode) {
            try {
                await db.ref("rooms/" + state.currentRoomCode + "/participants/" + state.myId).remove();
                const snapshot = await db.ref("rooms/" + state.currentRoomCode + "/participants").once('value');
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    await db.ref("rooms/" + state.currentRoomCode).remove();
                }
            } catch (error) {
                console.error("Error leaving room:", error);
            }
        }
        storage.clear();
    }
};

const connectionManager = {
    startPeer: () => {
        messageHandler.clearSystemMessage();
        state.isConnected = false;
        if (state.peer) state.peer.destroy();
        
        // Pehle se saved peer ID ka use nahi karenge
        // Naya peer ID hamesha generate hoga
        state.peer = new Peer(null, { // null pass karenge taaki naya ID generate ho
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            }
        });

        state.peer.on('open', (id) => {
            state.myId = id;
            storage.save(); // sirf room code save hoga
            utils.hide(elements.loadingScreen);
            roomManager.autoRejoinRoom();
        });

        state.peer.on('connection', connectionManager.handleNewConnection);
        state.peer.on('error', connectionManager.handlePeerError);
    },
    handlePeerError: (err) => {
        console.error('PeerJS error:', err);
        if (err.type === 'unavailable-id') {
            console.log('Peer ID unavailable, generating new one...');
            connectionManager.startPeer(); // Naya peer start karenge
        } else {
            utils.hide(elements.loadingScreen);
            messageHandler.logSystem("Connection error. Please refresh the page to try again.");
        }
    },
    handleNewConnection: (conn) => {
        if (state.isConnected) {
            conn.close();
            return;
        }
        connectionManager.setupConnection(conn);
        messageHandler.logSystem("Connected to room participant!");
    },
    connectToPeer: async (peerId) => {
        if (state.isConnected) return;
        const conn = state.peer.connect(peerId, { reliable: true });
        conn.on('open', () => {
            connectionManager.setupConnection(conn);
            messageHandler.logSystem("Connected to room participant!");
        });
        conn.on('error', (err) => {
            console.error("Connection error:", err);
            messageHandler.logSystem("Failed to connect to participant");
        });
    },
    setupConnection: (conn) => {
        if (state.myConn) state.myConn.close();
        state.myConn = conn;
        state.isConnected = true;

        conn.on("data", connectionManager.handleData);
        conn.on("close", () => connectionManager.endConnection("Participant disconnected! ðŸ’”"));
        conn.on("error", (err) => {
            console.error("Data connection error:", err);
            connectionManager.endConnection("Connection error");
        });
    },
    handleData: (data) => {
        const handlers = {
            string: () => messageHandler.appendMessage("stranger", data),
            image: () => messageHandler.appendMessage("stranger", data.blob, 'image'),
            gif: () => messageHandler.appendMessage("stranger", data.url, 'gif'),
            typing: () => messageHandler.showTypingIndicator(),
            'video-call-request': () => videoCallManager.handleVideoCallRequest(),
            'video-call-accepted': () => videoCallManager.handleVideoCallAccepted(),
            'video-call-declined': () => videoCallManager.handleVideoCallDeclined(),
            'video-call-ended': () => videoCallManager.handleVideoCallEnded()
        };

        const handler = typeof data === 'string' ? handlers.string : handlers[data.type];
        handler?.();
    },
    endConnection: (message) => {
        messageHandler.logSystem(message);
        state.myConn = null;
        state.isConnected = false;
        videoCallManager.endVideoCall();
        if (state.currentRoomCode) {
            db.ref("rooms/" + state.currentRoomCode + "/participants/" + state.myId).remove();
        }
        setTimeout(connectionManager.startPeer, 1000);
    },
    sendMessage: () => {
        const msg = elements.msgInput.value.trim();
        if (!msg || !state.myConn || !state.isConnected) return;
        state.myConn.send(msg);
        messageHandler.appendMessage("me", msg);
        elements.msgInput.value = "";
    },
    sendFile: (file, type) => {
        if (!file || !state.myConn || !state.isConnected) return;
        const reader = new FileReader();
        reader.onload = () => {
            state.myConn.send({ type, blob: reader.result });
            messageHandler.appendMessage("me", reader.result, 'image');
        };
        reader.readAsDataURL(file);
    }
};

const videoCallManager = {
    startVideoCall: async () => {
        if (!state.isConnected || !state.myConn) {
            messageHandler.logSystem("You need to be connected to someone to start a video call");
            return;
        }
        if (state.isVideoCallActive) {
            messageHandler.logSystem("Video call is already active");
            return;
        }
        if (state.isVideoCallRequestPending) {
            messageHandler.logSystem("You already have a pending video call request");
            return;
        }
        
        try {
            state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            state.myConn.send({ type: "video-call-request" });
            state.isVideoCallRequested = true;
            messageHandler.logSystem("Video call request sent. Waiting for response...");
            
            setTimeout(() => {
                if (!state.isVideoCallActive && state.isVideoCallRequested) {
                    messageHandler.logSystem("No response to your video call request");
                    videoCallManager.cleanupLocalStream();
                }
            }, 30000);
            
        } catch (error) {
            console.error("Error accessing camera/microphone:", error);
            messageHandler.logSystem("Could not access camera/microphone. Please check permissions.");
        }
    },
    handleVideoCallRequest: () => {
        if (state.isVideoCallActive || state.isVideoCallRequestPending) {
            state.myConn.send({ type: "video-call-declined" });
            return;
        }
        state.isVideoCallRequestPending = true;
        utils.show(elements.callRequestModal);
    },
    acceptVideoCall: () => {
        utils.hide(elements.callRequestModal);
        state.isVideoCallRequestPending = false;
        state.myConn.send({ type: "video-call-accepted" });
        videoCallManager.startVideoCallStream();
    },
    declineVideoCall: () => {
        utils.hide(elements.callRequestModal);
        state.isVideoCallRequestPending = false;
        state.myConn.send({ type: "video-call-declined" });
        messageHandler.logSystem("Video call declined");
    },
    handleVideoCallAccepted: () => {
        if (!state.isVideoCallRequested) return;
        state.isVideoCallRequested = false;
        messageHandler.logSystem("Video call accepted! Starting call...");
        videoCallManager.startVideoCallStream();
    },
    handleVideoCallDeclined: () => {
        state.isVideoCallRequested = false;
        messageHandler.logSystem("Video call was declined");
        videoCallManager.cleanupLocalStream();
    },
    startVideoCallStream: async () => {
        try {
            if (!state.localStream) {
                state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            }
            elements.localVideo.srcObject = state.localStream;
            
            const call = state.peer.call(state.myConn.peer, state.localStream);
            call.on('stream', (remoteStream) => {
                elements.remoteVideo.srcObject = remoteStream;
                state.isVideoCallActive = true;
                utils.show(elements.videoCallContainer);
                messageHandler.logSystem("Video call started!");
            });
            call.on('close', videoCallManager.endVideoCall);
            
            state.peer.on('call', (incomingCall) => {
                incomingCall.answer(state.localStream);
                incomingCall.on('stream', (remoteStream) => {
                    elements.remoteVideo.srcObject = remoteStream;
                    state.isVideoCallActive = true;
                    utils.show(elements.videoCallContainer);
                    messageHandler.logSystem("Video call started!");
                });
            });
            
        } catch (error) {
            console.error("Error starting video call:", error);
            messageHandler.logSystem("Error starting video call");
        }
    },
    endVideoCall: () => {
        if (state.isVideoCallActive && state.myConn) {
            state.myConn.send({ type: "video-call-ended" });
        }
        videoCallManager.cleanupStreams();
        state.isVideoCallActive = false;
        state.isVideoCallRequested = false;
        state.isVideoCallRequestPending = false;
        utils.hide(elements.videoCallContainer);
        messageHandler.logSystem("Video call ended");
    },
    handleVideoCallEnded: () => {
        videoCallManager.endVideoCall();
        messageHandler.logSystem("Stranger ended the video call");
    },
    toggleVideo: () => {
        if (!state.localStream) return;
        const videoTrack = state.localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            elements.toggleVideoBtn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        }
    },
    toggleAudio: () => {
        if (!state.localStream) return;
        const audioTrack = state.localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            elements.toggleAudioBtn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        }
    },
    cleanupLocalStream: () => {
        if (state.localStream) {
            state.localStream.getTracks().forEach(track => track.stop());
            state.localStream = null;
        }
    },
    cleanupStreams: () => {
        videoCallManager.cleanupLocalStream();
        if (elements.remoteVideo.srcObject) {
            elements.remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            elements.remoteVideo.srcObject = null;
        }
    }
};

const gifManager = {
    fetchTrendingGifs: async () => {
        try {
            const response = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20`);
            const data = await response.json();
            gifManager.displayGifs(data.data);
        } catch (error) {
            console.error("Error fetching GIFs:", error);
            messageHandler.logSystem("Failed to load GIFs");
        }
    },
    searchGifs: async (query) => {
        if (!query.trim()) {
            gifManager.fetchTrendingGifs();
            return;
        }
        try {
            const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20`);
            const data = await response.json();
            gifManager.displayGifs(data.data);
        } catch (error) {
            console.error("Error searching GIFs:", error);
            messageHandler.logSystem("Failed to search GIFs");
        }
    },
    displayGifs: (gifs) => {
        elements.gifResults.innerHTML = "";
        gifs.forEach(gif => {
            const gifUrl = gif.images.fixed_height.url;
            const img = document.createElement("img");
            img.src = gifUrl;
            img.className = "gif-item";
            img.alt = "GIF";
            img.onclick = () => {
                if (state.myConn && state.isConnected) {
                    state.myConn.send({ type: "gif", url: gifUrl });
                    messageHandler.appendMessage("me", gifUrl, 'gif');
                    utils.hide(elements.gifModal);
                }
            };
            elements.gifResults.appendChild(img);
        });
    }
};

const eventHandlers = {
    setupEventListeners: () => {
        elements.roomBtn.onclick = () => {
            const isVisible = elements.roomModal.style.display === "block";
            utils[isVisible ? 'hide' : 'showBlock'](elements.roomModal);
            if (!isVisible && state.currentRoomCode) {
                elements.roomCodeInput.value = state.currentRoomCode;
            }
        };
        elements.createRoomBtn.onclick = roomManager.createRoom;
        elements.joinRoomBtn.onclick = roomManager.joinRoom;
        elements.copyRoomCodeBtn.onclick = async () => {
            const code = elements.roomCodeDisplay.textContent;
            if (code !== "-----" && await utils.copyToClipboard(code)) {
                const originalHtml = elements.copyRoomCodeBtn.innerHTML;
                elements.copyRoomCodeBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => { elements.copyRoomCodeBtn.innerHTML = originalHtml; }, 2000);
            }
        };
        elements.msgInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") connectionManager.sendMessage();
        });
        elements.msgInput.addEventListener("input", () => {
            if (state.myConn && state.isConnected) state.myConn.send({ type: "typing" });
        });
        elements.sendBtn.onclick = connectionManager.sendMessage;
        elements.imgInput.addEventListener("change", (e) => {
            connectionManager.sendFile(e.target.files[0], "image");
            e.target.value = "";
        });
        elements.gifInput.addEventListener("change", (e) => {
            connectionManager.sendFile(e.target.files[0], "image");
            e.target.value = "";
        });
        elements.skipBtn.onclick = eventHandlers.skipChat;
        elements.videoCallBtn.onclick = videoCallManager.startVideoCall;
        elements.acceptCallBtn.onclick = videoCallManager.acceptVideoCall;
        elements.declineCallBtn.onclick = videoCallManager.declineVideoCall;
        elements.endCallBtn.onclick = videoCallManager.endVideoCall;
        elements.toggleVideoBtn.onclick = videoCallManager.toggleVideo;
        elements.toggleAudioBtn.onclick = videoCallManager.toggleAudio;
        elements.gifBtn.onclick = (e) => {
            e.preventDefault();
            const isVisible = elements.gifModal.style.display === "block";
            utils[isVisible ? 'hide' : 'showBlock'](elements.gifModal);
            if (!isVisible) gifManager.fetchTrendingGifs();
        };
        elements.gifSearch.addEventListener("keypress", (e) => {
            if (e.key === "Enter") gifManager.searchGifs(elements.gifSearch.value);
        });
        elements.shareRoom.onclick = async () => {
            if (state.currentRoomCode) {
                const url = `${window.location.href.split('?')[0]}?room=${state.currentRoomCode}`;
                if (await utils.copyToClipboard(url)) {
                    messageHandler.logSystem("Room link copied to clipboard!");
                }
            } else {
                messageHandler.logSystem("Create or join a room first to share");
            }
        };
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!state.escPressedOnce) {
                    state.escPressedOnce = true;
                    messageHandler.logSystem("Press Esc again to skip this chat and find someone new");
                    state.escTimer = setTimeout(() => {
                        state.escPressedOnce = false;
                        messageHandler.clearSystemMessage();
                    }, 3000);
                } else {
                    clearTimeout(state.escTimer);
                    state.escPressedOnce = false;
                    eventHandlers.skipChat();
                }
            }
        });
        window.addEventListener("click", (e) => {
            if (e.target === elements.gifModal) utils.hide(elements.gifModal);
        });
        window.addEventListener('beforeunload', (e) => {
            if (state.isConnected) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your chat will be disconnected.';
            }
        });
    },
    skipChat: () => {
        if (state.myConn) state.myConn.close();
        state.isConnected = false;
        roomManager.destroyRoom();
        messageHandler.logSystem("Room destroyed. Creating a new connection...");
        setTimeout(() => {
            elements.chatLog.innerHTML = "";
            connectionManager.startPeer();
        }, 1000);
    },
    handleUrlRoomCode: () => {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCodeFromUrl = urlParams.get('room');
        if (roomCodeFromUrl) {
            elements.roomCodeInput.value = roomCodeFromUrl;
            setTimeout(() => {
                if (!state.isConnected) elements.joinRoomBtn.click();
            }, 1000);
        }
    }
};

const init = () => {
    const savedData = storage.load();
    if (savedData) {
        state.currentRoomCode = savedData.roomCode;
        if (state.currentRoomCode) elements.roomCodeInput.value = state.currentRoomCode;
    }
    // state.myId ko yahan set nahi karenge, wo peer.js se generate hoga
    eventHandlers.setupEventListeners();
    connectionManager.startPeer();
    eventHandlers.handleUrlRoomCode();
};

window.addEventListener('load', init);
</script>
