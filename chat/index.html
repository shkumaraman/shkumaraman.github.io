<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stranger Chat</title>

  <!-- Bootstrap (latest) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PeerJS (latest) -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1/dist/peerjs.min.js"></script>

  <style>
    #messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #f8f9fa;
    }
  </style>
</head>
<body class="container py-4">

  <h2 class="text-center mb-4">Chat with a Stranger</h2>
  <div id="status" class="mb-2 text-center text-secondary">Connecting...</div>

  <div id="messages" class="rounded"></div>
  <input id="messageInput" class="form-control" placeholder="Type a message and press Enter..." disabled />

  <script>
    const peer = new Peer(); // auto-generated ID using PeerJS Cloud
    let conn = null;
    let allPeers = [];
    let isConnected = false;

    const messages = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const status = document.getElementById("status");

    // Store peers in window so we can match later
    const PEER_CACHE = [];

    peer.on("open", (id) => {
      console.log("My ID:", id);
      addStatus("Looking for strangers...");
      window.myPeerId = id;

      // Simulate global peer list using PeerJS cloud events (no real list, so workaround)
      peer.listAllPeers((peers) => {
        allPeers = peers.filter(pid => pid !== id);
        if (allPeers.length > 0) {
          const randomPeerId = allPeers[Math.floor(Math.random() * allPeers.length)];
          conn = peer.connect(randomPeerId);
          setupConnection();
        } else {
          addStatus("Waiting for someone to connect...");
        }
      });
    });

    peer.on("connection", (incoming) => {
      if (isConnected) return;
      conn = incoming;
      setupConnection();
    });

    function setupConnection() {
      conn.on("open", () => {
        isConnected = true;
        addStatus("Connected to stranger.");
        input.disabled = false;

        conn.on("data", (data) => {
          addMessage("Stranger: " + data);
        });

        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && conn.open) {
            const msg = input.value.trim();
            if (msg) {
              conn.send(msg);
              addMessage("You: " + msg);
              input.value = "";
            }
          }
        });
      });

      conn.on("close", () => {
        addStatus("Stranger disconnected.");
        input.disabled = true;
      });
    }

    function addMessage(msg) {
      const p = document.createElement("p");
      p.textContent = msg;
      messages.appendChild(p);
      messages.scrollTop = messages.scrollHeight;
    }

    function addStatus(msg) {
      status.textContent = msg;
    }
  </script>
</body>
</html>
