<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stranger Chat</title>

  <!-- Bootstrap (latest) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- PeerJS (latest) -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1/dist/peerjs.min.js"></script>

  <style>
    :root {
      --primary-color: #6366f1;
      --secondary-color: #f8fafc;
      --dark-color: #1e293b;
      --light-color: #f1f5f9;
      --danger-color: #ef4444;
      --success-color: #10b981;
    }
    
    body {
      background-color: #f8fafc;
      color: #1e293b;
    }
    
    .chat-container {
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      overflow: hidden;
    }
    
    #messages {
      height: 400px;
      overflow-y: auto;
      padding: 1.5rem;
      background-color: white;
      scrollbar-width: thin;
    }
    
    #messages::-webkit-scrollbar {
      width: 6px;
    }
    
    #messages::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    #messages::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 20px;
    }
    
    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      border-radius: 1rem;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }
    
    .message.sent {
      background-color: var(--primary-color);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.received {
      background-color: var(--light-color);
      color: var(--dark-color);
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
    
    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      display: block;
      margin-top: 0.25rem;
      text-align: right;
    }
    
    .input-area {
      background-color: white;
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
    }
    
    .btn-voice {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .status-badge {
      background-color: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
    }
    
    .status-badge i {
      margin-right: 0.3rem;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #64748b;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      color: var(--primary-color);
    }
    
    .ad-container {
      background-color: #e2e8f0;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
      border-radius: 8px;
    }
    
    .ad-placeholder {
      color: #64748b;
      font-size: 0.9rem;
    }
    
    .media-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    
    .skip-btn {
      background-color: var(--danger-color);
      color: white;
    }
    
    .skip-btn:hover {
      background-color: #dc2626;
      color: white;
    }
    
    .typing-indicator {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: var(--light-color);
      border-radius: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #94a3b8;
      margin-right: 4px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
      margin-right: 0;
    }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
  </style>
</head>
<body class="py-4">
  <div class="container">
    <!-- Ad Slot -->
    <div class="ad-container mb-4">
      <div class="ad-placeholder">
        <i class="fas fa-ad me-2"></i>Advertisement
        <div class="mt-2">Your Ad Could Be Here</div>
      </div>
    </div>
    
    <div class="chat-container">
      <div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-random me-2"></i>Stranger Chat</h5>
        <div id="status" class="status-badge">
          <i class="fas fa-circle-notch fa-spin"></i>
          <span>Connecting...</span>
        </div>
      </div>
      
      <div id="messages"></div>
      
      <div class="input-area">
        <div id="mediaPreview" class="d-none text-center"></div>
        <div class="d-flex align-items-center gap-2">
          <button id="imageBtn" class="action-btn" title="Send Image">
            <i class="fas fa-image"></i>
          </button>
          <button id="voiceBtn" class="btn btn-primary btn-voice" title="Voice Message">
            <i class="fas fa-microphone"></i>
          </button>
          <input id="messageInput" class="form-control flex-grow-1" placeholder="Type a message..." disabled />
          <button id="sendBtn" class="action-btn" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
          <button id="skipBtn" class="btn skip-btn ms-2">
            <i class="fas fa-forward me-1"></i> Skip
          </button>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" class="d-none" />

  <script>
    // Configuration with STUN servers
    const peer = new Peer({
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' }
        ]
      }
    });
    
    let conn = null;
    let allPeers = [];
    let isConnected = false;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let typingTimer;
    let isTyping = false;

    const messages = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const status = document.getElementById("status");
    const sendBtn = document.getElementById("sendBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const imageBtn = document.getElementById("imageBtn");
    const fileInput = document.getElementById("fileInput");
    const mediaPreview = document.getElementById("mediaPreview");
    const skipBtn = document.getElementById("skipBtn");

    // Store peers in window so we can match later
    const PEER_CACHE = [];

    peer.on("open", (id) => {
      console.log("My ID:", id);
      updateStatus("Looking for strangers...", "info");
      window.myPeerId = id;

      // Simulate global peer list using PeerJS cloud events (no real list, so workaround)
      peer.listAllPeers((peers) => {
        allPeers = peers.filter(pid => pid !== id);
        if (allPeers.length > 0) {
          const randomPeerId = allPeers[Math.floor(Math.random() * allPeers.length)];
          conn = peer.connect(randomPeerId);
          setupConnection();
        } else {
          updateStatus("Waiting for someone to connect...", "info");
        }
      });
    });

    peer.on("connection", (incoming) => {
      if (isConnected) return;
      conn = incoming;
      setupConnection();
    });

    peer.on("error", (err) => {
      console.error("PeerJS error:", err);
      updateStatus("Connection error. Try refreshing.", "danger");
    });

    function setupConnection() {
      conn.on("open", () => {
        isConnected = true;
        updateStatus("Connected to stranger", "success");
        input.disabled = false;
        sendBtn.disabled = false;
        
        // Show typing indicator when data is about to be received
        conn.on("data", (data) => {
          if (data.type === 'typing') {
            showTypingIndicator();
            return;
          }
          
          if (data.type === 'message') {
            addMessage(data.text, 'received');
          } else if (data.type === 'image') {
            addImageMessage(data.url, 'received');
          } else if (data.type === 'audio') {
            addAudioMessage(data.url, 'received');
          }
        });

        // Input event listeners
        input.addEventListener("input", handleTyping);
        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
        
        sendBtn.addEventListener("click", sendMessage);
      });

      conn.on("close", () => {
        updateStatus("Stranger disconnected", "danger");
        input.disabled = true;
        sendBtn.disabled = true;
        isConnected = false;
        setTimeout(() => {
          if (!isConnected) {
            updateStatus("Reconnecting...", "info");
            peer.reconnect();
          }
        }, 2000);
      });
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (msg && conn.open) {
        conn.send({ type: 'message', text: msg });
        addMessage(msg, 'sent');
        input.value = "";
      }
    }

    function handleTyping() {
      if (!isTyping && input.value.length > 0) {
        isTyping = true;
        conn.send({ type: 'typing' });
      }
      
      // Reset typing status after a delay
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        isTyping = false;
      }, 2000);
    }

    function showTypingIndicator() {
      const existingIndicator = document.querySelector('.typing-indicator');
      if (existingIndicator) {
        clearTimeout(typingTimer);
        existingIndicator.remove();
      }
      
      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator received';
      indicator.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;
      messages.appendChild(indicator);
      messages.scrollTop = messages.scrollHeight;
      
      // Remove after 3 seconds if no message comes
      typingTimer = setTimeout(() => {
        indicator.remove();
      }, 3000);
    }

    function addMessage(msg, type) {
      const existingIndicator = document.querySelector('.typing-indicator');
      if (existingIndicator) existingIndicator.remove();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageDiv.innerHTML = `
        ${msg}
        <span class="message-time">${time}</span>
      `;
      
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function addImageMessage(url, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageDiv.innerHTML = `
        <img src="${url}" class="media-preview" alt="Sent image">
        <span class="message-time">${time}</span>
      `;
      
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function addAudioMessage(url, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      messageDiv.innerHTML = `
        <audio controls class="mt-1">
          <source src="${url}" type="audio/wav">
          Your browser does not support the audio element.
        </audio>
        <span class="message-time">${time}</span>
      `;
      
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function updateStatus(msg, type) {
      const icon = type === 'success' ? 'fa-check-circle' : 
                  type === 'danger' ? 'fa-times-circle' : 
                  type === 'info' ? 'fa-info-circle' : 'fa-circle-notch fa-spin';
      
      status.innerHTML = `
        <i class="fas ${icon} me-2"></i>
        <span>${msg}</span>
      `;
      
      status.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 
                                   type === 'danger' ? 'var(--danger-color)' : 
                                   'var(--primary-color)';
    }

    // Voice message functionality
    voiceBtn.addEventListener("mousedown", startRecording);
    voiceBtn.addEventListener("mouseup", stopRecording);
    voiceBtn.addEventListener("touchstart", startRecording);
    voiceBtn.addEventListener("touchend", stopRecording);
    
    function startRecording(e) {
      e.preventDefault();
      if (isRecording || !isConnected) return;
      
      audioChunks = [];
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          isRecording = true;
          voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
          voiceBtn.style.backgroundColor = 'var(--danger-color)';
          
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };
          
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            if (conn.open) {
              conn.send({ type: 'audio', url: audioUrl });
              addAudioMessage(audioUrl, 'sent');
            }
          };
          
          mediaRecorder.start();
        })
        .catch(err => {
          console.error("Error accessing microphone:", err);
          updateStatus("Microphone access denied", "danger");
        });
    }
    
    function stopRecording(e) {
      e.preventDefault();
      if (!isRecording) return;
      
      isRecording = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceBtn.style.backgroundColor = '';
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
    }

    // Image sharing functionality
    imageBtn.addEventListener("click", () => {
      if (!isConnected) return;
      fileInput.click();
    });
    
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.match('image.*')) {
        updateStatus("Only images are allowed", "danger");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const imgUrl = event.target.result;
        
        if (conn.open) {
          conn.send({ type: 'image', url: imgUrl });
          addImageMessage(imgUrl, 'sent');
        }
      };
      reader.readAsDataURL(file);
      fileInput.value = "";
    });

    // Skip functionality
    skipBtn.addEventListener("click", () => {
      if (conn) {
        conn.close();
      }
      
      updateStatus("Looking for new stranger...", "info");
      input.disabled = true;
      sendBtn.disabled = true;
      isConnected = false;
      
      peer.reconnect();
    });
  </script>
</body>
</html>
