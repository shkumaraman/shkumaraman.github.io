<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stranger Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chatLog {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #1e1e1e;
      border-bottom: 1px solid #333;
    }
    .msg {
      margin: 10px 0;
      padding: 10px;
      background: #2b2b2b;
      border-radius: 10px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .me { align-self: flex-end; background: #007bff; }
    .stranger { align-self: flex-start; }
    .timestamp {
      font-size: 0.7em;
      color: #aaa;
      margin-top: 5px;
    }

    .chat-controls {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #181818;
    }
    #skipBtn {
      margin-right: 10px;
      background: #ff4d4d;
      border: none;
      padding: 10px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    .input-area {
      flex: 1;
      position: relative;
    }
    #msgInput {
      width: 100%;
      padding: 10px 80px 10px 10px;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
    }
    .input-icons {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 10px;
    }
    .icon-btn {
      background: none;
      border: none;
      color: #ccc;
      font-size: 1.2em;
      cursor: pointer;
    }
    .icon-btn:hover { color: #fff; }
    #imgInput { display: none; }
  </style>
</head>
<body>

  <div id="chatLog"></div>

  <div class="chat-controls">
    <button id="skipBtn"><i class="fas fa-random"></i> Skip</button>
    
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type your message..." />
      <div class="input-icons">
        <label for="imgInput" class="icon-btn"><i class="fas fa-image"></i></label>
        <button id="sendBtn" class="icon-btn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
  <input type="file" id="imgInput" accept="image/*" />

  <!-- Scripts -->
  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let peer, myConn, myId, waitingRef;

    startPeer();

    function startPeer() {
      peer = new Peer();
      peer.on('open', (id) => {
        myId = id;
        tryToFindMatch();
      });
    }

    function tryToFindMatch() {
      waitingRef = db.ref("waiting");
      waitingRef.once('value', (snapshot) => {
        const list = snapshot.val();
        if (list) {
          for (let [key, otherId] of Object.entries(list)) {
            if (otherId !== myId) {
              db.ref("waiting/" + key).remove();
              connectToPeer(otherId);
              return;
            }
          }
        }
        // No match found, add self
        const newRef = waitingRef.push();
        newRef.set(myId);
        peer.on("connection", (conn) => {
          logSystem("Stranger connected");
          setupConnection(conn);
        });
      });
    }

    function connectToPeer(otherId) {
      const conn = peer.connect(otherId);
      conn.on("open", () => {
        logSystem("Connected to stranger");
        setupConnection(conn);
      });
    }

    function setupConnection(conn) {
      if (myConn) myConn.close();
      myConn = conn;
      conn.on("data", (data) => {
        if (typeof data === "string") {
          appendMessage("stranger", data);
        } else if (data.type === "image") {
          appendImage("stranger", data.blob);
        }
      });
      conn.on("close", () => {
        logSystem("Stranger disconnected");
      });
    }

    function appendMessage(sender, msg) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      div.textContent = msg;
      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = new Date().toLocaleTimeString();
      div.appendChild(time);
      document.getElementById("chatLog").appendChild(div);
      scrollToBottom();
    }

    function appendImage(sender, blob) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      const img = document.createElement("img");
      img.src = blob;
      img.style.maxWidth = "200px";
      img.style.borderRadius = "8px";
      div.appendChild(img);
      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = new Date().toLocaleTimeString();
      div.appendChild(time);
      document.getElementById("chatLog").appendChild(div);
      scrollToBottom();
    }

    function scrollToBottom() {
      const log = document.getElementById("chatLog");
      log.scrollTop = log.scrollHeight;
    }

    function logSystem(msg) {
      const div = document.createElement("div");
      div.className = "msg";
      div.style.fontStyle = "italic";
      div.textContent = msg;
      document.getElementById("chatLog").appendChild(div);
      scrollToBottom();
    }

    document.getElementById("sendBtn").onclick = () => {
      const input = document.getElementById("msgInput");
      const msg = input.value.trim();
      if (msg && myConn) {
        myConn.send(msg);
        appendMessage("me", msg);
        input.value = "";
      }
    };

    document.getElementById("imgInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file || !myConn) return;

      const reader = new FileReader();
      reader.onload = () => {
        myConn.send({ type: "image", blob: reader.result });
        appendImage("me", reader.result);
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("skipBtn").onclick = () => {
      if (myConn) myConn.close();
      peer.destroy();
      document.getElementById("chatLog").innerHTML = "";
      startPeer();
    };
  </script>
</body>
</html>
