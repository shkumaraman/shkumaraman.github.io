<script>
// scripts.html additions

// Global peer instance
window.peerInstance = null;

// Initialize peer once for all pages
function initializePeerOnce() {
  if (window.peerInstance) {
    console.log('Peer already initialized');
    return;
  }

  const existingPeerId = localStorage.getItem('talkrush_peerid');
  if (!existingPeerId) {
    console.log('No peer ID found, user needs to start from homepage');
    return;
  }

  try {
    window.peerInstance = new Peer(existingPeerId, {
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
          { urls: 'stun:stun3.l.google.com:19302' },
          { urls: 'stun:stun4.l.google.com:19302' }
        ]
      }
    });

    window.peerInstance.on('open', (id) => {
      console.log('Global Peer initialized with ID:', id);
    });

    window.peerInstance.on('error', (err) => {
      console.error('Global PeerJS error:', err);
    });
  } catch (error) {
    console.error('Failed to initialize Peer:', error);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializePeerOnce);

// Clean up on page unload
window.addEventListener('beforeunload', () => {
  if (window.peerInstance) {
    window.peerInstance.destroy();
    window.peerInstance = null;
  }
  
  // Call page-specific cleanup if exists
  if (typeof window.cleanupMessagesPage === 'function') {
    window.cleanupMessagesPage();
  }
});
</script>
