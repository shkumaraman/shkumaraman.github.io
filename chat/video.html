<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TalkRush - Video Chat With Strangers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="TalkRush - Video chat with strangers like on Ome TV & Omegle. No signup required. Make new friends instantly for free.">
  <meta name="keywords" content="TalkRush, free video chat, video chat with strangers, random video chat, online video chat, chat rooms, random chat stranger, free online chat, omegle alternative, ometv alternative, EmeraldChat alternative, chatroulette alternative, chat with strangers, talk to strangers, talk with strangers, random chat, stranger chat, anonymous chat, no registration, girls chat">
  <link rel="icon" type="image/png" href="logo.png">
  <meta property="og:image" content="https://shkumaraman.github.io/chat/logo.png">
  <meta property="og:title" content="TalkRush - Video Chat With Strangers">
  <meta property="og:description" content="TalkRush - Free random video chat with strangers. No signup needed. Make new friends instantly.">
  <meta property="og:type" content="website">
  <link rel="canonical" href="https://shkumaraman.github.io/chat/video.html" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7059052735946479" crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-746R2BN26S"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-746R2BN26S');
  </script>  
  <style>
  :root {
    /* Dark Theme Colors */
    --dark-bg: #121212;
    --dark-header-bg: #181818;
    --dark-header-border: #2a2a2a;
    --dark-text: #fff;
    --dark-icon-color: #ccc;
    --dark-icon-hover: #fff;
    --dark-icon-hover-bg: rgba(255,255,255,0.1);
    --dark-system-msg: #aaa;

    /* Light Theme Colors */
    --light-bg: #f5f5f5;
    --light-header-bg: #ffffff;
    --light-header-border: #e0e0e0;
    --light-text: #333;
    --light-icon-color: #666;
    --light-icon-hover: #333;
    --light-icon-hover-bg: rgba(0,0,0,0.05);
    --light-system-msg: #777;

    /* Common Colors */
    --skip-btn: #ff4d4d;
    --skip-btn-hover: #ff3333;
    --share-btn: #25D366;
    --share-btn-hover: #128C7E;
    --keyword-bubble: #f1f1f1;
    --keyword-border: #ccc;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    overflow-x: hidden;
    height: 100%;
    margin: 0;
    padding: 0;
  }
    
  body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--dark-bg);
    color: var(--dark-text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: background 0.3s, color 0.3s;
  }

  body.light-mode {
    background: var(--light-bg);
    color: var(--light-text);
  }

  .app-header {
    position: sticky;
    top: 0;
    width: 100%;
    height: 50px;
    background: var(--dark-header-bg);
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    border-bottom: 1px solid var(--dark-header-border);
    z-index: 10000;
  }

  .light-mode .app-header {
    background: var(--light-header-bg);
    border-bottom: 1px solid var(--light-header-border);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo {
    height: 40px;
    width: 40px;
    border-radius: 10px;
  }

  .app-title {
    font-size: 1.1em;
    color: var(--dark-text);
    margin: 0;
  }

  .light-mode .app-title {
    color: var(--light-text);
  }

  .share-btn {
    background: var(--share-btn);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9em;
    transition: background 0.2s;
  }

  .share-btn:hover {
    background: var(--share-btn-hover);
  }

  .theme-toggle {
    background: none;
    border: none;
    color: var(--dark-icon-color);
    font-size: 1.1em;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
  }

 .new-chat-btn {
  background: linear-gradient(135deg, #6e8efb, #a777e3);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 30px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}

.new-chat-btn:hover {
  background: linear-gradient(135deg, #5b7cf9, #9b65e0);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  transform: translateX(-50%) scale(1.05);
}

.new-chat-btn:active {
  transform: translateX(-50%) scale(0.98);
}

  .theme-toggle:hover {
    background: var(--dark-icon-hover-bg);
  }

  .light-mode .theme-toggle {
    color: var(--light-icon-color);
  }

  .light-mode .theme-toggle:hover {
    background: var(--light-icon-hover-bg);
  }

  .video-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    position: relative;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
    padding: 0 10px;
  }

  .remote-video-container {
    position: relative;
    width: 100%;
    height: 70vh;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 2px;
  }

  .local-video-container {
    position: relative;
    width: 100%;
    height: 30vh;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #333;
    color: white;
    font-size: 1.2em;
  }

  .light-mode .video-placeholder {
    background: #e0e0e0;
    color: #333;
  }

  .video-controls {
    position: fixed;
    bottom: 0;
    right: 0;
    display: flex;
    align-items: center;
    padding: 15px;
    z-index: 1000;
  }

  #skipBtn {
    background: var(--skip-btn);
    border: none;
    padding: 12px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    font-size: 1em;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }

  #skipBtn:hover {
    background: var(--skip-btn-hover);
  }

  .system-msg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    text-align: center;
    z-index: 100;
  }

  .light-mode .system-msg {
    background: rgba(255,255,255,0.8);
    color: #333;
  }

 .keyword-bubble {
  background-color: var(--keyword-bubble);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  color: var(--light-text);
  border: 1px solid var(--keyword-border);
  transition: background 0.3s;
  }

  #userCount {
  position: fixed;
  top: 70px;
  right: 15px;
  background: var(--dark-msg-bg);
  color: var(--dark-text);
  border-radius: 20px;
  padding: 4px 8px;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 0.95em;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  z-index: 999;
  transition: background 0.3s, color 0.3s;
}

.light-mode #userCount {
  background: var(--light-msg-bg);
  color: var(--light-text);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
    
  /* Responsive adjustments */
  @media (max-width: 600px) {
    .remote-video-container {
      height: 60vh;
    }
    
    .local-video-container {
      height: 25vh;
    }
    
    .share-btn span {
      display: none;
    }
    
    .share-btn {
      padding: 8px;
    }

    .header-right {
      gap: 5px;
    }
  }

  .footer {
    text-align: center;
    padding: 15px;
    color: #777;
    font-size: 0.9em;
  }
  </style>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "Is TalkRush video chat really free?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, TalkRush video chat is 100% free to use with no signup or hidden charges."
        }
      },
      {
        "@type": "Question",
        "name": "Can I video chat anonymously without login?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Absolutely! TalkRush doesn't require any login or registration to start video chatting."
        }
      },
      {
        "@type": "Question",
        "name": "Is this a good Omegle video chat alternative?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, TalkRush is one of the best Omegle alternatives for random video chatting with strangers."
        }
      }
    ]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "TalkRush Video Chat",
    "url": "https://shkumaraman.github.io/chat/",
    "description": "Free random video chat with strangers without registration",
    "applicationCategory": "CommunicationApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>
  <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "TalkRush Video Chat",
  "url": "https://shkumaraman.github.io/chat/video.html",
  "description": "Use TalkRush to start live video calls with strangers instantly. No signup, girls chat, no download — just free, browser-based one-on-one or group video chat. Talk anonymously, make new friends, and enjoy private, secure face-to-face conversations with people around the world."
}
  </script>
  
</head>
<body>
 <header class="app-header">
    <div class="header-left">
      <img src="logo.png" alt="TalkRush Logo" class="logo">
      <h1 class="app-title">TalkRush Video Chat</h1>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Mode">
        <i class="fas fa-moon"></i>
      </button>
      <button class="share-btn" onclick="window.open('https://wa.me/?text=Try%20this%20free%20video%20chat:%20https://shkumaraman.github.io/chat/video.html', '_blank')">
        <i class="fab fa-whatsapp"></i>
        <span>Share</span>
      </button>
    </div>
  </header>

  <div class="video-container">
    <div class="remote-video-container">
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="video-placeholder" id="remotePlaceholder">Connecting you with someone interesting...</div>
    </div>
    
    <div class="local-video-container">
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="video-placeholder" id="localPlaceholder">Preparing your camera...</div>
    </div>
    
    <div class="system-msg" id="systemMsg" style="display: none;"></div>
  </div>

  <div class="video-controls">
    <button id="newChatBtn" class="new-chat-btn" style="display: none;">New Connection</button>
    <button id="skipBtn" title="Find someone new"><i class="fas fa-random"></i></button>
  </div>

<div id="userCount">96,276+</div>

<script>
  const base = 96276;
  let current = base;

  setInterval(() => {
    const change = Math.floor(Math.random() * 7) - 3;
    current += change;

    if (current > base + 100) current = base + 100;
    if (current < base - 100) current = base - 100;

    document.getElementById("userCount").innerText = current.toLocaleString() + "+";
  }, 1500);
</script>
  
  <div style="width:95%; max-width:700px; margin:20px auto; text-align:center;">
  <h3 style="font-size:22px; margin-bottom:20px;">Start Meeting People</h3>

  <div style="display:flex; justify-content:space-between; gap:20px; flex-wrap:wrap;">
    <a href="index.html" style="flex:1; min-width:130px; padding:12px 0; background-color:#FFA500; color:#333; border:none; border-radius:25px; font-size:16px; font-weight:bold; text-decoration:none; text-align:center;">
      Private Chat
    </a>

    <a href="group.html" style="flex:1; min-width:130px; padding:12px 0; background-color:#00C853; color:#fff; border:none; border-radius:25px; font-size:16px; font-weight:bold; text-decoration:none; text-align:center;">
      Group Session
    </a>
  </div>
</div>

  <!-- Display Ads -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7059052735946479"
       data-ad-slot="8592327962"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  
  <main class="info-section" style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <h2>TalkRush - Real-Time Video Conversations</h2>
    <p>Experience <strong>TalkRush's innovative service</strong> – connecting you face-to-face with fascinating individuals worldwide. Our solution offers:</p>
    <ul>
      <li><strong>Immediate video interactions</strong> completely free</li>
      <li><strong>No accounts needed</strong> – start in seconds</li>
      <li><strong>Secure encrypted streams</strong> protecting your privacy</li>
      <li><strong>Worldwide community</strong> of diverse participants</li>
      <li><strong>Device-friendly design</strong> for all screens</li>
      <li>Perfect for <strong>cultural discovery and making connections</strong></li>
    </ul>
    
    <h2>How Our Service Works</h2>
    <p>Enable your camera when prompted to begin. If the connection isn't right, simply select "Next" to meet someone new immediately.</p>
    
    <h2>Why Choose Our Solution?</h2>
    <p><strong>TalkRush</strong> stands apart because we provide:</p>
    <ul>
      <li><strong>Total anonymity</strong> guaranteed</li>
      <li><strong>Lightning-fast matching</strong> technology</li>
      <li><strong>Global participant network</strong></li>
      <li>Press <kbd>Esc</kbd> for instant new pairing</li>
      <li>Universal compatibility with <strong>all devices</strong></li>
    </ul>
  </main>

  <!-- Display Ads -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7059052735946479"
       data-ad-slot="8592327962"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
    
  <section class="faq container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <h2 class="mb-4 text-center">Frequently Asked Questions</h2>

        <div class="accordion" id="faqAccordion">

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                Is there any cost to use this?
              </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                Our service is 100% free with no premium features or hidden charges.
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                Do I need to create an account?
              </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                No registration or personal information is required to start connecting.
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                How does this differ from other services?
              </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                We offer superior connection quality and a more intuitive interface than similar offerings.
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingFour">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                What security measures are implemented?
              </button>
            </h2>
            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                We prioritize your safety through:
                <ul>
                  <li>Advanced stream encryption</li>
                  <li>No recording of sessions</li>
                  <li>Quick reporting options</li>
                  <li>Complete anonymity</li>
                </ul>
                Always practice caution in online interactions.
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

    <!-- Display Ads -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-7059052735946479"
       data-ad-slot="8592327962"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  
  <div id="comprehensive-keywords" style="padding: 20px; max-width: 800px; margin: 20px auto 0 auto; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
    <span class="keyword-bubble">live visual meetings</span>
    <span class="keyword-bubble">spontaneous webcam chats</span>
    <span class="keyword-bubble">global meetup service</span>
    <span class="keyword-bubble">face-to-face online</span>
    <span class="keyword-bubble">instant connections</span>
    <span class="keyword-bubble">anonymous interactions</span>
    <span class="keyword-bubble">no login required</span>
    <span class="keyword-bubble">secure streaming</span>
    <span class="keyword-bubble">real-time conversations</span>
    <span class="keyword-bubble">cultural exchange</span>
    <span class="keyword-bubble">mobile-friendly design</span>
    <span class="keyword-bubble">personal meetings</span>
    <span class="keyword-bubble">alternative to omegle</span>
    <span class="keyword-bubble">immediate pairing</span>
    <span class="keyword-bubble">camera-based chatting</span>
    <span class="keyword-bubble">worldwide community</span>
    <span class="keyword-bubble">friendship building</span>
    <span class="keyword-bubble">web-based meetings</span>
    <span class="keyword-bubble">talk to women</span>
    <span class="keyword-bubble">online gatherings</span>
    <span class="keyword-bubble">cross-border connections</span>
    <span class="keyword-bubble">talk to female</span>
    <span class="keyword-bubble">instant talk</span>
    <span class="keyword-bubble">account-free access</span>
    <span class="keyword-bubble">privacy-focused design</span>
    <span class="keyword-bubble">protected streaming</span>
    <span class="keyword-bubble">global participant base</span>
    <span class="keyword-bubble">international community</span>
    <span class="keyword-bubble">camera communication</span>
    <span class="keyword-bubble">online face meetings</span>
    <span class="keyword-bubble">stranger chat</span>
    <span class="keyword-bubble">secure conversations</span>
    <span class="keyword-bubble">anonymous meetings</span>
    <span class="keyword-bubble">global networking</span>
    <span class="keyword-bubble">real-time face chat</span>
    <span class="keyword-bubble">international meetups</span>
    <span class="keyword-bubble">webcam socializing</span>
    <span class="keyword-bubble">online networking</span>
    <span class="keyword-bubble">cross-border video</span>
    <span class="keyword-bubble">authentic meetings</span>
    <span class="keyword-bubble">chat with strangers</span>
    <span class="keyword-bubble">no signup needed</span>
    <span class="keyword-bubble">privacy-first approach</span>
    <span class="keyword-bubble">girls video chat</span>
  </div>

  <ins class="adsbygoogle"
       style="display:block"
       data-ad-format="autorelaxed"
       data-ad-client="ca-pub-7059052735946479"
       data-ad-slot="1798823861"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
    
  <footer class="footer">
    Made with love in Bharat ♥️
  </footer>
    
  <!-- PeerJS (v1.5.4) -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js"></script> 
  <script>
// Firebase config
const firebaseConfig = {
  databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let peer, myConn, myId, waitingRef;
let currentSystemMessage = null;
let isConnected = false;
let localStream, remoteStream;
let escPressedOnce = false;
let escTimer = null;

// DOM elements
const remoteVideo = document.getElementById('remoteVideo');
const localVideo = document.getElementById('localVideo');
const remotePlaceholder = document.getElementById('remotePlaceholder');
const localPlaceholder = document.getElementById('localPlaceholder');
const systemMsg = document.getElementById('systemMsg');
const newChatBtn = document.getElementById('newChatBtn');

// Initialize video chat when page loads
window.addEventListener('load', function() {
  initVideoChat();
});

// Handle page refresh/close
window.addEventListener('beforeunload', function(e) {
  if (isConnected) {
    e.preventDefault();
    e.returnValue = 'Are you sure you want to leave? Your video chat will be disconnected.';
    return e.returnValue;
  }
  
  // Clean up resources
  if (peer) peer.destroy();
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }
  if (remoteStream) {
    remoteStream.getTracks().forEach(track => track.stop());
  }
  
  // Remove from waiting list if still there
  if (myId) {
    db.ref("videoWaiting").orderByValue().equalTo(myId).once('value', (snap) => {
      snap.forEach(child => child.ref.remove());
    });
  }
});

// Escape key functionality
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (!escPressedOnce) {
      // First press - show message
      escPressedOnce = true;
      showSystemMessage("Press Esc again to skip this chat and find someone new");
      
      // Set timer to reset after 3 seconds
      escTimer = setTimeout(() => {
        escPressedOnce = false;
        hideSystemMessage();
      }, 3000);
    } else {
      // Second press - skip chat
      clearTimeout(escTimer);
      escPressedOnce = false;
      if (myConn) myConn.close();
      cleanUpWaitingList();
      isConnected = false;
      hideNewChatButton();
      startPeer();
    }
  }
});

async function initVideoChat() {
  try {
    // Get user media
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localPlaceholder.style.display = 'none';
    
    // Start peer connection
    startPeer();
  } catch (error) {
    console.error('Error accessing media devices:', error);
    showSystemMessage("Could not access your camera/microphone. Please check permissions.");
    localPlaceholder.textContent = "Camera access denied";
    showNewChatButton();
  }
}

function startPeer() {
  hideSystemMessage();
  isConnected = false;
  
  // Clear remote video
  remoteVideo.srcObject = null;
  remotePlaceholder.style.display = 'flex';
  remotePlaceholder.textContent = "Waiting for stranger to connect...";
  
  // Destroy existing peer if any
  if (peer) peer.destroy();
  
  showSystemMessage("Looking for a stranger...");
  
  // PeerJS configuration
  peer = new Peer({
    config: {
      iceServers: [
        { url: 'stun:stun.l.google.com:19302' },
        { url: 'stun:stun1.l.google.com:19302' },
        { url: 'stun:stun2.l.google.com:19302' },
        { url: 'stun:stun3.l.google.com:19302' },
        { url: 'stun:stun4.l.google.com:19302' }
      ]
    }
  });
  
  peer.on('open', (id) => {
    myId = id;
    tryToFindMatch();
  });
  
  peer.on('error', (err) => {
    console.error('PeerJS error:', err);
    showSystemMessage("Connection error. Click 'New Chat' to try again.");
    showNewChatButton();
  });
}

function tryToFindMatch() {
  waitingRef = db.ref("videoWaiting");
  
  waitingRef.once('value', (snapshot) => {
    const list = snapshot.val();
    if (list) {
      for (let [key, otherId] of Object.entries(list)) {
        if (otherId !== myId && !isConnected) {
          db.ref("videoWaiting/" + key).remove();
          connectToPeer(otherId);
          return;
        }
      }
    }
    
    if (!isConnected) {
      const newRef = waitingRef.push();
      newRef.set(myId);
      
      waitingRef.on('child_added', (childSnapshot) => {
        const otherId = childSnapshot.val();
        if (otherId !== myId && !isConnected) {
          waitingRef.off();
          childSnapshot.ref.remove();
          db.ref("videoWaiting").orderByValue().equalTo(myId).once('value', (snap) => {
            snap.forEach(child => child.ref.remove());
          });
          connectToPeer(otherId);
        }
      });
    }
  });

  peer.on("call", (call) => {
    if (!isConnected && localStream) {
      hideSystemMessage();
      call.answer(localStream);
      setupCall(call);
      
      // Clean up waiting status
      db.ref("videoWaiting").orderByValue().equalTo(myId).once('value', (snap) => {
        snap.forEach(child => child.ref.remove());
      });
    }
  });
}

function connectToPeer(otherId) {
  if (isConnected || !localStream) return;
  
  showSystemMessage("Connecting to stranger...");
  const call = peer.call(otherId, localStream);
  setupCall(call);
  
  call.on("error", (err) => {
    console.error("Call error:", err);
    if (!isConnected) {
      showSystemMessage("Failed to connect. Click 'New Chat' to try again.");
      showNewChatButton();
    }
  });
}

function setupCall(call) {
  if (myConn) {
    myConn.close();
    remoteVideo.srcObject = null;
  }
  
  myConn = call;
  isConnected = true;
  hideNewChatButton();
  
  call.on("stream", (stream) => {
    remoteStream = stream;
    remoteVideo.srcObject = stream;
    remotePlaceholder.style.display = 'none';
    hideSystemMessage();
  });
  
  call.on("close", () => {
    endConnection("Stranger disconnected");
  });
  
  call.on("error", (err) => {
    console.error("Call error:", err);
    endConnection("Connection error");
  });
}

function endConnection(message) {
  showSystemMessage(message);
  remoteVideo.srcObject = null;
  remotePlaceholder.style.display = 'flex';
  remotePlaceholder.textContent = message;
  myConn = null;
  isConnected = false;
  showNewChatButton();
}

function cleanUpWaitingList() {
  if (waitingRef) {
    waitingRef.off();
    db.ref("videoWaiting").orderByValue().equalTo(myId).once('value', (snap) => {
      snap.forEach(child => child.ref.remove());
    });
  }
}

function showSystemMessage(msg) {
  systemMsg.textContent = msg;
  systemMsg.style.display = 'block';
}

function hideSystemMessage() {
  systemMsg.style.display = 'none';
}

function showNewChatButton() {
  newChatBtn.style.display = 'block';
}

function hideNewChatButton() {
  newChatBtn.style.display = 'none';
}

// Event Listeners
document.getElementById("skipBtn").onclick = () => {
  if (myConn) myConn.close();
  cleanUpWaitingList();
  isConnected = false;
  showSystemMessage("Chat ended. Click 'New Chat' to find someone new.");
  showNewChatButton();
};

document.getElementById("newChatBtn").onclick = () => {
  hideNewChatButton();
  startPeer();
};

// Theme toggle functionality
const themeToggle = document.getElementById('themeToggle');
const body = document.body;

const savedTheme = localStorage.getItem('theme') || 
                 (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');

if (savedTheme === 'light') {
  body.classList.add('light-mode');
  themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
} else {
  themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
}

themeToggle.addEventListener('click', () => {
  body.classList.toggle('light-mode');
  
  if (body.classList.contains('light-mode')) {
    localStorage.setItem('theme', 'light');
    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  } else {
    localStorage.setItem('theme', 'dark');
    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
  }
});
</script>
</body>
</html>
