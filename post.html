<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonymous Posts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      background: #f5f5f5;
      padding: 20px;
    }

    .post-input-container {
      position: relative;
      margin-bottom: 20px;
    }

    textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      padding-right: 80px;
      font-size: 16px;
      box-sizing: border-box;
      resize: vertical;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .post-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .post-button:hover {
      background: #0056b3;
    }

    button {
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    .post {
      background: white;
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .timestamp {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }

    .buttons {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .buttons button {
      margin-right: 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    .share-btn {
      background: #28a745;
      color: white;
      border: none;
    }

    .share-btn:hover {
      background: #218838;
    }

    .like-btn {
      background: #007bff;
      color: white;
      border: none;
    }

    .like-btn:hover {
      background: #0056b3;
    }

    .dislike-btn {
      background: #6c757d;
      color: white;
      border: none;
    }

    .dislike-btn:hover {
      background: #545b62;
    }

    .nickname {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .system-msg {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-style: italic;
    }

    .url-preview {
      margin: 10px 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    .url-preview-content {
      padding: 12px;
    }

    .url-preview a {
      color: #007bff;
      text-decoration: none;
    }

    .url-preview a:hover {
      text-decoration: underline;
    }

    .preview-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
      color: #333;
    }

    .preview-description {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .preview-domain {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
    }

    .preview-image {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 4px;
      margin-top: 8px;
    }

    .preview-with-image {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .preview-text-content {
      flex: 1;
      min-width: 0;
    }

    .preview-image-side {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .preview-image-side img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }

    .highlighted-post {
      border: 2px solid #007bff;
      background-color: #f0f8ff;
    }
  </style>
</head>
<body>

  <h2>Post Something</h2>
  <div class="post-input-container">
    <textarea id="postText" placeholder="Write here..."></textarea>
    <button class="post-button" onclick="submitPost()">Post</button>
  </div>

  <div id="postsContainer"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Init
    firebase.initializeApp({
      databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
    });

    const db = firebase.database();

    // Banned words system
    let bannedWords = [];
    let bannedWordsLoaded = false;

    // Load banned words from /chat/filter.txt
    async function loadBannedWords() {
      try {
        const response = await fetch('/chat/filter.txt');
        const text = await response.text();
        bannedWords = text.split('\n')
          .map(word => word.trim().toLowerCase())
          .filter(word => word.length > 0);
        bannedWordsLoaded = true;
        console.log("Banned words loaded successfully:", bannedWords.length);
      } catch (err) {
        console.error("Error loading banned words:", err);
        // Fallback to basic list
        bannedWords = ['badword1', 'badword2', 'swearword'];
        bannedWordsLoaded = true;
      }
    }

    // Enhanced banned words check
    function containsBannedWords(message) {
      if (!bannedWordsLoaded || !message || typeof message !== 'string') return false;
      
      const lowerMsg = message.toLowerCase();
      return bannedWords.some(word => {
        if (!word || word.length < 2) return false;
        
        const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const pattern = new RegExp(`\\b${escapedWord}\\b`, 'i');
        return pattern.test(message);
      });
    }

    // Get nickname from localStorage
    function getNickname() {
      const savedNickname = localStorage.getItem("talkrush_nickname");
      if (savedNickname) {
        return savedNickname;
      }
      return null;
    }

    // Get user ID from localStorage or create one
    function getUserId() {
      let userId = localStorage.getItem("talkrush_user_id");
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("talkrush_user_id", userId);
      }
      return userId;
    }

    // Show system message
    function showSystemMessage(msg) {
      const systemDiv = document.createElement("div");
      systemDiv.className = "system-msg";
      systemDiv.textContent = msg;
      document.getElementById("postsContainer").prepend(systemDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        systemDiv.remove();
      }, 3000);
    }

    // Extract URL from text
    function extractURL(text) {
      // Updated regex to match URLs with or without protocol
      const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\/[^\s]*)?)/g;
      const matches = text.match(urlRegex);
      return matches ? matches[0] : null;
    }

    // Normalize URL (add https if missing)
    function normalizeURL(url) {
      if (!url) return null;
      
      // If URL doesn't start with http or https, add https
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        return 'https://' + url;
      }
      return url;
    }

    // Extract domain from URL
    function extractDomain(url) {
      try {
        const normalizedUrl = normalizeURL(url);
        const domain = new URL(normalizedUrl).hostname.replace('www.', '');
        return domain;
      } catch {
        return url;
      }
    }

    // Get URL preview data
    async function getURLPreview(url) {
      try {
        const normalizedUrl = normalizeURL(url);
        // Using a CORS proxy to avoid CORS issues
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const response = await fetch(proxyUrl + normalizedUrl);
        const html = await response.text();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const title = doc.querySelector('title')?.textContent || 
                     doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || 
                     url;
        
        const description = doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
                          doc.querySelector('meta[property="og:description"]')?.getAttribute('content') || 
                          '';
        
        const image = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || 
                     doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content') || 
                     '';
        
        return {
          title: title.substring(0, 100),
          description: description.substring(0, 150),
          image: image,
          url: normalizedUrl,
          domain: extractDomain(url)
        };
      } catch (error) {
        console.error('Error fetching URL preview:', error);
        return {
          title: url,
          description: '',
          image: '',
          url: normalizeURL(url),
          domain: extractDomain(url)
        };
      }
    }

    // Make text clickable (convert URLs to links)
    function makeTextClickable(text) {
      if (!text) return '';
      
      // Updated regex to match URLs with or without protocol
      const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\/[^\s]*)?)/g;
      
      return text.replace(urlRegex, (url) => {
        const href = normalizeURL(url);
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    // Submit a new post
    async function submitPost() {
      const nickname = getNickname();
      if (!nickname) {
        showSystemMessage("Please set your nickname first in the group chat!");
        return;
      }

      const text = document.getElementById("postText").value.trim();
      if (text === "") {
        showSystemMessage("Write something!");
        return;
      }

      // Check for banned words
      if (containsBannedWords(text)) {
        showSystemMessage("Your post contains inappropriate content and cannot be sent.");
        return;
      }

      if (containsBannedWords(nickname)) {
        showSystemMessage("Your nickname contains inappropriate words. Please change it in group chat.");
        return;
      }

      const userId = getUserId();
      const url = extractURL(text);
      let urlPreview = null;

      // Get URL preview if URL exists
      if (url) {
        urlPreview = await getURLPreview(url);
      }
      
      const newPostRef = db.ref("posts").push();
      const postId = newPostRef.key;
      
      const postData = {
        nickname: nickname,
        text: text,
        timestamp: Date.now(),
        likes: 0,
        dislikes: 0,
        userId: userId,
        urlPreview: urlPreview,
        postId: postId
      };

      newPostRef.set(postData);

      document.getElementById("postText").value = "";
      showSystemMessage("Post published successfully!");
    }

    // Delete post with SweetAlert
    function deletePost(postId, userId) {
      const currentUserId = getUserId();
      if (userId !== currentUserId) {
        showSystemMessage("You can only delete your own posts!");
        return;
      }

      Swal.fire({
        title: 'Are you sure?',
        text: "This action cannot be undone!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        background: '#fff',
        color: '#333'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref("posts/" + postId).remove()
            .then(() => {
              Swal.fire({
                title: 'Deleted!',
                text: 'Your post has been deleted.',
                icon: 'success',
                confirmButtonColor: '#007bff',
                background: '#fff',
                color: '#333'
              });
            })
            .catch(error => {
              Swal.fire({
                title: 'Error!',
                text: 'Failed to delete post.',
                icon: 'error',
                confirmButtonColor: '#dc3545',
                background: '#fff',
                color: '#333'
              });
              console.error(error);
            });
        }
      });
    }

    // Share post using Web Share API
    async function sharePost(post) {
      const shareUrl = window.location.origin + window.location.pathname + '?postId=' + post.postId;

      const shareData = {
        title: 'Check out this post',
        text: post.text.substring(0, 100) + '...',
        url: shareUrl
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
          showSystemMessage("Post shared successfully!");
        } else {
          // Fallback: copy to clipboard
          await navigator.clipboard.writeText(shareUrl);
          showSystemMessage("Link copied to clipboard!");
        }
      } catch (error) {
        console.error('Error sharing:', error);
        // Fallback: copy to clipboard
        await navigator.clipboard.writeText(shareUrl);
        showSystemMessage("Link copied to clipboard!");
      }
    }

    // Check if URL has shared post ID
    function checkSharedPost() {
      const urlParams = new URLSearchParams(window.location.search);
      const sharedPostId = urlParams.get('postId');
      
      if (sharedPostId) {
        // Highlight the post when it loads
        highlightPostId = sharedPostId;
        
        // Remove the parameter from URL without reload
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        showSystemMessage("You've opened a shared post. It will be highlighted.");
      }
    }

    // Highlight a specific post
    let highlightPostId = null;
    function highlightPost(postId) {
      const postElement = document.querySelector(`[data-post-id="${postId}"]`);
      if (postElement) {
        postElement.classList.add('highlighted-post');
        
        // Scroll to the highlighted post
        postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Remove highlight after 5 seconds
        setTimeout(() => {
          postElement.classList.remove('highlighted-post');
        }, 5000);
      }
    }

    // Load and display posts
    const postsContainer = document.getElementById("postsContainer");

    db.ref("posts").on("value", snapshot => {
      postsContainer.innerHTML = "";
      const posts = snapshot.val();
      if (!posts) {
        postsContainer.innerHTML = '<div class="system-msg">No posts yet. Be the first to post!</div>';
        return;
      }

      // Sort by latest
      const sortedPosts = Object.entries(posts).sort((a, b) => b[1].timestamp - a[1].timestamp);

      // If we have a post to highlight, move it to the top
      if (highlightPostId && posts[highlightPostId]) {
        const highlightedPost = [highlightPostId, posts[highlightPostId]];
        const otherPosts = sortedPosts.filter(([id]) => id !== highlightPostId);
        sortedPosts = [highlightedPost, ...otherPosts];
      }

      sortedPosts.forEach(([postId, post]) => {
        const div = document.createElement("div");
        const currentUserId = getUserId();
        const isMyPost = post.userId === currentUserId;
        
        div.className = "post";
        div.setAttribute("data-post-id", postId);

        // Check if post content contains banned words
        const displayText = containsBannedWords(post.text) 
          ? "This post was hidden due to inappropriate content"
          : makeTextClickable(post.text);

        const displayNickname = containsBannedWords(post.nickname)
          ? "Anonymous"
          : (post.nickname || 'Anonymous');

        let urlPreviewHTML = '';
        if (post.urlPreview && !containsBannedWords(post.text)) {
          const hasImage = post.urlPreview.image && post.urlPreview.image.length > 0;
          
          if (hasImage) {
            urlPreviewHTML = `
              <div class="url-preview">
                <a href="${post.urlPreview.url}" target="_blank" rel="noopener noreferrer">
                  <div class="url-preview-content">
                    <div class="preview-with-image">
                      <div class="preview-text-content">
                        <div class="preview-domain">${post.urlPreview.domain}</div>
                        <div class="preview-title">${post.urlPreview.title}</div>
                        ${post.urlPreview.description ? `<div class="preview-description">${post.urlPreview.description}</div>` : ''}
                      </div>
                      <div class="preview-image-side">
                        <img src="${post.urlPreview.image}" alt="Preview">
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            `;
          } else {
            urlPreviewHTML = `
              <div class="url-preview">
                <a href="${post.urlPreview.url}" target="_blank" rel="noopener noreferrer">
                  <div class="url-preview-content">
                    <div class="preview-domain">${post.urlPreview.domain}</div>
                    <div class="preview-title">${post.urlPreview.title}</div>
                    ${post.urlPreview.description ? `<div class="preview-description">${post.urlPreview.description}</div>` : ''}
                  </div>
                </a>
              </div>
            `;
          }
        }

        div.innerHTML = `
          <div class="nickname">${displayNickname}</div>
          <div>${displayText}</div>
          ${urlPreviewHTML}
          <div class="timestamp">${timeSince(post.timestamp)}</div>
          <div class="buttons">
            <button class="like-btn" onclick="likePost('${postId}')">
              <i class="fas fa-thumbs-up"></i> ${post.likes || 0}
            </button>
            <button class="dislike-btn" onclick="dislikePost('${postId}')">
              <i class="fas fa-thumbs-down"></i> ${post.dislikes || 0}
            </button>
            <button class="share-btn" onclick="sharePost(${JSON.stringify({...post, postId}).replace(/"/g, '&quot;')})">
              <i class="fas fa-share"></i> Share
            </button>
            ${isMyPost ? `
              <button class="delete-btn" onclick="deletePost('${postId}', '${post.userId}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            ` : ''}
          </div>
        `;

        postsContainer.appendChild(div);
        
        // Highlight the post if it's the shared one
        if (postId === highlightPostId) {
          highlightPost(postId);
        }
      });
    });

    // Like/dislike functions
    function likePost(postId) {
      const nickname = getNickname();
      if (!nickname) {
        showSystemMessage("Please set your nickname first in the group chat!");
        return;
      }
      
      const ref = db.ref("posts/" + postId + "/likes");
      ref.transaction(current => (current || 0) + 1);
    }

    function dislikePost(postId) {
      const nickname = getNickname();
      if (!nickname) {
        showSystemMessage("Please set your nickname first in the group chat!");
        return;
      }
      
      const ref = db.ref("posts/" + postId + "/dislikes");
      ref.transaction(current => (current || 0) + 1);
    }

    // Convert timestamp to "x ago"
    function timeSince(ts) {
      const seconds = Math.floor((Date.now() - ts) / 1000);
      const intervals = [
        [31536000, 'year'],
        [2592000, 'month'],
        [86400, 'day'],
        [3600, 'hour'],
        [60, 'minute'],
        [1, 'second']
      ];
      for (const [unit, label] of intervals) {
        const count = Math.floor(seconds / unit);
        if (count >= 1) return `${count} ${label}${count > 1 ? 's' : ''} ago`;
      }
      return "just now";
    }

    // Initialize the app
    function initializeApp() {
      loadBannedWords();
      checkSharedPost();
      
      const nickname = getNickname();
      if (nickname) {
        showSystemMessage(`Welcome back, ${nickname}!`);
      } else {
        showSystemMessage("Please set your nickname in the group chat to start posting!");
      }
    }

    // Start the app
    initializeApp();
  </script>
</body>
</html>
