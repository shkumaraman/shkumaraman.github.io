---
layout: default
title: "Post Anonymously â€” Share Your Thoughts"
description: "Post anything anonymously without login. Confess, express, or speak your mind freely. No sign-up, 100% private & secure. Start posting now!"
---

<style>
    :root {
      /* Dark Theme Colors */
      --dark-bg: #121212;
      --dark-header-bg: #181818;
      --dark-header-border: #2a2a2a;
      --dark-chat-bg: #1e1e1e;
      --dark-msg-bg: #2b2b2b;
      --dark-msg-me: #007bff;
      --dark-text: #fff;
      --dark-secondary-text: #aaa;
      --dark-input-bg: #333;
      --dark-input-focus: #444;
      --dark-icon-color: #ccc;
      --dark-icon-hover-bg: rgba(255,255,255,0.1);

      /* Light Theme Colors */
      --light-bg: #f5f5f5;
      --light-header-bg: #ffffff;
      --light-header-border: #e0e0e0;
      --light-chat-bg: #f9f9f9;
      --light-msg-bg: #e9e9e9;
      --light-msg-me: #007bff;
      --light-text: #333;
      --light-secondary-text: #666;
      --light-input-bg: #e0e0e0;
      --light-input-focus: #d0d0d0;
      --light-icon-color: #666;
      --light-icon-hover-bg: rgba(0,0,0,0.05);

      /* Common Colors */
      --post-btn: #007bff;
      --post-btn-hover: #0056b3;
      --delete-btn: #dc3545;
      --share-btn: #25D366;
      --like-btn: #28a745;
      --dislike-btn: #6c757d;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      overflow-x: hidden;
    }
      
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark-bg);
      color: var(--dark-text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    body.light-mode {
      background: var(--light-bg);
      color: var(--light-text);
    }

    .app-header {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: var(--dark-header-bg);
      padding: 8px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
      border-bottom: 1px solid var(--dark-header-border);
      z-index: 10000;
    }

    .light-mode .app-header {
      background: var(--light-header-bg);
      border-bottom: 1px solid var(--light-header-border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: 40px;
      border-radius: 10px;
    }

    .app-title {
      font-size: 1em;
      color: var(--dark-text);
      margin: 0;
    }

    .light-mode .app-title {
      color: var(--light-text);
    }

    .share-btn {
      background: var(--share-btn);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--dark-icon-color);
      font-size: 1.1em;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
      
    .theme-toggle:hover {
      background: var(--dark-icon-hover-bg);
    }

    .light-mode .theme-toggle {
      color: var(--light-icon-color);
    }

    .light-mode .theme-toggle:hover {
      background: var(--light-icon-hover-bg);
    }

    .posts-container {
      flex: 1;
      padding: 60px 10px 10px 10px;
      background: var(--dark-chat-bg);
    }

    .light-mode .posts-container {
      background: var(--light-chat-bg);
    }

    .post-input-container {
      background: var(--dark-msg-bg);
      margin: 10px auto;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      max-width: 600px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .light-mode .post-input-container {
      background: var(--light-msg-bg);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .post-input-wrapper {
      position: relative;
    }

    .post-textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      resize: vertical;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      outline: none;
      background: var(--dark-input-bg);
      color: var(--dark-text);
      transition: background 0.3s;
    }

    .post-textarea:focus {
      background: var(--dark-input-focus);
    }

    .light-mode .post-textarea {
      background: var(--light-input-bg);
      color: var(--light-text);
    }

    .light-mode .post-textarea:focus {
      background: var(--light-input-focus);
    }

    .post-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      background: var(--post-btn);
      color: white;
      border: none;
      border-radius: 15px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .post-button:hover {
      background: var(--post-btn-hover);
    }

    .error-container {
      margin: 10px auto;
      max-width: 600px;
    }

    .error-message {
      background: rgba(220, 53, 69, 0.1);
      color: var(--error-color);
      padding: 10px 15px;
      border-radius: 10px;
      margin: 5px auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .success-message {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
      padding: 10px 15px;
      border-radius: 10px;
      margin: 5px auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .light-mode .error-message {
      background: rgba(220, 53, 69, 0.15);
    }

    .light-mode .success-message {
      background: rgba(40, 167, 69, 0.15);
    }

    /* Post Styling */
    .post {
      background: var(--dark-msg-bg);
      margin: 10px auto;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 600px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .light-mode .post {
      background: var(--light-msg-bg);
      color: var(--light-text);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .nickname {
      font-weight: bold;
      color: var(--dark-text);
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .light-mode .nickname {
      color: var(--light-text);
    }

    .post-content {
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .post-content a {
      color: var(--dark-msg-me);
      text-decoration: none;
    }

    .post-content a:hover {
      text-decoration: underline;
    }

    .light-mode .post-content a {
      color: var(--light-msg-me);
    }

    .timestamp {
      font-size: 0.75em;
      color: var(--dark-secondary-text);
      margin-bottom: 10px;
    }

    .light-mode .timestamp {
      color: var(--light-secondary-text);
    }

    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .like-btn {
      background: var(--like-btn);
      color: white;
    }

    .like-btn:hover {
      opacity: 0.9;
    }

    .dislike-btn {
      background: var(--dislike-btn);
      color: white;
    }

    .dislike-btn:hover {
      opacity: 0.9;
    }

    .share-btn-post {
      background: var(--share-btn);
      color: white;
    }

    .share-btn-post:hover {
      opacity: 0.9;
    }

    .delete-btn {
      background: var(--delete-btn);
      color: white;
    }

    .delete-btn:hover {
      opacity: 0.9;
    }

    .system-msg {
      background: rgba(255, 193, 7, 0.1);
      color: var(--dark-text);
      padding: 10px 15px;
      border-radius: 10px;
      margin: 5px auto;
      font-style: italic;
      text-align: center;
      max-width: 600px;
    }

    .light-mode .system-msg {
      background: rgba(255, 193, 7, 0.2);
      color: var(--light-text);
    }

    .url-preview {
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
      background: rgba(255,255,255,0.05);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .light-mode .url-preview {
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.05);
    }

    .url-preview-content {
      padding: 12px;
    }

    .url-preview a {
      color: var(--dark-msg-me);
      text-decoration: none;
    }

    .url-preview a:hover {
      text-decoration: underline;
    }

    .light-mode .url-preview a {
      color: var(--light-msg-me);
    }

    .preview-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9em;
      color: var(--dark-text);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .light-mode .preview-title {
      color: var(--light-text);
    }

    .preview-description {
      font-size: 0.8em;
      color: var(--dark-secondary-text);
      margin-bottom: 8px;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .light-mode .preview-description {
      color: var(--light-secondary-text);
    }

    .preview-domain {
      font-size: 0.75em;
      color: var(--dark-secondary-text);
      margin-bottom: 8px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .light-mode .preview-domain {
      color: var(--light-secondary-text);
    }

    .preview-image {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 4px;
      margin-top: 8px;
    }

    .preview-with-image {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .preview-text-content {
      flex: 1;
      min-width: 0;
    }

    .preview-image-side {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .preview-image-side img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }

    .image-preview {
      margin: 10px 0;
      text-align: center;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .image-preview img:hover {
      transform: scale(1.02);
    }

    .highlighted-post {
      border: 2px solid var(--dark-msg-me);
      background-color: rgba(0, 123, 255, 0.1);
      animation: pulse 2s infinite;
    }

    .light-mode .highlighted-post {
      border: 2px solid var(--light-msg-me);
      background-color: rgba(0, 123, 255, 0.05);
    }

    @keyframes pulse {
      0% { border-color: var(--dark-msg-me); }
      50% { border-color: #66b3ff; }
      100% { border-color: var(--dark-msg-me); }
    }

    .light-mode @keyframes pulse {
      0% { border-color: var(--light-msg-me); }
      50% { border-color: #66b3ff; }
      100% { border-color: var(--light-msg-me); }
    }

    /* Fullscreen Image Modal */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 10001;
      align-items: center;
      justify-content: center;
      padding: 20px;
      cursor: pointer;
    }

    .image-modal.active {
      display: flex;
    }

    .modal-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
      cursor: default;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
      cursor: default;
    }

    .modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 5px 10px;
      z-index: 10002;
    }

    .modal-close:hover {
      color: #ddd;
    }

    /* Scrollbar styling */
    .posts-container::-webkit-scrollbar {
      width: 8px;
    }

    .posts-container::-webkit-scrollbar-track {
      background: var(--dark-chat-bg);
    }

    .posts-container::-webkit-scrollbar-thumb {
      background: var(--dark-input-bg);
      border-radius: 4px;
    }

    .posts-container::-webkit-scrollbar-thumb:hover {
      background: var(--dark-input-focus);
    }

    .light-mode .posts-container::-webkit-scrollbar-track {
      background: var(--light-chat-bg);
    }

    .light-mode .posts-container::-webkit-scrollbar-thumb {
      background: var(--light-input-bg);
    }

    .light-mode .posts-container::-webkit-scrollbar-thumb:hover {
      background: var(--light-input-focus);
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .post-input-container {
        margin: 15px 10px;
        padding: 5px;
      }
      
      .post {
        margin: 10px 10px;
        padding: 12px;
      }
      
      .buttons button {
        padding: 5px 10px;
        font-size: 0.8em;
      }
      
      .share-btn span {
        display: none;
      }
      
      .share-btn {
        padding: 8px;
      }

      .header-right {
        gap: 5px;
      }
    }
  </style>

<div class="app-header">
  <div class="header-left">
    <button class="menu-btn" onclick="toggleMenu()">&#9776;</button>
    <img src="/chat/logo.png" alt="TalkRush Logo" class="logo">
    <h1 class="app-title">Anonymous Posts</h1>
  </div>
  <div class="header-right">
    <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Mode">
      <i class="fas fa-moon"></i>
    </button>
    <button id="shareBtn" class="share-btn">
      <i class="fa-solid fa-arrow-up-from-bracket"></i>
      <span>Share</span>
    </button>
  </div>
</div>

<div class="posts-container" id="postsContainer">
  <!-- Post input at top -->
  <div class="post-input-container">
    <div class="post-input-wrapper">
      <textarea 
        id="postText" 
        class="post-textarea" 
        placeholder="Write here..."
        rows="3"
      ></textarea>
      <button class="post-button" onclick="submitPost()">
        <i class="fas fa-paper-plane"></i> Post
      </button>
    </div>
  </div>
  
  <!-- Error container below post input -->
  <div class="error-container" id="errorContainer"></div>
  
  <!-- Posts will be loaded here -->
</div>

<!-- Fullscreen Image Modal -->
<div class="image-modal" id="imageModal">
  <button class="modal-close" id="modalClose">&times;</button>
  <div class="modal-content">
    <img id="modalImage" src="" alt="Fullscreen image">
  </div>
</div>

{% include menu.html %}
{% include scripts.html %}
  
<script>
    // Firebase Init
    const firebaseConfig = {
      databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Banned words system
    let bannedWords = [];
    let bannedWordsLoaded = false;

    // Load banned words from /chat/filter.txt
    async function loadBannedWords() {
      try {
        const response = await fetch('/chat/filter.txt');
        const text = await response.text();
        bannedWords = text.split('\n')
          .map(word => word.trim().toLowerCase())
          .filter(word => word.length > 0);
        bannedWordsLoaded = true;
        console.log("Banned words loaded successfully:", bannedWords.length);
      } catch (err) {
        console.error("Error loading banned words:", err);
        // Fallback to basic list
        bannedWords = ['badword1', 'badword2', 'swearword'];
        bannedWordsLoaded = true;
      }
    }

    // Enhanced banned words check
    function containsBannedWords(message) {
      if (!bannedWordsLoaded || !message || typeof message !== 'string') return false;
      
      const lowerMsg = message.toLowerCase();
      return bannedWords.some(word => {
        if (!word || word.length < 2) return false;
        
        const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const pattern = new RegExp(`\\b${escapedWord}\\b`, 'i');
        return pattern.test(message);
      });
    }

    // Get nickname from localStorage
    function getNickname() {
      const savedNickname = localStorage.getItem("talkrush_nickname");
      if (savedNickname) {
        return savedNickname;
      }
      return null;
    }

    // Get user ID from localStorage or create one
    function getUserId() {
      let userId = localStorage.getItem("talkrush_user_id");
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("talkrush_user_id", userId);
      }
      return userId;
    }

    // Show error message in error container
    function showError(message) {
      const errorContainer = document.getElementById("errorContainer");
      const errorDiv = document.createElement("div");
      errorDiv.className = "error-message";
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      errorContainer.appendChild(errorDiv);
      
      // Remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }

    // Show success message in error container
    function showSuccess(message) {
      const errorContainer = document.getElementById("errorContainer");
      const successDiv = document.createElement("div");
      successDiv.className = "success-message";
      successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      errorContainer.appendChild(successDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.remove();
        }
      }, 3000);
    }

    // Extract URL from text
    function extractURL(text) {
      const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\/[^\s]*)?)/g;
      const matches = text.match(urlRegex);
      return matches ? matches[0] : null;
    }

    // Check if URL is a direct image
    function isImageURL(url) {
      if (!url) return false;
      const imageExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.bmp', '.svg'];
      const lowerUrl = url.toLowerCase();
      return imageExtensions.some(ext => lowerUrl.includes(ext));
    }

    // Check if URL is from Google Images
    function isGoogleImagesURL(url) {
      if (!url) return false;
      return url.includes('encrypted-tbn0.gstatic.com') || 
             url.includes('googleusercontent.com') || 
             url.includes('ggpht.com') ||
             (url.includes('google.') && (url.includes('imgres') || url.includes('imgurl')));
    }

    // Normalize URL (add https if missing)
    function normalizeURL(url) {
      if (!url) return null;
      
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        return 'https://' + url;
      }
      return url;
    }

    // Extract domain from URL
    function extractDomain(url) {
      try {
        const normalizedUrl = normalizeURL(url);
        const domain = new URL(normalizedUrl).hostname.replace('www.', '');
        return domain;
      } catch {
        return url;
      }
    }

    // Get URL preview data
    async function getURLPreview(url) {
      try {
        // If it's a direct image URL (including Google Images), return image preview
        if (isImageURL(url) || isGoogleImagesURL(url)) {
          return {
            type: 'image',
            url: normalizeURL(url),
            title: '',
            description: '',
            image: normalizeURL(url),
            domain: extractDomain(url)
          };
        }

        // Otherwise, try to get website preview
        const normalizedUrl = normalizeURL(url);
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const response = await fetch(proxyUrl + normalizedUrl);
        const html = await response.text();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const title = doc.querySelector('title')?.textContent || 
                     doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || 
                     url;
        
        const description = doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
                          doc.querySelector('meta[property="og:description"]')?.getAttribute('content') || 
                          '';
        
        const image = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || 
                     doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content') || 
                     '';
        
        return {
          type: 'website',
          title: title.substring(0, 100),
          description: description.substring(0, 150),
          image: image,
          url: normalizedUrl,
          domain: extractDomain(url)
        };
      } catch (error) {
        console.error('Error fetching URL preview:', error);
        return {
          type: 'website',
          title: url,
          description: '',
          image: '',
          url: normalizeURL(url),
          domain: extractDomain(url)
        };
      }
    }

    // Make text clickable (convert URLs to links with nofollow)
    function makeTextClickable(text) {
      if (!text) return '';
      
      const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\/[^\s]*)?)/g;
      
      return text.replace(urlRegex, (url) => {
        const href = normalizeURL(url);
        return `<a href="${href}" target="_blank" rel="noopener nofollow">${url}</a>`;
      });
    }

    // Create AdSense ad element
    function createAdElement() {
      const adContainer = document.createElement('div');
      adContainer.className = 'ad-container';
      
      adContainer.innerHTML = `
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-7059052735946479"
             data-ad-slot="8592327962"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      `;
      
      return adContainer;
    }

    // Submit a new post
    async function submitPost() {
      const nickname = getNickname();
      if (!nickname) {
        showError("Please set your nickname first in the group chat!");
        return;
      }

      const text = document.getElementById("postText").value.trim();
      if (text === "") {
        showError("Write something!");
        return;
      }

      // Check for banned words
      if (containsBannedWords(text)) {
        showError("Your post contains inappropriate content and cannot be sent.");
        return;
      }

      if (containsBannedWords(nickname)) {
        showError("Your nickname contains inappropriate words. Please change it in group chat.");
        return;
      }

      const userId = getUserId();
      const url = extractURL(text);
      let urlPreview = null;

      // Get URL preview if URL exists
      if (url) {
        try {
          urlPreview = await getURLPreview(url);
        } catch (error) {
          console.error('Error getting URL preview:', error);
          // Continue without preview if there's an error
        }
      }
      
      const newPostRef = db.ref("posts").push();
      const postId = newPostRef.key;
      
      const postData = {
        nickname: nickname,
        text: text,
        timestamp: Date.now(),
        likes: 0,
        dislikes: 0,
        userId: userId,
        urlPreview: urlPreview,
        postId: postId
      };

      try {
        await newPostRef.set(postData);
        document.getElementById("postText").value = "";
        showSuccess("Post published successfully!");
      } catch (error) {
        console.error('Error publishing post:', error);
        showError("Failed to publish post. Please try again.");
      }
    }

    // Delete post with SweetAlert
    function deletePost(postId, userId) {
      const currentUserId = getUserId();
      if (userId !== currentUserId) {
        showError("You can only delete your own posts!");
        return;
      }

      Swal.fire({
        title: 'Are you sure?',
        text: "This action cannot be undone!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        background: document.body.classList.contains('light-mode') ? '#fff' : '#1e1e1e',
        color: document.body.classList.contains('light-mode') ? '#333' : '#fff'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref("posts/" + postId).remove()
            .then(() => {
              Swal.fire({
                title: 'Deleted!',
                text: 'Your post has been deleted.',
                icon: 'success',
                confirmButtonColor: '#007bff',
                background: document.body.classList.contains('light-mode') ? '#fff' : '#1e1e1e',
                color: document.body.classList.contains('light-mode') ? '#333' : '#fff'
              });
            })
            .catch(error => {
              Swal.fire({
                title: 'Error!',
                text: 'Failed to delete post.',
                icon: 'error',
                confirmButtonColor: '#dc3545',
                background: document.body.classList.contains('light-mode') ? '#fff' : '#1e1e1e',
                color: document.body.classList.contains('light-mode') ? '#333' : '#fff'
              });
              console.error(error);
            });
        }
      });
    }

    // Share post using Web Share API
    async function sharePost(post) {
      const shareUrl = window.location.origin + window.location.pathname + '?postId=' + post.postId;

      const shareData = {
        title: 'Check out this post',
        text: post.text.substring(0, 100) + '...',
        url: shareUrl
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          await navigator.clipboard.writeText(shareUrl);
          showSuccess("Link copied to clipboard!");
        }
      } catch (error) {
        console.error('Error sharing:', error);
        await navigator.clipboard.writeText(shareUrl);
        showSuccess("Link copied to clipboard!");
      }
    }

    // Check if URL has shared post ID
    function checkSharedPost() {
      const urlParams = new URLSearchParams(window.location.search);
      const sharedPostId = urlParams.get('postId');
      
      if (sharedPostId) {
        highlightPostId = sharedPostId;
        
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        showSuccess("You've opened a shared post. It will be highlighted.");
      }
    }

    // Highlight a specific post
    let highlightPostId = null;
    function highlightPost(postId) {
      const postElement = document.querySelector(`[data-post-id="${postId}"]`);
      if (postElement) {
        postElement.classList.add('highlighted-post');
        
        postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        setTimeout(() => {
          postElement.classList.remove('highlighted-post');
        }, 5000);
      }
    }

    // Like/Dislike functionality with localStorage tracking
    function hasUserInteracted(postId, type) {
      const interactions = JSON.parse(localStorage.getItem('postInteractions') || '{}');
      return interactions[postId] === type;
    }

    function setUserInteraction(postId, type) {
      const interactions = JSON.parse(localStorage.getItem('postInteractions') || '{}');
      interactions[postId] = type;
      localStorage.setItem('postInteractions', JSON.stringify(interactions));
    }

    function removeUserInteraction(postId) {
      const interactions = JSON.parse(localStorage.getItem('postInteractions') || '{}');
      delete interactions[postId];
      localStorage.setItem('postInteractions', JSON.stringify(interactions));
    }

    function likePost(postId) {
      const nickname = getNickname();
      if (!nickname) {
        showError("Please set your nickname first in the group chat!");
        return;
      }

      const currentInteraction = hasUserInteracted(postId, 'like') ? 'like' : 
                                hasUserInteracted(postId, 'dislike') ? 'dislike' : null;

      if (currentInteraction === 'like') {
        // Unlike - remove like
        const likeRef = db.ref("posts/" + postId + "/likes");
        likeRef.transaction(current => Math.max(0, (current || 0) - 1));
        removeUserInteraction(postId);
      } else {
        // Like the post
        if (currentInteraction === 'dislike') {
          // Remove dislike first
          const dislikeRef = db.ref("posts/" + postId + "/dislikes");
          dislikeRef.transaction(current => Math.max(0, (current || 0) - 1));
        }

        const likeRef = db.ref("posts/" + postId + "/likes");
        likeRef.transaction(current => (current || 0) + 1);
        setUserInteraction(postId, 'like');
      }
    }

    function dislikePost(postId) {
      const nickname = getNickname();
      if (!nickname) {
        showError("Please set your nickname first in the group chat!");
        return;
      }

      const currentInteraction = hasUserInteracted(postId, 'like') ? 'like' : 
                                hasUserInteracted(postId, 'dislike') ? 'dislike' : null;

      if (currentInteraction === 'dislike') {
        // Undislike - remove dislike
        const dislikeRef = db.ref("posts/" + postId + "/dislikes");
        dislikeRef.transaction(current => Math.max(0, (current || 0) - 1));
        removeUserInteraction(postId);
      } else {
        // Dislike the post
        if (currentInteraction === 'like') {
          // Remove like first
          const likeRef = db.ref("posts/" + postId + "/likes");
          likeRef.transaction(current => Math.max(0, (current || 0) - 1));
        }

        const dislikeRef = db.ref("posts/" + postId + "/dislikes");
        dislikeRef.transaction(current => (current || 0) + 1);
        setUserInteraction(postId, 'dislike');
      }
    }

    // Fullscreen image modal functions
    function openImageModal(imageUrl) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      modalImage.src = imageUrl;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Load and display posts with randomization and ads
    const postsContainer = document.getElementById("postsContainer");
    let adCounter = 0;

    db.ref("posts").on("value", snapshot => {
      // Keep the post input container and error container
      const postInputContainer = document.querySelector('.post-input-container');
      const errorContainer = document.getElementById("errorContainer");
      postsContainer.innerHTML = '';
      postsContainer.appendChild(postInputContainer);
      postsContainer.appendChild(errorContainer);
      
      const posts = snapshot.val();
      if (!posts) {
        const noPostsMsg = document.createElement("div");
        noPostsMsg.className = "system-msg";
        noPostsMsg.textContent = "No posts yet. Be the first to post!";
        postsContainer.appendChild(noPostsMsg);
        return;
      }

      // Convert to array and randomize order
      let postsArray = Object.entries(posts);
      
      // Randomize posts using Fisher-Yates shuffle
      for (let i = postsArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [postsArray[i], postsArray[j]] = [postsArray[j], postsArray[i]];
      }

      // If we have a post to highlight, move it to the top
      if (highlightPostId && posts[highlightPostId]) {
        const highlightedPostIndex = postsArray.findIndex(([id]) => id === highlightPostId);
        if (highlightedPostIndex !== -1) {
          const highlightedPost = postsArray.splice(highlightedPostIndex, 1)[0];
          postsArray.unshift(highlightedPost);
        }
      }

      // Reset ad counter
      adCounter = 0;

      postsArray.forEach(([postId, post], index) => {
        const div = document.createElement("div");
        const currentUserId = getUserId();
        const isMyPost = post.userId === currentUserId;
        
        div.className = "post";
        div.setAttribute("data-post-id", postId);

        // Check if post content contains banned words
        const displayText = containsBannedWords(post.text) 
          ? "This post was hidden due to inappropriate content"
          : makeTextClickable(post.text);

        const displayNickname = containsBannedWords(post.nickname)
          ? "Anonymous"
          : (post.nickname || 'Anonymous');

        let urlPreviewHTML = '';
        if (post.urlPreview && !containsBannedWords(post.text)) {
          if (post.urlPreview.type === 'image' || 
              post.urlPreview.type === 'google-image') {
            
            // Direct image preview with click to open in fullscreen
            const imageUrl = post.urlPreview.image || post.urlPreview.url;
            if (imageUrl) {
              urlPreviewHTML = `
                <div class="image-preview">
                  <img src="${imageUrl}" alt="Image preview" 
                       onclick="openImageModal('${imageUrl}')"
                       onerror="this.style.display='none'"
                       style="cursor: pointer;">
                </div>
              `;
            }
          } else {
            // Website preview
            const hasImage = post.urlPreview.image && post.urlPreview.image.length > 0;
            
            if (hasImage) {
              urlPreviewHTML = `
                <div class="url-preview">
                  <a href="${post.urlPreview.url}" target="_blank" rel="noopener nofollow">
                    <div class="url-preview-content">
                      <div class="preview-with-image">
                        <div class="preview-text-content">
                          <div class="preview-domain">${post.urlPreview.domain}</div>
                          <div class="preview-title">${post.urlPreview.title}</div>
                          ${post.urlPreview.description ? `<div class="preview-description">${post.urlPreview.description}</div>` : ''}
                        </div>
                        <div class="preview-image-side">
                          <img src="${post.urlPreview.image}" alt="Preview" onerror="this.style.display='none'">
                        </div>
                      </div>
                    </div>
                  </a>
                </div>
              `;
            } else {
              urlPreviewHTML = `
                <div class="url-preview">
                  <a href="${post.urlPreview.url}" target="_blank" rel="noopener nofollow">
                    <div class="url-preview-content">
                      <div class="preview-domain">${post.urlPreview.domain}</div>
                      <div class="preview-title">${post.urlPreview.title}</div>
                      ${post.urlPreview.description ? `<div class="preview-description">${post.urlPreview.description}</div>` : ''}
                    </div>
                  </a>
                </div>
              `;
            }
          }
        }

        // Check user interaction for this post
        const userInteraction = hasUserInteracted(postId, 'like') ? 'like' : 
                               hasUserInteracted(postId, 'dislike') ? 'dislike' : null;

        div.innerHTML = `
          <div class="nickname">${displayNickname}</div>
          <div class="post-content">${displayText}</div>
          ${urlPreviewHTML}
          <div class="timestamp">${timeSince(post.timestamp)}</div>
          <div class="buttons">
            <button class="like-btn ${userInteraction === 'like' ? 'active' : ''}" onclick="likePost('${postId}')">
              <i class="fas fa-thumbs-up"></i> ${post.likes || 0}
            </button>
            <button class="dislike-btn ${userInteraction === 'dislike' ? 'active' : ''}" onclick="dislikePost('${postId}')">
              <i class="fas fa-thumbs-down"></i> ${post.dislikes || 0}
            </button>
            <button class="share-btn-post" onclick="sharePost(${JSON.stringify({...post, postId}).replace(/"/g, '&quot;')})">
              <i class="fas fa-share"></i> Share
            </button>
            ${isMyPost ? `
              <button class="delete-btn" onclick="deletePost('${postId}', '${post.userId}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            ` : ''}
          </div>
        `;

        postsContainer.appendChild(div);
        
        // Insert AdSense ad after every 2 posts
        adCounter++;
        if (adCounter % 2 === 0) {
          const adElement = createAdElement();
          postsContainer.appendChild(adElement);
          
          // Push the ad to AdSense
          try {
            (adsbygoogle = window.adsbygoogle || []).push({});
          } catch (error) {
            console.error('Error loading AdSense ad:', error);
          }
        }
        
        // Highlight the post if it's the shared one
        if (postId === highlightPostId) {
          setTimeout(() => {
            highlightPost(postId);
          }, 100);
        }
      });
    });

    // Convert timestamp to "x ago"
    function timeSince(ts) {
      const seconds = Math.floor((Date.now() - ts) / 1000);
      const intervals = [
        [31536000, 'year'],
        [2592000, 'month'],
        [86400, 'day'],
        [3600, 'hour'],
        [60, 'minute'],
        [1, 'second']
      ];
      for (const [unit, label] of intervals) {
        const count = Math.floor(seconds / unit);
        if (count >= 1) return `${count} ${label}${count > 1 ? 's' : ''} ago`;
      }
      return "just now";
    }

    // Initialize the app
    function initializeApp() {
      loadBannedWords();
      checkSharedPost();
      
      const nickname = getNickname();
      if (nickname) {
        showSuccess(`Welcome back, ${nickname}!`);
      } else {
        showError("Please set your nickname in the group chat to start posting!");
      }

      // Set up image modal event listeners
      const modal = document.getElementById('imageModal');
      const modalClose = document.getElementById('modalClose');
      
      modalClose.addEventListener('click', closeImageModal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('modal-close')) {
          closeImageModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeImageModal();
        }
      });

      // Set up share button
      document.getElementById('shareBtn').addEventListener('click', () => {
        const shareUrl = window.location.href;
        if (navigator.share) {
          navigator.share({
            title: 'Anonymous Posts',
            text: 'Share your thoughts anonymously!',
            url: shareUrl
          });
        } else {
          navigator.clipboard.writeText(shareUrl);
          showSuccess("App link copied to clipboard!");
        }
      });

      // Set up theme toggle
      document.getElementById('themeToggle').addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        const icon = document.querySelector('#themeToggle i');
        if (document.body.classList.contains('light-mode')) {
          icon.className = 'fas fa-sun';
          localStorage.setItem('theme', 'light');
        } else {
          icon.className = 'fas fa-moon';
          localStorage.setItem('theme', 'dark');
        }
      });

      // Load saved theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        document.querySelector('#themeToggle i').className = 'fas fa-sun';
      }
    }

    // Start the app
    initializeApp();
</script>
