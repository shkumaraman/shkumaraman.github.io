<div id="friendActions">

  <button id="addFriendBtn">
    âž• Add Friend
  </button>

  <div id="friendRequestBox">
    <p>ðŸ‘‹ This person wants to add you as a friend</p>
    <button id="acceptFriendBtn">Accept</button>
  </div>

</div>

<style>
#friendActions {
  position: fixed;
  top: 60px;
  right: 20px;
  z-index: 9999;
  text-align: right;
}

#addFriendBtn {
  display: none;
  background: #4caf50;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

#addFriendBtn:hover {
  background: #43a047;
}

#friendRequestBox {
  display: none;
  margin-top: 8px;
  padding: 10px;
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#acceptFriendBtn {
  background: #2196f3;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}

#acceptFriendBtn:hover {
  background: #1e88e5;
}
</style>

<script>
(function () {

  const addFriendBtn = document.getElementById("addFriendBtn");
  const friendRequestBox = document.getElementById("friendRequestBox");
  const acceptFriendBtn = document.getElementById("acceptFriendBtn");

  let currentFriendPeer = null;
  let requestSent = false;

  addFriendBtn.onclick = () => {
    if (!state.myConn || requestSent) return;

    state.myConn.send({
      type: "friend-request",
      from: state.myId
    });

    requestSent = true;
    addFriendBtn.innerText = "Request Sent";
  };

  acceptFriendBtn.onclick = async () => {
    if (!currentFriendPeer) return;

    const friendData = {
      peer1: state.myId,
      peer2: currentFriendPeer,
      timestamp: Date.now()
    };

    const friendId = "friend_" + Date.now();

    await db.ref("friends/" + friendId).set(friendData);

    let friends = JSON.parse(localStorage.getItem("friends")) || [];
    friends.push(friendData);
    localStorage.setItem("friends", JSON.stringify(friends));

    state.myConn.send({
      type: "friend-accepted",
      friendData
    });

    friendRequestBox.style.display = "none";
    addFriendBtn.style.display = "none";

    messageHandler.logSystem("Friend added â¤ï¸");
  };

  const originalHandleData = connectionManager.handleData;
  connectionManager.handleData = (data) => {

    if (data?.type === "friend-request") {
      currentFriendPeer = data.from;
      friendRequestBox.style.display = "block";
      return;
    }

    if (data?.type === "friend-accepted") {
      let friends = JSON.parse(localStorage.getItem("friends")) || [];
      friends.push(data.friendData);
      localStorage.setItem("friends", JSON.stringify(friends));

      addFriendBtn.style.display = "none";
      messageHandler.logSystem("You are now friends â¤ï¸");
      return;
    }

    originalHandleData(data);
  };

  const originalSetupConnection = connectionManager.setupConnection;
  connectionManager.setupConnection = (conn) => {
    originalSetupConnection(conn);
    currentFriendPeer = conn.peer;
    requestSent = false;
    addFriendBtn.innerText = "âž• Add Friend";
    addFriendBtn.style.display = "inline-block";
  };

  const originalEndConnection = connectionManager.endConnection;
  connectionManager.endConnection = (msg) => {
    addFriendBtn.style.display = "none";
    friendRequestBox.style.display = "none";
    currentFriendPeer = null;
    requestSent = false;
    originalEndConnection(msg);
  };

})();
</script>
