<!-- ADD FRIEND BUTTON -->
<div id="addFriendWrap">
  <button id="addFriendBtn" style="display:none">
    ➕ Add Friend
  </button>
  <div id="addFriendStatus"></div>
</div>

<style>
#addFriendBtn {
  position: fixed;
  top: 60px;
  right: 15px;
  z-index: 1000;
  background: #4a90e2;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
}

#addFriendBtn.accept {
  background: #2ecc71;
}

#addFriendStatus {
  position: fixed;
  top: 110px;
  right: 15px;
  font-size: 13px;
  color: #ccc;
}
</style>

<script>
/* Firebase (assumes firebase already initialized globally) */
const db = firebase.database();

/* LocalStorage IDs */
const myPeerId = localStorage.getItem("talkrush_peerid");
const connectedPeerId = localStorage.getItem("talkrush_connectedpeerid");

const addBtn = document.getElementById("addFriendBtn");
const statusBox = document.getElementById("addFriendStatus");

/* Short numeric chatId */
function generateChatId() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

/* Show Add button only if connected */
if (myPeerId && connectedPeerId) {
  addBtn.style.display = "block";
}

/* SEND FRIEND REQUEST */
addBtn.onclick = () => {
  const chatId = generateChatId();

  db.ref("friend_requests/" + connectedPeerId).set({
    from: myPeerId,
    chatId: chatId,
    timestamp: Date.now()
  });

  statusBox.textContent = "Friend request sent";
};

/* LISTEN FOR INCOMING REQUEST */
db.ref("friend_requests/" + myPeerId).on("value", snap => {
  if (!snap.exists()) return;

  const data = snap.val();

  addBtn.style.display = "block";
  addBtn.textContent = "✅ Accept";
  addBtn.classList.add("accept");

  addBtn.onclick = () => acceptFriend(data);
});

/* ACCEPT FRIEND */
function acceptFriend(data) {
  const chatId = data.chatId;

  const friendData = {
    peer1: data.from,
    peer2: myPeerId,
    timestamp: Date.now()
  };

  // Save to Firebase
  db.ref("friends/" + chatId).set(friendData);

  // Remove request
  db.ref("friend_requests/" + myPeerId).remove();

  // Save locally
  const localFriends =
    JSON.parse(localStorage.getItem("talkrush_friends") || "{}");

  localFriends[chatId] = friendData;
  localStorage.setItem("talkrush_friends", JSON.stringify(localFriends));

  addBtn.style.display = "none";
  statusBox.textContent = "You are now friends";
}
</script>
