<style>
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 35px;
        height: 35px;
        background: #ff5252;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    #miniPlayer:hover { transform: scale(1.1); }
    #miniPlayer i { color:white; font-size:18px; }

    /* Thumbnail */
    .square-icon {
        width: 120px; height: 120px;
        background:#ff5252;
        border-radius:20px;
        display:flex; align-items:center; justify-content:center;
        margin:0 auto 25px;
        box-shadow:0 6px 20px rgba(0,0,0,0.2);
        overflow:hidden;
    }
    .square-icon img {
        width:100%; height:100%;
        border-radius:20px;
        object-fit:cover;
    }

    /* Full Player Screen */
    #fullPlayer {
        position:fixed;
        top:0; left:0; right:0; bottom:0;
        background:rgba(255,255,255,0.95);
        z-index:999;
        display:none;
        flex-direction:column;
        align-items:center;
        justify-content:flex-start;
        padding:20px;
        overflow-y:auto;
        box-sizing:border-box;
    }

    #fullPlayer h3 { 
        margin-bottom:20px; 
        color:#333;
        font-family:'Arial';
    }

    /* NEW Search Box */
    #searchBox {
        width:80%; 
        max-width:500px;
        padding:12px 15px;
        margin-bottom:15px;
        border:2px solid #ddd;
        border-radius:8px;
        font-size:16px;
        box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }

    /* Search Result List */
    #searchResults div {
        padding:12px;
        margin:6px 0;
        background:white;
        border-radius:10px;
        border:1px solid #ccc;
        cursor:pointer;
        transition:0.2s;
    }
    #searchResults div:hover {
        background:#f5f5f5;
        transform:scale(1.01);
    }

    .control-buttons {
        display:flex;
        gap:8px;
        margin:20px 0;
    }
    .control-buttons button {
        width:40px; height:40px;
        border:none;
        border-radius:10px;
        background:#f0f0f0;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    #playPauseBtn { background:#ff5252; }
    #playPauseBtn i { color:white; }

    .slider {
        width:80%; max-width:500px;
        margin:15px 0;
        height:6px;
        background:#ddd;
        border-radius:3px;
    }
    .slider::-webkit-slider-thumb {
        background:#ff5252; width:16px; height:16px;
        border-radius:50%;
        cursor:pointer;
    }

    .time-display {
        color:#666;
        font-size:14px;
        font-family:monospace;
    }

    #player {
        width:1px; 
        height:1px;
        opacity:0;
        position:absolute;
        left:-9999px;
    }

    .player-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        width:80%; 
        max-width:500px;
        margin-bottom:10px;
    }

    .now-playing {
        font-size:14px;
        color:#555;
        font-style:italic;
        max-width:250px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
    }

    .loading { display:none; margin-top:10px; color:#666; }
    .error-message { color:#ff5252; display:none; margin-top:10px; }
</style>

<!-- Mini Player Button -->
<div id="miniPlayer"><i class="fas fa-music"></i></div>

<!-- FULL PLAYER -->
<div id="fullPlayer">

    <div class="player-header">
        <h3>MusicPlay</h3>
        <div id="nowPlaying" class="now-playing">Not playing</div>
    </div>

    <!-- Thumbnail -->
    <div class="square-icon">
        <img id="videoThumbnail" src="">
    </div>

    <!-- SEARCH BOX -->
    <input id="searchBox" placeholder="Search songs...">

    <!-- SEARCH RESULTS -->
    <div id="searchResults" style="width:80%;max-width:500px;"></div>

    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage"></div>

    <!-- PLAYER CONTROLS -->
    <div class="control-buttons">
        <button id="loopBtn"><i class="fas fa-repeat" id="loopIcon"></i></button>
        <button id="prevBtn"><i class="fas fa-backward-step"></i></button>
        <button id="playPauseBtn"><i class="fas fa-play" id="playPauseIcon"></i></button>
        <button id="nextBtn"><i class="fas fa-forward-step"></i></button>
        <button id="muteBtn"><i class="fas fa-volume-up" id="muteIcon"></i></button>
    </div>

    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0">

    <div class="time-display">
        <span id="curTime">0:00</span> / <span id="duration">0:00</span>
    </div>
</div>

<!-- Hidden YouTube Player -->
<div id="player"></div>

<script>

const API_BASE = "https://youtube-0vra.onrender.com";

/* ------------------ SEARCH BOX SYSTEM ------------------ */

document.getElementById("searchBox").addEventListener("input", async function () {
    let q = this.value.trim();

    if (!q) {
        document.getElementById("searchResults").innerHTML = "";
        return;
    }

    document.getElementById("searchResults").innerHTML = "<div>Searching...</div>";

    try {
        const res = await fetch(`${API_BASE}/search/videos?query=${q}&limit=20`);
        const data = await res.json();

        if (!data.results) {
            document.getElementById("searchResults").innerHTML = "<div>No results</div>";
            return;
        }

        renderResults(data.results);
    } catch {
        document.getElementById("searchResults").innerHTML = "<div>Error loading results</div>";
    }
});


function renderResults(list) {
    const box = document.getElementById("searchResults");
    box.innerHTML = "";

    list.forEach(v => {
        const div = document.createElement("div");
        div.style.padding = "12px";
        div.style.borderRadius = "10px";
        div.style.background = "white";
        div.style.marginBottom = "8px";
        div.style.border = "1px solid #ccc";
        div.style.cursor = "pointer";

        div.innerHTML = `
            <b>${v.title}</b><br>
            <small>${v.channel} â€¢ ${v.duration || ""}</small>
        `;

        div.onclick = () => playFromSearch(v);
        box.appendChild(div);
    });
}



/* ------------------ PLAY FROM SEARCH ------------------ */

function playFromSearch(video) {
    const vid = video.videoId;

    musicPlayer.currentSongUrl = `https://www.youtube.com/watch?v=${vid}`;

    document.getElementById("videoThumbnail").src =
        `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;

    document.getElementById("nowPlaying").textContent = "Playing: " + video.title;
    musicPlayer.currentVideoTitle = video.title;

    musicPlayer.player.loadVideoById(vid);
    musicPlayer.player.playVideo();
    musicPlayer.isPlaying = true;
    musicPlayer.updatePlayPauseIcon();

    // Firebase Sync
    musicPlayer.updateState({
        currentSong: musicPlayer.currentSongUrl,
        status: "playing",
        timestamp: 0
    });

    // clear search
    document.getElementById("searchResults").innerHTML = "";
}



/* ---------------- YOUTUBE IFRAME API ---------------- */

if (typeof YT === "undefined") {
    let tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
}

function formatTime(sec) {
    sec = Math.floor(sec);
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m}:${s < 10 ? "0" : ""}${s}`;
}



/* ------------------ MAIN PLAYER OBJECT ------------------ */

var musicPlayer = {
    player: null,
    ytReady: false,
    isPlaying: false,
    isMuted: false,
    isLooping: false,
    currentSongUrl: "",
    firebaseListener: null,

    init: function () {
        document.getElementById("miniPlayer").onclick = () => {
            const p = document.getElementById("fullPlayer");
            p.style.display = p.style.display === "flex" ? "none" : "flex";
        };

        this.setupControls();

        if (typeof YT !== "undefined") {
            this.onYouTubeIframeAPIReady();
        } else {
            window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
        }

        this.setupFirebaseListener();
    },

    onYouTubeIframeAPIReady: function () {
        this.player = new YT.Player("player", {
            videoId: "",
            height: "0",
            width: "0",
            playerVars: {
                controls: 0,
                modestbranding: 1,
                rel: 0,
                playsinline: 1
            },
            events: {
                onReady: () => {
                    this.ytReady = true;
                    this.updateMuteIcon();
                },
                onStateChange: this.onPlayerStateChange.bind(this)
            }
        });
    },

    onPlayerStateChange: function (e) {
        if (e.data === YT.PlayerState.PLAYING) {
            this.isPlaying = true;
        } else if (e.data === YT.PlayerState.PAUSED) {
            this.isPlaying = false;
        } else if (e.data === YT.PlayerState.ENDED && this.isLooping) {
            this.player.seekTo(0);
            this.player.playVideo();
        }
        this.updatePlayPauseIcon();
    },



    /* ------------------ CONTROLS ------------------ */

    setupControls: function () {

        document.getElementById("playPauseBtn").onclick = () => {
            if (!this.player) return;

            if (this.isPlaying) {
                this.player.pauseVideo();
                this.updateState({ status: "paused", timestamp: this.player.getCurrentTime(), currentSong: this.currentSongUrl });
            } else {
                this.player.playVideo();
                this.updateState({ status: "playing", timestamp: this.player.getCurrentTime(), currentSong: this.currentSongUrl });
            }
        };

        document.getElementById("prevBtn").onclick = () => {
            let t = Math.max(0, this.player.getCurrentTime() - 10);
            this.player.seekTo(t);
            this.updateState({ status: "playing", timestamp: t, currentSong: this.currentSongUrl });
        };

        document.getElementById("nextBtn").onclick = () => {
            let t = Math.min(this.player.getDuration(), this.player.getCurrentTime() + 10);
            this.player.seekTo(t);
            this.updateState({ status: "playing", timestamp: t, currentSong: this.currentSongUrl });
        };

        document.getElementById("muteBtn").onclick = () => {
            if (this.player.isMuted()) {
                this.player.unMute();
                this.isMuted = false;
            } else {
                this.player.mute();
                this.isMuted = true;
            }
            this.updateMuteIcon();
        };

        document.getElementById("loopBtn").onclick = () => {
            this.isLooping = !this.isLooping;
            document.getElementById("loopIcon").style.color = this.isLooping ? "#ff5252" : "#333";
        };

        document.getElementById("seekBar").oninput = (e) => {
            let sec = e.target.value;
            this.player.seekTo(sec);
            this.updateState({ status: "playing", timestamp: sec, currentSong: this.currentSongUrl });
        };
    },



    /* ---------------- UI UPDATE ---------------- */

    updatePlayPauseIcon: function () {
        document.getElementById("playPauseIcon").className =
            this.isPlaying ? "fas fa-pause" : "fas fa-play";
    },

    updateMuteIcon: function () {
        document.getElementById("muteIcon").className =
            this.isMuted ? "fas fa-volume-mute" : "fas fa-volume-up";
    },



    /* ---------------- FIREBASE ---------------- */

    setupFirebaseListener: function () {
        if (typeof firebase === "undefined") return;

        firebase.database().ref("music").on("value", snap => {
            const data = snap.val();
            if (!data || !this.ytReady) return;

            const vid = data.currentSong ? data.currentSong.match(/[a-zA-Z0-9_-]{11}/)?.[0] : null;
            if (!vid) return;

            // Load video if changed
            const currentVid = this.player.getVideoData().video_id;
            if (currentVid !== vid) {
                this.currentSongUrl = data.currentSong;

                document.getElementById("videoThumbnail").src =
                    `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;

                document.getElementById("nowPlaying").textContent = "Playing: ...";

                this.player.loadVideoById(vid);
            }

            // Sync time
            this.player.seekTo(data.timestamp || 0);

            // Sync status
            if (data.status === "playing") {
                this.player.playVideo();
                this.isPlaying = true;
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
            }

            this.updatePlayPauseIcon();
        });
    },

    updateState: function (obj) {
        if (typeof firebase === "undefined") return;

        obj.lastUpdate = Date.now();
        firebase.database().ref("music").set(obj);
    }
};



/* ---------------- INIT ---------------- */

musicPlayer.init();

setInterval(() => {
    if (!musicPlayer.player) return;
    document.getElementById("curTime").textContent =
        formatTime(musicPlayer.player.getCurrentTime());
    document.getElementById("duration").textContent =
        formatTime(musicPlayer.player.getDuration());
    document.getElementById("seekBar").max = musicPlayer.player.getDuration();
    document.getElementById("seekBar").value = musicPlayer.player.getCurrentTime();
}, 1000);

</script>
