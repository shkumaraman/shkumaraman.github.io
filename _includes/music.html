  <style>
        :root {
            --primary: #ff5252;
            --primary-dark: #e53935;
            --primary-light: #ff867c;
            --text-dark: #333;
            --text-light: #666;
            --text-lighter: #888;
            --bg-light: #f9f9f9;
            --bg-white: #fff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-heavy: 0 8px 25px rgba(0,0,0,0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* Mini Player */
        #miniPlayer {
            position: fixed;
            bottom: 60px;
            left: 12px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-heavy);
            transition: var(--transition);
            overflow: hidden;
        }
        
        #miniPlayer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            z-index: 1;
        }
        
        #miniPlayer:hover { 
            transform: scale(1.1); 
            box-shadow: 0 10px 30px rgba(255, 82, 82, 0.4);
        }
        
        #miniPlayer i { 
            color: white; 
            font-size: 20px; 
            z-index: 2;
        }

        /* Full Player Screen */
        #fullPlayer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            z-index: 999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 30px 20px;
            overflow-y: auto;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Header */
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 600px;
            margin-bottom: 25px;
        }

        .player-header h3 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .now-playing {
            font-size: 14px;
            color: var(--text-light);
            font-style: italic;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        /* Thumbnail */
        .thumbnail-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            transition: var(--transition);
        }

        .thumbnail-container:hover {
            transform: translateY(-5px);
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        .thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .thumbnail-container:hover .thumbnail-overlay {
            opacity: 1;
        }

        .thumbnail-overlay i {
            color: white;
            font-size: 40px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Search Box */
        .search-container {
            width: 90%;
            max-width: 600px;
            margin-bottom: 20px;
            position: relative;
        }

        #searchBox {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            background: var(--bg-white);
        }

        #searchBox:focus {
            outline: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-lighter);
        }

        /* Search Results */
        #searchResults {
            width: 90%;
            max-width: 600px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border-radius: var(--radius-md);
            background: var(--bg-white);
            box-shadow: var(--shadow);
            padding: 10px;
        }

        #searchResults::-webkit-scrollbar {
            width: 6px;
        }

        #searchResults::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .search-result-item {
            padding: 15px;
            margin: 8px 0;
            background: var(--bg-white);
            border-radius: var(--radius-sm);
            border: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f5f5f5;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .search-result-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-sm);
            margin-right: 15px;
            object-fit: cover;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
            font-size: 15px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-result-channel {
            font-size: 13px;
            color: var(--text-lighter);
        }

        /* Player Controls */
        .player-controls {
            width: 90%;
            max-width: 600px;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-buttons button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: var(--bg-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .control-buttons button:hover {
            transform: scale(1.1);
            background: #eaeaea;
        }

        #playPauseBtn { 
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        #playPauseBtn:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            box-shadow: 0 5px 15px rgba(255, 82, 82, 0.4);
        }

        #playPauseBtn i { 
            color: white; 
            font-size: 20px;
        }

        .active-control {
            background: var(--primary) !important;
        }

        .active-control i {
            color: white !important;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            margin: 20px 0 10px;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .slider-container {
            position: relative;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            cursor: pointer;
        }

        .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, var(--primary-light), var(--primary));
            border-radius: 3px;
            width: 0%;
        }

        .slider-thumb {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        .slider-thumb:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        /* Loading and Error States */
        .loading { 
            display: none; 
            margin: 20px 0; 
            color: var(--text-light);
            text-align: center;
        }

        .loading i {
            margin-right: 10px;
            color: var(--primary);
        }

        .error-message { 
            color: var(--primary); 
            display: none; 
            margin: 20px 0; 
            text-align: center;
            background: rgba(255, 82, 82, 0.1);
            padding: 15px;
            border-radius: var(--radius-md);
        }

        /* Close Button */
        .close-player {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .close-player:hover {
            background: white;
            transform: rotate(90deg);
        }

        /* Hidden YouTube Player */
        #player {
            width: 1px; 
            height: 1px;
            opacity: 0;
            position: absolute;
            left: -9999px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .thumbnail-container {
                width: 180px;
                height: 180px;
            }
            
            .player-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .now-playing {
                max-width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .thumbnail-container {
                width: 150px;
                height: 150px;
            }
            
            .control-buttons {
                gap: 10px;
            }
            
            .control-buttons button {
                width: 45px;
                height: 45px;
            }
            
            #playPauseBtn {
                width: 55px;
                height: 55px;
            }
        }
    </style>

    <!-- Mini Player Button -->
    <div id="miniPlayer">
        <i class="fas fa-music"></i>
    </div>

    <!-- FULL PLAYER -->
    <div id="fullPlayer">
        <div class="close-player">
            <i class="fas fa-times"></i>
        </div>

        <div class="player-header">
            <h3>MusicPlay</h3>
            <div id="nowPlaying" class="now-playing">Not playing</div>
        </div>

        <!-- Thumbnail -->
        <div class="thumbnail-container">
            <img id="videoThumbnail" src="/chat/logo.png" alt="Album Art">
            <div class="thumbnail-overlay">
                <i class="fas fa-play"></i>
            </div>
        </div>

        <!-- SEARCH BOX -->
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input id="searchBox" placeholder="Search songs, artists, albums...">
        </div>

        <!-- SEARCH RESULTS -->
        <div id="searchResults"></div>

        <div class="loading" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        <div class="error-message" id="errorMessage"></div>

        <!-- PLAYER CONTROLS -->
        <div class="player-controls">
            <div class="control-buttons">
                <button id="loopBtn"><i class="fas fa-repeat" id="loopIcon"></i></button>
                <button id="prevBtn"><i class="fas fa-backward-step"></i></button>
                <button id="playPauseBtn"><i class="fas fa-play" id="playPauseIcon"></i></button>
                <button id="nextBtn"><i class="fas fa-forward-step"></i></button>
                <button id="muteBtn"><i class="fas fa-volume-up" id="muteIcon"></i></button>
            </div>

            <div class="progress-container">
                <div class="time-display">
                    <span id="curTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="slider-container" id="seekBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="slider-thumb" id="sliderThumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden YouTube Player -->
    <div id="player"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            // Add your Firebase configuration here
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };

        // Initialize Firebase
        if (firebaseConfig.apiKey !== "your-api-key") {
            firebase.initializeApp(firebaseConfig);
        }

        const API_BASE = "https://youtube-0vra.onrender.com";

        /* ------------------ SEARCH BOX SYSTEM ------------------ */

        document.getElementById("searchBox").addEventListener("input", async function () {
            let q = this.value.trim();

            if (!q) {
                document.getElementById("searchResults").innerHTML = "";
                return;
            }

            document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>Searching...</div>";

            try {
                const res = await fetch(`${API_BASE}/search/videos?query=${q}&limit=20`);
                const data = await res.json();

                if (!data.results) {
                    document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>No results found</div>";
                    return;
                }

                renderResults(data.results);
            } catch {
                document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>Error loading results</div>";
            }
        });

        function renderResults(list) {
            const box = document.getElementById("searchResults");
            box.innerHTML = "";

            list.forEach(v => {
                const div = document.createElement("div");
                div.className = "search-result-item";
                
                const thumbnailUrl = v.thumbnail || `https://img.youtube.com/vi/${v.videoId}/default.jpg`;
                
                div.innerHTML = `
                    <img src="${thumbnailUrl}" class="search-result-thumbnail" alt="Thumbnail">
                    <div class="search-result-info">
                        <div class="search-result-title">${v.title}</div>
                        <div class="search-result-channel">${v.channel} â€¢ ${v.duration || ""}</div>
                    </div>
                `;

                div.onclick = () => playFromSearch(v);
                box.appendChild(div);
            });
        }

        /* ------------------ PLAY FROM SEARCH ------------------ */

        function playFromSearch(video) {
            const vid = video.videoId;

            musicPlayer.currentSongUrl = `https://www.youtube.com/watch?v=${vid}`;

            const thumbnail = document.getElementById("videoThumbnail");
            thumbnail.src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
            
            // Fallback if thumbnail fails to load
            thumbnail.onerror = function() {
                this.src = "/chat/logo.png";
            };

            document.getElementById("nowPlaying").textContent = "Playing: " + video.title;
            musicPlayer.currentVideoTitle = video.title;

            musicPlayer.player.loadVideoById(vid);
            musicPlayer.player.playVideo();
            musicPlayer.isPlaying = true;
            musicPlayer.updatePlayPauseIcon();

            // Firebase Sync
            musicPlayer.updateState({
                currentSong: musicPlayer.currentSongUrl,
                status: "playing",
                timestamp: 0
            });

            // clear search
            document.getElementById("searchResults").innerHTML = "";
            document.getElementById("searchBox").value = "";
        }

        /* ---------------- YOUTUBE IFRAME API ---------------- */

        if (typeof YT === "undefined") {
            let tag = document.createElement("script");
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
        }

        function formatTime(sec) {
            sec = Math.floor(sec);
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}:${s < 10 ? "0" : ""}${s}`;
        }

        /* ------------------ MAIN PLAYER OBJECT ------------------ */

        var musicPlayer = {
            player: null,
            ytReady: false,
            isPlaying: false,
            isMuted: false,
            isLooping: false,
            currentSongUrl: "",
            firebaseListener: null,

            init: function () {
                document.getElementById("miniPlayer").onclick = () => {
                    this.showFullPlayer();
                };

                document.querySelector(".close-player").onclick = () => {
                    this.hideFullPlayer();
                };

                this.setupControls();

                if (typeof YT !== "undefined") {
                    this.onYouTubeIframeAPIReady();
                } else {
                    window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
                }

                this.setupFirebaseListener();
            },

            showFullPlayer: function() {
                const p = document.getElementById("fullPlayer");
                p.style.display = "flex";
                setTimeout(() => {
                    p.style.opacity = "1";
                }, 10);
            },

            hideFullPlayer: function() {
                const p = document.getElementById("fullPlayer");
                p.style.opacity = "0";
                setTimeout(() => {
                    p.style.display = "none";
                }, 300);
            },

            onYouTubeIframeAPIReady: function () {
                this.player = new YT.Player("player", {
                    videoId: "",
                    height: "0",
                    width: "0",
                    playerVars: {
                        controls: 0,
                        modestbranding: 1,
                        rel: 0,
                        playsinline: 1
                    },
                    events: {
                        onReady: () => {
                            this.ytReady = true;
                            this.updateMuteIcon();
                            this.checkSavedState();
                        },
                        onStateChange: this.onPlayerStateChange.bind(this)
                    }
                });
            },

            onPlayerStateChange: function (e) {
                if (e.data === YT.PlayerState.PLAYING) {
                    this.isPlaying = true;
                } else if (e.data === YT.PlayerState.PAUSED) {
                    this.isPlaying = false;
                } else if (e.data === YT.PlayerState.ENDED && this.isLooping) {
                    this.player.seekTo(0);
                    this.player.playVideo();
                }
                this.updatePlayPauseIcon();
            },

            /* ------------------ CONTROLS ------------------ */

            setupControls: function () {
                document.getElementById("playPauseBtn").onclick = () => {
                    if (!this.player) return;

                    if (this.isPlaying) {
                        this.player.pauseVideo();
                        this.updateState({ status: "paused", timestamp: this.player.getCurrentTime(), currentSong: this.currentSongUrl });
                    } else {
                        this.player.playVideo();
                        this.updateState({ status: "playing", timestamp: this.player.getCurrentTime(), currentSong: this.currentSongUrl });
                    }
                };

                document.getElementById("prevBtn").onclick = () => {
                    let t = Math.max(0, this.player.getCurrentTime() - 10);
                    this.player.seekTo(t);
                    this.updateState({ status: "playing", timestamp: t, currentSong: this.currentSongUrl });
                };

                document.getElementById("nextBtn").onclick = () => {
                    let t = Math.min(this.player.getDuration(), this.player.getCurrentTime() + 10);
                    this.player.seekTo(t);
                    this.updateState({ status: "playing", timestamp: t, currentSong: this.currentSongUrl });
                };

                document.getElementById("muteBtn").onclick = () => {
                    if (this.player.isMuted()) {
                        this.player.unMute();
                        this.isMuted = false;
                    } else {
                        this.player.mute();
                        this.isMuted = true;
                    }
                    this.updateMuteIcon();
                };

                document.getElementById("loopBtn").onclick = () => {
                    this.isLooping = !this.isLooping;
                    document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);
                    this.updateState({
                        status: this.isPlaying ? "playing" : "paused",
                        timestamp: Math.floor(this.player.getCurrentTime()),
                        currentSong: this.currentSongUrl,
                        loop: this.isLooping
                    });
                };

                // Custom progress bar
                const seekBarContainer = document.getElementById("seekBarContainer");
                const progressBar = document.getElementById("progressBar");
                const sliderThumb = document.getElementById("sliderThumb");

                let isSeeking = false;

                seekBarContainer.addEventListener("mousedown", (e) => {
                    isSeeking = true;
                    this.handleSeek(e);
                });

                document.addEventListener("mousemove", (e) => {
                    if (isSeeking) {
                        this.handleSeek(e);
                    }
                });

                document.addEventListener("mouseup", () => {
                    isSeeking = false;
                });

                // Touch events for mobile
                seekBarContainer.addEventListener("touchstart", (e) => {
                    isSeeking = true;
                    this.handleSeek(e.touches[0]);
                });

                document.addEventListener("touchmove", (e) => {
                    if (isSeeking) {
                        this.handleSeek(e.touches[0]);
                    }
                });

                document.addEventListener("touchend", () => {
                    isSeeking = false;
                });

                this.handleSeek = (e) => {
                    if (!this.player) return;
                    
                    const rect = seekBarContainer.getBoundingClientRect();
                    const percent = Math.min(Math.max(0, e.clientX - rect.left), rect.width) / rect.width;
                    const duration = this.player.getDuration();
                    const seekTime = percent * duration;
                    
                    this.player.seekTo(seekTime);
                    this.updateState({ status: "playing", timestamp: seekTime, currentSong: this.currentSongUrl });
                };
            },

            /* ---------------- UI UPDATE ---------------- */

            updatePlayPauseIcon: function () {
                document.getElementById("playPauseIcon").className =
                    this.isPlaying ? "fas fa-pause" : "fas fa-play";
            },

            updateMuteIcon: function () {
                document.getElementById("muteIcon").className =
                    this.isMuted ? "fas fa-volume-mute" : "fas fa-volume-up";
                document.getElementById("muteBtn").classList.toggle("active-control", this.isMuted);
            },

            /* ---------------- FIREBASE ---------------- */

            setupFirebaseListener: function () {
                if (!this.firebaseInitialized()) return;
                if (this.firebaseListener) this.firebaseListener();
                
                const stateRef = firebase.database().ref('music');
                this.firebaseListener = stateRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (!data || !this.ytReady) return;

                    const { currentSong, status, timestamp, lastUpdate, loop } = data;
                    if (!currentSong) return;

                    this.isLooping = !!loop;
                    document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);

                    const vid = this.extractYouTubeID(currentSong);
                    if (!vid) return;

                    const now = Date.now();
                    let effectiveTime = timestamp || 0;
                    if (status === 'playing' && lastUpdate) {
                        effectiveTime += Math.floor((now - lastUpdate) / 1000);
                    }

                    const currentVid = this.player ? this.player.getVideoData().video_id : '';
                    if (!currentVid || currentVid !== vid) {
                        this.processNewSong(currentSong, status, effectiveTime);
                    } else {
                        const currentTime = this.player.getCurrentTime();
                        if (Math.abs(currentTime - effectiveTime) > 2) {
                            this.player.seekTo(effectiveTime, true);
                        }
                        if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                            this.player.playVideo();
                            this.isPlaying = true;
                            this.updatePlayPauseIcon();
                        } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                            this.player.pauseVideo();
                            this.isPlaying = false;
                            this.updatePlayPauseIcon();
                        }
                    }
                });
            },

            extractYouTubeID: function(url) {
                if (!url) return null;
                if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
                try {
                    const u = new URL(url);
                    if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
                    if (u.searchParams.get("v")) return u.searchParams.get("v");
                } catch {}
                const m = url.match(/[a-zA-Z0-9_-]{11}/);
                return m ? m[0] : null;
            },

            checkSavedState: function() {
                if (!this.firebaseInitialized()) return;
                const stateRef = firebase.database().ref('music');
                stateRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.currentSong) {
                        const now = Date.now();
                        let effectiveTime = data.timestamp || 0;
                        if (data.status === 'playing' && data.lastUpdate) {
                            effectiveTime += Math.floor((now - data.lastUpdate) / 1000);
                        }
                        this.isLooping = !!data.loop;
                        document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);
                        this.processNewSong(data.currentSong, data.status, effectiveTime);
                    }
                });
            },

            processNewSong: function(url, status, timestamp) {
                const vid = this.extractYouTubeID(url || '');
                if (!vid) return;
                
                this.currentSongUrl = url;
                
                // Set thumbnail
                const thumbnail = document.getElementById("videoThumbnail");
                thumbnail.src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
                
                // Fallback if thumbnail fails to load
                thumbnail.onerror = function() {
                    this.src = "/chat/logo.png";
                };
                
                this.fetchVideoTitle(vid).then(title => {
                    this.currentVideoTitle = title;
                    document.getElementById("nowPlaying").textContent = 'Playing: ' + title;
                }).catch(() => {
                    this.currentVideoTitle = "Unknown Title";
                    document.getElementById("nowPlaying").textContent = 'Playing: ' + url;
                });
                
                this.player.loadVideoById({ videoId: vid, startSeconds: timestamp || 0 });
                if (status === 'playing') {
                    this.player.playVideo();
                    this.isPlaying = true;
                } else {
                    this.player.pauseVideo();
                    this.isPlaying = false;
                }
                this.updatePlayPauseIcon();
            },

            fetchVideoTitle: function(videoId) {
                return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
                    .then(response => response.json())
                    .then(data => data.title);
            },

            updateState: function(obj) {
                if (!this.firebaseInitialized()) return;
                obj.lastUpdate = Date.now();
                if (this.isLooping) obj.loop = true;
                firebase.database().ref('music').set(obj).catch(error => {
                    console.error('Firebase update error:', error);
                });
            },

            firebaseInitialized: function() {
                return typeof firebase !== 'undefined' && firebase.apps.length > 0;
            }
        };

        /* ---------------- INIT ---------------- */

        musicPlayer.init();

        // Update progress bar and time display
        setInterval(() => {
            if (!musicPlayer.player) return;
            
            const currentTime = musicPlayer.player.getCurrentTime();
            const duration = musicPlayer.player.getDuration();
            
            document.getElementById("curTime").textContent = formatTime(currentTime);
            document.getElementById("duration").textContent = formatTime(duration);
            
            // Update progress bar
            if (duration > 0) {
                const progressPercent = (currentTime / duration) * 100;
                document.getElementById("progressBar").style.width = `${progressPercent}%`;
                
                const sliderThumb = document.getElementById("sliderThumb");
                sliderThumb.style.left = `${progressPercent}%`;
            }
        }, 1000);
    </script>
