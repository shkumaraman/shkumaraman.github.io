<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Audio Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Mini floating player */
    #miniPlayer {
      position: fixed;
      bottom: 75px;
      left: 20px;
      width: 45px;
      height: 45px;
      background: #ff5252;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    #miniPlayer:hover {
      transform: scale(1.1);
    }
    #miniPlayer i { 
      color: white; 
      font-size: 18px; 
    }

    /* Fullscreen player overlay */
    #fullPlayer {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #fff;
      z-index: 999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    #fullPlayer h3 { 
      margin-bottom:20px; 
      color: #333;
    }
    #fullPlayer input[type="text"] { 
      width: 80%; 
      padding:12px; 
      margin-bottom:15px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .control-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .control-buttons button {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .control-buttons button:hover {
      background: #e0e0e0;
    }
    .control-buttons button:active {
      transform: scale(0.95);
    }
    .control-buttons button i {
      font-size: 18px;
      color: #333;
    }
    #playPauseBtn {
      background: #ff5252;
    }
    #playPauseBtn i {
      color: white;
    }
    .slider { 
      width: 80%; 
      margin-top: 10px; 
      height: 5px;
      -webkit-appearance: none;
      appearance: none;
      background: #ddd;
      outline: none;
      border-radius: 5px;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #ff5252;
      cursor: pointer;
    }

    #fullPlayer .closeBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #333;
      background: none;
      border: none;
    }

    #fullPlayer .time-display {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }

    #player { 
      width:1px; 
      height:1px; 
      position:absolute; 
      left:-9999px; 
      opacity:0; 
    }
  </style>
</head>
<body>
  <!-- Mini draggable player -->
  <div id="miniPlayer" title="Open Player"><i class="fas fa-music"></i></div>

  <!-- Fullscreen Player -->
  <div id="fullPlayer">
    <button class="closeBtn">&times;</button>
    <h3>YouTube Audio Player</h3>

    <input id="urlInput" placeholder="Paste YouTube URL" />
    <div class="control-buttons">
      <button id="prevBtn" title="Previous">
        <i class="fas fa-backward-step"></i>
      </button>
      <button id="playPauseBtn" title="Play/Pause">
        <i class="fas fa-play"></i>
      </button>
      <button id="nextBtn" title="Next">
        <i class="fas fa-forward-step"></i>
      </button>
    </div>
    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0" step="1">
    <div class="time-display">
      <span id="curTime">0</span>s / <span id="duration">0</span>s
    </div>
  </div>

  <!-- Hidden YouTube player -->
  <div id="player"></div>

  <!-- YouTube IFrame API -->
  <script>
    function extractYouTubeID(url) {
      if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
      try {
        const u = new URL(url);
        if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
        if (u.searchParams.get("v")) return u.searchParams.get("v");
      } catch {}
      const m = url.match(/[a-zA-Z0-9_-]{11}/);
      return m ? m[0] : null;
    }

    let player, ytReady=false;
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height:"1", width:"1", videoId:"",
        playerVars: { controls:0, modestbranding:1, rel:0, playsinline:1 },
        events: { 
          onReady: ()=>{ 
            ytReady=true; 
            console.log("YouTube player ready");
          },
          onStateChange: (e)=>{
            if(e.data === YT.PlayerState.PLAYING){
              try{
                player.setPlaybackQuality("tiny");
              }catch(e){}
              // Update play/pause button icon
              playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else if(e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED){
              // Update play/pause button icon
              playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
          }
        }
      });
    }
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const stateRef = db.ref("music");

    // UI Elements
    const miniPlayer = document.getElementById("miniPlayer");
    const fullPlayer = document.getElementById("fullPlayer");
    const urlInput = document.getElementById("urlInput");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const seekBar = document.getElementById("seekBar");
    const curTimeEl = document.getElementById("curTime");
    const durEl = document.getElementById("duration");
    const closeBtn = document.querySelector(".closeBtn");

    let localChange = false;
    let isPlaying = false;

    // Draggable mini player
    let isDragging = false, offsetX, offsetY;
    miniPlayer.addEventListener("mousedown", e => {
      isDragging = true;
      offsetX = e.clientX - miniPlayer.offsetLeft;
      offsetY = e.clientY - miniPlayer.offsetTop;
      miniPlayer.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if(!isDragging) return;
      miniPlayer.style.left = (e.clientX - offsetX) + "px";
      miniPlayer.style.top = (e.clientY - offsetY) + "px";
      miniPlayer.style.right = "auto";
      miniPlayer.style.bottom = "auto";
    });
    document.addEventListener("mouseup", () => { 
      isDragging = false;
      miniPlayer.style.cursor = "pointer";
    });

    // Open full player
    miniPlayer.addEventListener("click", () => {
      fullPlayer.style.display = "flex";
    });

    // Close full player
    closeBtn.addEventListener("click", () => {
      fullPlayer.style.display = "none";
    });

    // Firebase listener
    stateRef.on("value", (snapshot) => {
      const data = snapshot.val();
      if(!data || !ytReady) return;
      if(localChange){ localChange = false; return; }

      const { currentSong, status, timestamp } = data;
      const vid = extractYouTubeID(currentSong || "");
      if(!vid) return;
      
      const currentVid = player.getVideoData().video_id;
      if(currentVid !== vid){
        player.loadVideoById({videoId: vid, startSeconds: timestamp || 0});
        if(status === "playing") {
          player.playVideo();
          isPlaying = true;
        } else {
          player.pauseVideo();
          isPlaying = false;
        }
      } else {
        player.seekTo(timestamp || 0, true);
        if(status === "playing") {
          player.playVideo();
          isPlaying = true;
        } else {
          player.pauseVideo();
          isPlaying = false;
        }
      }
    });

    function updateState(obj){
      localChange = true;
      stateRef.set(obj);
    }

    // Play/Pause toggle
    playPauseBtn.addEventListener("click", () => {
      const url = urlInput.value.trim();
      const vid = extractYouTubeID(url);
      
      if(!vid) return alert("Please enter a valid YouTube URL");
      if(!ytReady) return alert("Player not ready yet!");
      
      const currentVid = player.getVideoData().video_id;
      let startTime = 0;
      
      if(currentVid === vid) {
        startTime = Math.floor(player.getCurrentTime() || 0);
      }
      
      if(!isPlaying) {
        player.loadVideoById({videoId: vid, startSeconds: startTime});
        player.unMute();
        player.playVideo();
        isPlaying = true;
        updateState({ currentSong: url, status: "playing", timestamp: startTime });
      } else {
        const t = Math.floor(player.getCurrentTime());
        player.pauseVideo();
        isPlaying = false;
        updateState({ status: "paused", timestamp: t, currentSong: url });
      }
    });

    // Skip backward 10 seconds
    prevBtn.addEventListener("click", () => {
      if(!player || !player.getCurrentTime) return;
      const currentTime = player.getCurrentTime();
      const newTime = Math.max(0, currentTime - 10);
      player.seekTo(newTime, true);
      
      const state = player.getPlayerState();
      const playing = (state === YT.PlayerState.PLAYING);
      updateState({ 
        status: playing ? "playing" : "paused", 
        timestamp: newTime, 
        currentSong: urlInput.value.trim() 
      });
    });

    // Skip forward 10 seconds
    nextBtn.addEventListener("click", () => {
      if(!player || !player.getCurrentTime) return;
      const currentTime = player.getCurrentTime();
      const duration = player.getDuration();
      const newTime = Math.min(duration, currentTime + 10);
      player.seekTo(newTime, true);
      
      const state = player.getPlayerState();
      const playing = (state === YT.PlayerState.PLAYING);
      updateState({ 
        status: playing ? "playing" : "paused", 
        timestamp: newTime, 
        currentSong: urlInput.value.trim() 
      });
    });

    // Seek
    seekBar.addEventListener("input", () => {
      if(!player) return;
      const sec = parseInt(seekBar.value, 10);
      player.seekTo(sec, true);
      
      const state = player.getPlayerState();
      const playing = (state === YT.PlayerState.PLAYING);
      updateState({ 
        status: playing ? "playing" : "paused", 
        timestamp: sec, 
        currentSong: urlInput.value.trim() 
      });
    });

    // Update slider and time display
    setInterval(() => {
      if(!player || !player.getCurrentTime) return;
      const t = Math.floor(player.getCurrentTime() || 0);
      const d = Math.floor(player.getDuration() || 0);
      curTimeEl.textContent = t;
      durEl.textContent = d;
      seekBar.max = d;
      seekBar.value = t;
    }, 1000);
  </script>
</body>
  </html>
