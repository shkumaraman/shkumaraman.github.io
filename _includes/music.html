<style>
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 35px;
        height: 35px;
        background: #ff5252;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    #miniPlayer:hover { transform: scale(1.1); }
    #miniPlayer i { color:white; font-size:18px; }

    .square-icon {
        width: 120px; height: 120px;
        background:#ff5252;
        border-radius:20px;
        display:flex; align-items:center; justify-content:center;
        margin:0 auto 25px;
        box-shadow:0 6px 20px rgba(0,0,0,0.2);
        overflow:hidden;
    }
    .square-icon img {
        width:100%; height:100%; border-radius:20px; object-fit:cover;
    }

    #fullPlayer {
        position:fixed; top:0; left:0; right:0; bottom:0;
        background:rgba(255,255,255,0.95);
        z-index:999; display:none; flex-direction:column;
        align-items:center; justify-content:flex-start;
        padding:20px; box-sizing:border-box;
        overflow-y:auto;
    }

    #fullPlayer h3 { margin-bottom:20px; color:#333; font-family:'Arial'; }

    /* Search Box */
    #searchBox {
        width:80%; max-width:500px;
        padding:12px 15px;
        margin-bottom:15px;
        border:2px solid #ddd;
        border-radius:8px;
        font-size:16px;
        box-shadow:0 2px 5px rgba(0,0,0,0.1);
        transition:border-color 0.3s;
    }
    #searchBox:focus {
        outline:none; border-color:#ff5252;
    }

    /* Search Results */
    #searchResults {
        width:80%; max-width:500px;
        max-height:300px; overflow-y:auto;
        margin-bottom:20px;
        border-radius:8px;
        box-shadow:0 2px 10px rgba(0,0,0,0.1);
        background:white;
        display:none;
    }
    .search-result-item {
        padding:12px 15px;
        border-bottom:1px solid #eee;
        cursor:pointer;
        display:flex; align-items:center;
        transition:background 0.2s;
    }
    .search-result-item:hover { background:#f9f9f9; }
    .search-result-item:last-child { border-bottom:none; }
    .search-result-thumbnail {
        width:60px; height:45px;
        border-radius:4px; margin-right:12px;
        object-fit:cover;
    }
    .search-result-info { flex:1; }
    .search-result-title {
        font-weight:bold; font-size:14px;
        margin-bottom:4px; color:#333;
        display:-webkit-box;
        -webkit-line-clamp:2; -webkit-box-orient:vertical;
        overflow:hidden;
    }
    .search-result-channel {
        font-size:12px; color:#666;
    }

    .control-buttons { display:flex; gap:8px; margin-bottom:20px; }
    .control-buttons button {
        width:40px; height:40px; border-radius:10px;
        border:none; background:#f0f0f0; cursor:pointer;
        display:flex; align-items:center; justify-content:center;
        transition:all 0.2s;
    }
    .control-buttons button:hover { background:#e0e0e0; }
    .control-buttons button:active { transform:scale(0.95); }
    .control-buttons button i { font-size:16px; color:#333; }
    #playPauseBtn { background:#ff5252; }
    #playPauseBtn i { color:white; }

    .slider {
        width:80%; max-width:500px; margin:15px 0;
        height:6px; background:#ddd; border-radius:3px;
        -webkit-appearance:none; appearance:none;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance:none; appearance:none;
        width:16px; height:16px; border-radius:50%;
        background:#ff5252; cursor:pointer;
    }

    .time-display { color:#666; font-size:14px; font-family:monospace; }

    #player { width:1px; height:1px; opacity:0; position:absolute; left:-9999px; }

    .player-header {
        display:flex; justify-content:space-between; align-items:center;
        width:80%; max-width:500px; margin-bottom:10px;
    }

    .now-playing { font-size:14px; color:#555; font-style:italic; }

    .error-message { color:#ff5252; display:none; margin-top:10px; }
    .loading { display:none; margin-top:10px; color:#666; }

</style>

<!-- Mini Player -->
<div id="miniPlayer"><i class="fas fa-music"></i></div>

<!-- FULL PLAYER -->
<div id="fullPlayer">

    <div class="player-header">
        <h3>MusicPlay</h3>
        <div id="nowPlaying" class="now-playing">Not playing</div>
    </div>

    <!-- Thumbnail -->
    <div class="square-icon">
        <img id="videoThumbnail" src="">
    </div>

    <!-- SEARCH BOX -->
    <input id="searchBox" placeholder="Search songs...">
    <div id="searchResults"></div>

    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage"></div>

    <div class="control-buttons">
        <button id="loopBtn"><i class="fas fa-repeat" id="loopIcon"></i></button>
        <button id="prevBtn"><i class="fas fa-backward-step"></i></button>
        <button id="playPauseBtn"><i class="fas fa-play" id="playPauseIcon"></i></button>
        <button id="nextBtn"><i class="fas fa-forward-step"></i></button>
        <button id="muteBtn"><i class="fas fa-volume-up" id="muteIcon"></i></button>
    </div>

    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0">

    <div class="time-display">
        <span id="curTime">0:00</span> / <span id="duration">0:00</span>
    </div>
</div>

<!-- Hidden YT Player -->
<div id="player"></div>

<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "your-api-key",
    authDomain: "your-project.firebaseapp.com",
    databaseURL: "https://your-project.firebaseio.com",
    projectId: "your-project",
    storageBucket: "your-project.appspot.com",
    messagingSenderId: "123456789",
    appId: "your-app-id"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

/* ---------------- SEARCH SYSTEM ---------------- */
const API = "https://youtube-0vra.onrender.com";

document.getElementById("searchBox").addEventListener("input", async function () {
    const q = this.value.trim();
    const resultsDiv = document.getElementById("searchResults");
    
    if (!q) {
        resultsDiv.style.display = "none";
        return;
    }

    try {
        const res = await fetch(`${API}/search/videos?query=${q}&limit=10`);
        const data = await res.json();
        
        if (!data.results || data.results.length === 0) {
            resultsDiv.style.display = "none";
            return;
        }

        resultsDiv.innerHTML = "";
        resultsDiv.style.display = "block";

        data.results.forEach(v => {
            const div = document.createElement("div");
            div.className = "search-result-item";
            div.innerHTML = `
                <img src="${v.thumbnail}" class="search-result-thumbnail">
                <div class="search-result-info">
                    <div class="search-result-title">${v.title}</div>
                    <div class="search-result-channel">${v.channel}</div>
                </div>
            `;
            div.onclick = () => playFromSearch(v);
            resultsDiv.appendChild(div);
        });
    } catch (error) {
        console.error("Search error:", error);
        resultsDiv.style.display = "none";
    }
});

/* ----------- PLAY FROM SEARCH ----------- */
function playFromSearch(v) {
    const vid = v.videoId;
    const searchBox = document.getElementById("searchBox");
    const resultsDiv = document.getElementById("searchResults");

    musicPlayer.currentSongUrl = `https://www.youtube.com/watch?v=${vid}`;
    document.getElementById("videoThumbnail").src = v.thumbnail;
    document.getElementById("nowPlaying").textContent = "Playing: " + v.title;

    // Hide search results
    resultsDiv.style.display = "none";
    searchBox.value = v.title;

    // Play the video
    if (musicPlayer.ytReady) {
        musicPlayer.player.loadVideoById(vid);
        musicPlayer.player.playVideo();
        musicPlayer.isPlaying = true;
        musicPlayer.updatePlayPauseIcon();

        musicPlayer.updateState({
            currentSong: musicPlayer.currentSongUrl,
            status: "playing",
            timestamp: 0
        });
    }
}

/* ---------------- PLAYER SYSTEM ---------------- */
if (typeof YT === 'undefined') {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

function extractYouTubeID(url) {
    if (!url) return null;
    if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    try {
        const u = new URL(url);
        if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
        if (u.searchParams.get("v")) return u.searchParams.get("v");
    } catch {}
    const m = url.match(/[a-zA-Z0-9_-]{11}/);
    return m ? m[0] : null;
}

function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

var musicPlayer = {
    player: null,
    ytReady: false,
    isPlaying: false,
    isMuted: false,
    isLooping: false,
    currentSongUrl: "",
    firebaseListener: null,
    currentVideoTitle: "",

    init: function() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', this.setupPlayer.bind(this));
        } else {
            this.setupPlayer();
        }
    },
    
    setupPlayer: function() {
        if (typeof firebase === 'undefined') {
            console.error("Firebase not loaded");
            return;
        }
        
        this.setupEventListeners();
        this.setupFirebaseListener();
        
        if (typeof YT !== 'undefined' && YT.loaded) {
            this.onYouTubeIframeAPIReady();
        } else {
            window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
        }
    },
    
    setupEventListeners: function() {
        const miniPlayer = document.getElementById('miniPlayer');
        const fullPlayer = document.getElementById('fullPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const muteBtn = document.getElementById('muteBtn');
        const seekBar = document.getElementById('seekBar');
        const loopBtn = document.getElementById('loopBtn');
        
        miniPlayer.addEventListener('click', () => {
            fullPlayer.style.display = fullPlayer.style.display === 'flex' ? 'none' : 'flex';
        });
            
        playPauseBtn.addEventListener('click', this.handlePlayPause.bind(this));
        prevBtn.addEventListener('click', this.handlePrev.bind(this));
        nextBtn.addEventListener('click', this.handleNext.bind(this));
        muteBtn.addEventListener('click', this.handleMute.bind(this));
        seekBar.addEventListener('input', this.handleSeek.bind(this));
        loopBtn.addEventListener('click', this.handleLoop.bind(this));
    },
    
    setupFirebaseListener: function() {
        if (!this.firebaseInitialized()) return;
        if (this.firebaseListener) this.firebaseListener();
        
        const stateRef = firebase.database().ref('music');
        this.firebaseListener = stateRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !this.ytReady) return;

            const { currentSong, status, timestamp, lastUpdate, loop } = data;
            if (!currentSong) return;

            this.isLooping = !!loop;
            this.updateLoopIcon();

            const vid = extractYouTubeID(currentSong);
            if (!vid) return;

            const now = Date.now();
            let effectiveTime = timestamp || 0;
            if (status === 'playing' && lastUpdate) {
                effectiveTime += Math.floor((now - lastUpdate) / 1000);
            }

            const currentVid = this.player ? this.player.getVideoData().video_id : '';
            if (!currentVid || currentVid !== vid) {
                this.processNewSong(currentSong, status, effectiveTime);
            } else {
                const currentTime = this.player.getCurrentTime();
                if (Math.abs(currentTime - effectiveTime) > 2) {
                    this.player.seekTo(effectiveTime, true);
                }
                if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                    this.player.playVideo();
                    this.isPlaying = true;
                    this.updatePlayPauseIcon();
                } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                    this.player.pauseVideo();
                    this.isPlaying = false;
                    this.updatePlayPauseIcon();
                }
            }
        });
    },
    
    onYouTubeIframeAPIReady: function() {
        if (this.player) return;
        
        this.player = new YT.Player('player', {
            height: '0', 
            width: '0', 
            videoId: '',
            playerVars: { controls: 0, modestbranding: 1, rel: 0, playsinline: 1 },
            events: { 
                onReady: () => { 
                    this.ytReady = true; 
                    this.checkSavedState(); 
                    this.isMuted = this.player.isMuted();
                    this.updateMuteIcon();
                },
                onError: this.onPlayerError.bind(this),
                onStateChange: this.onPlayerStateChange.bind(this)
            }
        });
    },
    
    onPlayerStateChange: function(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            this.isPlaying = true;
            this.updatePlayPauseIcon();
        } else if (event.data === YT.PlayerState.PAUSED) {
            this.isPlaying = false;
            this.updatePlayPauseIcon();
        } else if (event.data === YT.PlayerState.ENDED && this.isLooping) {
            this.player.seekTo(0, true);
            this.player.playVideo();
        }
    },
    
    updatePlayPauseIcon: function() {
        const icon = document.getElementById('playPauseIcon');
        if (this.isPlaying) {
            icon.className = 'fas fa-pause';
        } else {
            icon.className = 'fas fa-play';
        }
    },
    
    updateMuteIcon: function() {
        const icon = document.getElementById('muteIcon');
        const muteBtn = document.getElementById('muteBtn');
        if (this.isMuted) {
            icon.className = 'fas fa-volume-mute';
            muteBtn.classList.add('muted');
        } else {
            icon.className = 'fas fa-volume-up';
            muteBtn.classList.remove('muted');
        }
    },

    updateLoopIcon: function() {
        const icon = document.getElementById('loopIcon');
        if (this.isLooping) {
            icon.style.color = '#ff5252';
        } else {
            icon.style.color = '#333';
        }
    },
    
    onPlayerError: function(e) {
        const errorMessage = document.getElementById('errorMessage');
        switch(e.data) {
            case 2: errorMessage.textContent = "Invalid video ID."; break;
            case 5: errorMessage.textContent = "HTML5 player error."; break;
            case 100: errorMessage.textContent = "Video not found."; break;
            case 101:
            case 150: errorMessage.textContent = "Video cannot be embedded."; break;
            default: errorMessage.textContent = "Playback error.";
        }
        errorMessage.style.display = 'block';
        document.getElementById('loadingIndicator').style.display = 'none';
    },
    
    checkSavedState: function() {
        if (!this.firebaseInitialized()) return;
        const stateRef = firebase.database().ref('music');
        stateRef.once('value').then((snapshot) => {
            const data = snapshot.val();
            if (data && data.currentSong) {
                const now = Date.now();
                let effectiveTime = data.timestamp || 0;
                if (data.status === 'playing' && data.lastUpdate) {
                    effectiveTime += Math.floor((now - data.lastUpdate) / 1000);
                }
                this.isLooping = !!data.loop;
                this.updateLoopIcon();
                this.processNewSong(data.currentSong, data.status, effectiveTime);
            }
        });
    },
    
    processNewSong: function(url, status, timestamp) {
        const vid = extractYouTubeID(url || '');
        if (!vid) return;
        
        this.currentSongUrl = url;
        
        // Set thumbnail
        document.getElementById('videoThumbnail').src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
        
        this.fetchVideoTitle(vid).then(title => {
            this.currentVideoTitle = title;
            document.getElementById('nowPlaying').textContent = 'Playing: ' + title;
        }).catch(() => {
            this.currentVideoTitle = "Unknown Title";
            document.getElementById('nowPlaying').textContent = 'Playing: ' + url;
        });
        
        this.player.loadVideoById({ videoId: vid, startSeconds: timestamp || 0 });
        if (status === 'playing') {
            this.player.playVideo();
            this.isPlaying = true;
        } else {
            this.player.pauseVideo();
            this.isPlaying = false;
        }
        this.updatePlayPauseIcon();
    },
    
    fetchVideoTitle: function(videoId) {
        return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
            .then(response => response.json())
            .then(data => data.title);
    },
    
    updateState: function(obj) {
        if (!this.firebaseInitialized()) return;
        obj.lastUpdate = Date.now();
        if (this.isLooping) obj.loop = true;
        firebase.database().ref('music').set(obj).catch(error => {
            console.error('Firebase update error:', error);
        });
    },
    
    handlePlayPause: function() {
        if (!this.ytReady) return alert('Player not ready yet!');
        
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('loadingIndicator').style.display = 'block';
        
        const currentVid = this.player.getVideoData().video_id;
        let startTime = Math.floor(this.player.getCurrentTime() || 0);
        
        if (!currentVid) {
            document.getElementById('loadingIndicator').style.display = 'none';
            return alert('Please search and select a song first!');
        } else {
            if (!this.isPlaying) {
                this.player.playVideo();
                this.isPlaying = true;
                this.updateState({ currentSong: this.currentSongUrl, status: 'playing', timestamp: startTime });
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
                this.updateState({ currentSong: this.currentSongUrl, status: 'paused', timestamp: startTime });
            }
            this.updatePlayPauseIcon();
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    },
    
    handleMute: function() {
        if (!this.player) return;
        if (this.player.isMuted()) {
            this.player.unMute();
            this.isMuted = false;
        } else {
            this.player.mute();
            this.isMuted = true;
        }
        this.updateMuteIcon();
    },
    
    handlePrev: function() {
        if (!this.player) return;
        const newTime = Math.max(0, this.player.getCurrentTime() - 10);
        this.player.seekTo(newTime, true);
        this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: newTime, currentSong: this.currentSongUrl });
    },
    
    handleNext: function() {
        if (!this.player) return;
        const currentTime = this.player.getCurrentTime();
        const duration = this.player.getDuration();
        const newTime = Math.min(duration, currentTime + 10);
        this.player.seekTo(newTime, true);
        this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: newTime, currentSong: this.currentSongUrl });
    },
    
    handleSeek: function() {
        if (!this.player) return;
        const sec = parseInt(document.getElementById('seekBar').value, 10);
        this.player.seekTo(sec, true);
        this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: sec, currentSong: this.currentSongUrl });
    },

    handleLoop: function() {
        this.isLooping = !this.isLooping;
        this.updateLoopIcon();
        this.updateState({
            status: this.isPlaying ? 'playing' : 'paused',
            timestamp: Math.floor(this.player.getCurrentTime()),
            currentSong: this.currentSongUrl,
            loop: this.isLooping
        });
    },
    
    updatePlayerUI: function() {
        if (!this.player) return;
        const t = Math.floor(this.player.getCurrentTime() || 0);
        const d = Math.floor(this.player.getDuration() || 0);
        document.getElementById('curTime').textContent = formatTime(t);
        document.getElementById('duration').textContent = formatTime(d);
        const seekBar = document.getElementById('seekBar');
        if (!seekBar.matches(':active')) {
            seekBar.max = d;
            seekBar.value = t;
        }
    },
    
    firebaseInitialized: function() {
        return typeof firebase !== 'undefined' && firebase.apps.length > 0;
    }
};

musicPlayer.init();

setInterval(() => {
    if (musicPlayer.player) {
        musicPlayer.updatePlayerUI();
    }
}, 1000);
</script>
