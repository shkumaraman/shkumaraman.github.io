<style>
    :root {
        --primary: #ff5252;
        --primary-dark: #e53935;
        --primary-light: #ff867c;
        --text-dark: #333;
        --text-light: #666;
        --text-lighter: #888;
        --bg-light: #f9f9f9;
        --bg-white: #fff;
        --shadow: 0 4px 12px rgba(0,0,0,0.1);
        --shadow-heavy: 0 8px 25px rgba(0,0,0,0.15);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: var(--bg-light);
        color: var(--text-dark);
    }

    /* Mini Player */
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: var(--shadow-heavy);
        transition: var(--transition);
        overflow: hidden;
    }
    
    #miniPlayer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
        z-index: 1;
    }
    
    #miniPlayer:hover { 
        transform: scale(1.1); 
        box-shadow: 0 10px 30px rgba(255, 82, 82, 0.4);
    }
    
    #miniPlayer i { 
        color: white; 
        font-size: 18px; /* Adjusted for smaller size */
        z-index: 2;
    }

    /* Full Player Screen */
    #fullPlayer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        z-index: 999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 60px 0 10px 0;
        overflow-y: auto;
        box-sizing: border-box;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Header */
    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 90%;
        max-width: 600px;
        margin-bottom: 25px;
    }

    .now-playing {
        font-size: 14px;
        color: var(--text-light);
        font-style: italic;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        background: rgba(255, 255, 255, 0.7);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: var(--shadow);
    }

    /* Thumbnail */
    .thumbnail-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 30px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-heavy);
        overflow: hidden;
        transition: var(--transition);
    }

    .thumbnail-container:hover {
        transform: translateY(-5px);
    }

    .thumbnail-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-lg);
    }

    /* Search Box */
    .search-container {
        width: 90%;
        max-width: 600px;
        margin-bottom: 20px;
        position: relative;
    }

    #searchBox {
        width: 100%;
        padding: 10px 20px 10px 50px;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        box-shadow: var(--shadow);
        transition: var(--transition);
        background: var(--bg-white);
    }

    #searchBox:focus {
        outline: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-lighter);
    }

    /* Search Results */
    #searchResults {
        width: 90%;
        max-width: 600px;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
        border-radius: var(--radius-md);
        background: var(--bg-white);
        box-shadow: var(--shadow);
        padding: 10px;
    }

    #searchResults::-webkit-scrollbar {
        width: 6px;
    }

    #searchResults::-webkit-scrollbar-thumb {
        background: var(--primary-light);
        border-radius: 10px;
    }

    .search-result-item {
        padding: 15px;
        margin: 8px 0;
        background: var(--bg-white);
        border-radius: var(--radius-sm);
        border: 1px solid #eee;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
    }

    .search-result-item:hover {
        background: #f5f5f5;
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }

    .search-result-thumbnail {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-sm);
        margin-right: 15px;
        object-fit: cover;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-dark);
        font-size: 15px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-result-channel {
        font-size: 13px;
        color: var(--text-lighter);
    }

    /* Player Controls */
    .player-controls {
        width: 90%;
        max-width: 600px;
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }

    .control-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 10px 0;
    }

    .control-buttons button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--bg-light);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .control-buttons button:hover {
        transform: scale(1.1);
        background: #eaeaea;
    }

    #playPauseBtn { 
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    #playPauseBtn:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        box-shadow: 0 5px 15px rgba(255, 82, 82, 0.4);
    }

    #playPauseBtn i { 
        color: white; 
        font-size: 20px;
    }

    .active-control {
        background: var(--primary) !important;
    }

    .active-control i {
        color: white !important;
    }

    /* Progress Bar */
    .progress-container {
        width: 100%;
        margin: 20px 0 10px;
    }

    .time-display {
        display: flex;
        justify-content: space-between;
        color: var(--text-light);
        font-size: 14px;
        margin-bottom: 8px;
    }

    .slider-container {
        position: relative;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        cursor: pointer;
    }

    .progress-bar {
        position: absolute;
        height: 100%;
        background: linear-gradient(to right, var(--primary-light), var(--primary));
        border-radius: 3px;
        width: 0%;
    }

    .slider-thumb {
        position: absolute;
        width: 16px;
        height: 16px;
        background: var(--primary);
        border-radius: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: var(--transition);
    }

    .slider-thumb:hover {
        transform: translate(-50%, -50%) scale(1.2);
    }

    /* Loading and Error States */
    .loading { 
        display: none; 
        margin: 20px 0; 
        color: var(--text-light);
        text-align: center;
    }

    .loading i {
        margin-right: 10px;
        color: var(--primary);
    }

    .error-message { 
        color: var(--primary); 
        display: none; 
        margin: 20px 0; 
        text-align: center;
        background: rgba(255, 82, 82, 0.1);
        padding: 15px;
        border-radius: var(--radius-md);
    }

    /* Removed close-player styles */

    /* Hidden YouTube Player */
    #player {
        width: 1px; 
        height: 1px;
        opacity: 0;
        position: absolute;
        left: -9999px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .thumbnail-container {
            width: 100px;
            height: 100px;
        }
        
        .player-header {
            flex-direction: column;
            gap: 15px;
        }
        
        .now-playing {
            max-width: 100%;
            text-align: center;
        }
    }
</style>

<!-- Mini Player Button -->
<div id="miniPlayer">
    <i class="fas fa-music"></i>
</div>

<!-- FULL PLAYER -->
<div id="fullPlayer">
    <!-- Removed close button -->

    <div class="player-header">
        <div id="nowPlaying" class="now-playing">Not playing</div>
    </div>

    <!-- Thumbnail -->
    <div class="thumbnail-container">
        <img id="videoThumbnail" src="/chat/logo.png" alt="Album Art">
        <!-- Removed thumbnail overlay -->
    </div>

    <!-- SEARCH BOX -->
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input id="searchBox" placeholder="Search songs, artists, albums...">
    </div>

    <!-- SEARCH RESULTS -->
    <div id="searchResults"></div>

    <div class="loading" id="loadingIndicator">
        <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
    <div class="error-message" id="errorMessage"></div>

    <!-- PLAYER CONTROLS -->
    <div class="player-controls">
        <div class="control-buttons">
            <button id="loopBtn"><i class="fas fa-repeat" id="loopIcon"></i></button>
            <button id="prevBtn"><i class="fas fa-backward-step"></i></button>
            <button id="playPauseBtn"><i class="fas fa-play" id="playPauseIcon"></i></button>
            <button id="nextBtn"><i class="fas fa-forward-step"></i></button>
            <button id="muteBtn"><i class="fas fa-volume-up" id="muteIcon"></i></button>
        </div>

        <div class="progress-container">
            <div class="time-display">
                <span id="curTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="slider-container" id="seekBarContainer">
                <div class="progress-bar" id="progressBar"></div>
                <div class="slider-thumb" id="sliderThumb"></div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden YouTube Player -->
<div id="player"></div>

<script>
    const API_BASE = "https://youtube-0vra.onrender.com";

    document.getElementById("searchBox").addEventListener("input", async function () {
        let q = this.value.trim();
        if (!q) {
            document.getElementById("searchResults").innerHTML = "";
            return;
        }

        document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>Searching...</div>";

        try {
            const res = await fetch(`${API_BASE}/search/videos?query=${q}&limit=20`);
            const data = await res.json();

            if (!data.results) {
                document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>No results found</div>";
                return;
            }

            renderResults(data.results);
        } catch {
            document.getElementById("searchResults").innerHTML = "<div class='search-result-item'>Error loading results</div>";
        }
    });

    function renderResults(list) {
        const box = document.getElementById("searchResults");
        box.innerHTML = "";

        list.forEach(v => {
            const div = document.createElement("div");
            div.className = "search-result-item";
            const thumb = v.thumbnail || `https://img.youtube.com/vi/${v.videoId}/default.jpg`;

            div.innerHTML = `
                <img src="${thumb}" class="search-result-thumbnail">
                <div class="search-result-info">
                    <div class="search-result-title">${v.title}</div>
                    <div class="search-result-channel">${v.channel} â€¢ ${v.duration || ""}</div>
                </div>
            `;

            div.onclick = () => playFromSearch(v);
            box.appendChild(div);
        });
    }

    function playFromSearch(video) {
        const vid = video.videoId;
        
        // Update Firebase directly instead of local state
        musicPlayer.updateState({
            currentVideoId: vid,
            status: "playing",
            timestamp: 0,
            title: video.title,
            thumbnail: `https://img.youtube.com/vi/${vid}/hqdefault.jpg`
        });

        document.getElementById("searchResults").innerHTML = "";
        document.getElementById("searchBox").value = "";
    }

    if (typeof YT === "undefined") {
        let tag = document.createElement("script");
        tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);
    }

    function formatTime(sec) {
        sec = Math.floor(sec);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s < 10 ? "0" : ""}${s}`;
    }

    var musicPlayer = {
        player: null,
        ytReady: false,
        isPlaying: false,
        isMuted: false,
        isLooping: false,
        currentVideoId: "",
        firebaseListener: null,
        isFullScreen: false,
        lastFirebaseUpdate: 0,
        syncInterval: null,

        init: function () {
            document.getElementById("miniPlayer").onclick = () => this.toggleFullPlayer();
            this.setupControls();

            if (typeof YT !== "undefined") {
                this.onYouTubeIframeAPIReady();
            } else {
                window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
            }

            this.setupFirebaseListener();
            this.startSyncInterval();
        },

        startSyncInterval: function() {
            // Sync with Firebase every second
            this.syncInterval = setInterval(() => {
                this.syncWithFirebase();
            }, 1000);
        },

        syncWithFirebase: function() {
            if (!this.firebaseInitialized() || !this.ytReady || !this.player) return;
            
            const currentTime = this.player.getCurrentTime();
            const currentState = this.player.getPlayerState();
            
            // Only update if we're the ones controlling or if significant time difference
            if (this.shouldUpdateFirebase(currentTime, currentState)) {
                this.updateState({
                    currentVideoId: this.currentVideoId,
                    status: currentState === YT.PlayerState.PLAYING ? "playing" : "paused",
                    timestamp: Math.floor(currentTime),
                    title: this.currentVideoTitle,
                    lastUpdate: Date.now()
                });
            }
        },

        shouldUpdateFirebase: function(currentTime, currentState) {
            const now = Date.now();
            // Update if we're playing and it's been more than 2 seconds since last update
            // or if state changed
            if (currentState === YT.PlayerState.PLAYING && 
                (now - this.lastFirebaseUpdate > 2000)) {
                return true;
            }
            
            // Update on state changes
            const shouldPlay = currentState === YT.PlayerState.PLAYING;
            if (shouldPlay !== this.isPlaying) {
                return true;
            }
            
            return false;
        },

        toggleFullPlayer() {
            const p = document.getElementById("fullPlayer");
            if (this.isFullScreen) {
                p.style.opacity = "0";
                setTimeout(() => {
                    p.style.display = "none";
                    this.isFullScreen = false;
                }, 300);
            } else {
                p.style.display = "flex";
                setTimeout(() => (p.style.opacity = "1"), 10);
                this.isFullScreen = true;
            }
        },

        onYouTubeIframeAPIReady: function () {
            this.player = new YT.Player("player", {
                videoId: "",
                height: "0",
                width: "0",
                playerVars: {
                    controls: 0,
                    modestbranding: 1,
                    rel: 0,
                    playsinline: 1
                },
                events: {
                    onReady: () => {
                        this.ytReady = true;
                        this.updateMuteIcon();
                        this.checkSavedState();
                    },
                    onStateChange: this.onPlayerStateChange.bind(this)
                }
            });
        },

        onPlayerStateChange(e) {
            const oldState = this.isPlaying;
            this.isPlaying = e.data === YT.PlayerState.PLAYING;
            
            // Immediately sync state change to Firebase
            if (this.firebaseInitialized() && this.currentVideoId) {
                this.updateState({
                    currentVideoId: this.currentVideoId,
                    status: this.isPlaying ? "playing" : "paused",
                    timestamp: Math.floor(this.player.getCurrentTime()),
                    title: this.currentVideoTitle,
                    lastUpdate: Date.now()
                });
            }

            if (e.data === YT.PlayerState.ENDED && this.isLooping) {
                this.player.seekTo(0);
                this.player.playVideo();
            }

            this.updatePlayPauseIcon();
        },

        setupControls() {
            document.getElementById("playPauseBtn").onclick = () => {
                if (!this.player) return;

                if (this.isPlaying) {
                    this.player.pauseVideo();
                    // Firebase update will happen automatically in onPlayerStateChange
                } else {
                    this.player.playVideo();
                    // Firebase update will happen automatically in onPlayerStateChange
                }
            };

            document.getElementById("prevBtn").onclick = () => {
                let t = Math.max(0, this.player.getCurrentTime() - 10);
                this.player.seekTo(t);
                this.updateState({
                    status: this.isPlaying ? "playing" : "paused",
                    timestamp: t,
                    currentVideoId: this.currentVideoId,
                    title: this.currentVideoTitle,
                    lastUpdate: Date.now()
                });
            };

            document.getElementById("nextBtn").onclick = () => {
                let t = Math.min(this.player.getDuration(), this.player.getCurrentTime() + 10);
                this.player.seekTo(t);
                this.updateState({
                    status: this.isPlaying ? "playing" : "paused",
                    timestamp: t,
                    currentVideoId: this.currentVideoId,
                    title: this.currentVideoTitle,
                    lastUpdate: Date.now()
                });
            };

            document.getElementById("muteBtn").onclick = () => {
                if (this.player.isMuted()) {
                    this.player.unMute();
                    this.isMuted = false;
                } else {
                    this.player.mute();
                    this.isMuted = true;
                }
                this.updateMuteIcon();
            };

            document.getElementById("loopBtn").onclick = () => {
                this.isLooping = !this.isLooping;
                document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);
                this.updateState({
                    status: this.isPlaying ? "playing" : "paused",
                    timestamp: Math.floor(this.player.getCurrentTime()),
                    currentVideoId: this.currentVideoId,
                    title: this.currentVideoTitle,
                    loop: this.isLooping,
                    lastUpdate: Date.now()
                });
            };

            const bar = document.getElementById("seekBarContainer");
            let isSeeking = false;

            bar.addEventListener("mousedown", e => {
                isSeeking = true;
                this.seekToEvent(e);
            });

            document.addEventListener("mousemove", e => {
                if (isSeeking) this.seekToEvent(e);
            });

            document.addEventListener("mouseup", () => {
                if (isSeeking) {
                    isSeeking = false;
                    // Update Firebase after seeking
                    this.updateState({
                        status: this.isPlaying ? "playing" : "paused",
                        timestamp: Math.floor(this.player.getCurrentTime()),
                        currentVideoId: this.currentVideoId,
                        title: this.currentVideoTitle,
                        lastUpdate: Date.now()
                    });
                }
            });

            bar.addEventListener("touchstart", e => {
                isSeeking = true;
                this.seekToEvent(e.touches[0]);
            });

            document.addEventListener("touchmove", e => {
                if (isSeeking) this.seekToEvent(e.touches[0]);
            });

            document.addEventListener("touchend", () => {
                if (isSeeking) {
                    isSeeking = false;
                    // Update Firebase after seeking
                    this.updateState({
                        status: this.isPlaying ? "playing" : "paused",
                        timestamp: Math.floor(this.player.getCurrentTime()),
                        currentVideoId: this.currentVideoId,
                        title: this.currentVideoTitle,
                        lastUpdate: Date.now()
                    });
                }
            });

            this.seekToEvent = e => {
                if (!this.player) return;
                const rect = bar.getBoundingClientRect();
                const percent = Math.min(Math.max(0, e.clientX - rect.left), rect.width) / rect.width;
                const seekTime = percent * this.player.getDuration();
                this.player.seekTo(seekTime);
            };
        },

        updatePlayPauseIcon() {
            document.getElementById("playPauseIcon").className =
                this.isPlaying ? "fas fa-pause" : "fas fa-play";
        },

        updateMuteIcon() {
            document.getElementById("muteIcon").className =
                this.isMuted ? "fas fa-volume-mute" : "fas fa-volume-up";
            document.getElementById("muteBtn").classList.toggle("active-control", this.isMuted);
        },

        firebaseInitialized() {
            return typeof firebase !== "undefined" && firebase.apps.length > 0;
        },

        setupFirebaseListener() {
            if (!this.firebaseInitialized()) return;
            if (this.firebaseListener) this.firebaseListener();

            const ref = firebase.database().ref("music");

            this.firebaseListener = ref.on("value", snap => {
                const data = snap.val();
                if (!data || !this.ytReady) return;

                const { currentVideoId, status, timestamp, lastUpdate, loop, title } = data;
                if (!currentVideoId) return;

                this.isLooping = !!loop;
                document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);

                const now = Date.now();
                let effectiveTime = timestamp || 0;

                if (status === "playing" && lastUpdate) {
                    effectiveTime += Math.floor((now - lastUpdate) / 1000);
                }

                const currentVid = this.player?.getVideoData().video_id;

                if (!currentVid || currentVid !== currentVideoId) {
                    this.processNewSong(currentVideoId, status, effectiveTime, title);
                } else {
                    const ct = this.player.getCurrentTime();
                    if (Math.abs(ct - effectiveTime) > 2) {
                        this.player.seekTo(effectiveTime, true);
                    }

                    if (status === "playing") {
                        if (this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                            this.player.playVideo();
                        }
                    } else {
                        if (this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                            this.player.pauseVideo();
                        }
                    }

                    this.isPlaying = status === "playing";
                    this.updatePlayPauseIcon();
                }
            });
        },

        checkSavedState() {
            if (!this.firebaseInitialized()) return;

            firebase
                .database()
                .ref("music")
                .once("value")
                .then(snap => {
                    const data = snap.val();
                    if (!data || !data.currentVideoId) return;

                    const now = Date.now();
                    let effective = data.timestamp || 0;

                    if (data.status === "playing" && data.lastUpdate) {
                        effective += Math.floor((now - data.lastUpdate) / 1000);
                    }

                    this.isLooping = !!data.loop;
                    document.getElementById("loopBtn").classList.toggle("active-control", this.isLooping);

                    this.processNewSong(data.currentVideoId, data.status, effective, data.title);
                });
        },

        processNewSong(videoId, status, timestamp, title) {
            this.currentVideoId = videoId;
            this.currentVideoTitle = title || "Unknown Title";

            const thumbnail = document.getElementById("videoThumbnail");
            thumbnail.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            thumbnail.onerror = () => (thumbnail.src = "/chat/logo.png");

            document.getElementById("nowPlaying").textContent = "Playing: " + this.currentVideoTitle;

            // Only load new video if it's different from current
            const currentVid = this.player?.getVideoData().video_id;
            if (currentVid !== videoId) {
                this.player.loadVideoById({ videoId: videoId, startSeconds: timestamp });
            } else {
                this.player.seekTo(timestamp, true);
            }
            
            if (status === "playing") {
                this.player.playVideo();
            } else {
                this.player.pauseVideo();
            }

            this.isPlaying = status === "playing";
            this.updatePlayPauseIcon();
        },

        updateState(obj) {
            if (!this.firebaseInitialized()) return;

            obj.lastUpdate = Date.now();
            if (this.isLooping) obj.loop = true;
            
            this.lastFirebaseUpdate = Date.now();

            firebase
                .database()
                .ref("music")
                .set(obj)
                .catch(err => console.error(err));
        }
    };

    musicPlayer.init();

    setInterval(() => {
        if (!musicPlayer.player) return;

        const ct = musicPlayer.player.getCurrentTime();
        const dur = musicPlayer.player.getDuration();

        document.getElementById("curTime").textContent = formatTime(ct);
        document.getElementById("duration").textContent = formatTime(dur);

        if (dur > 0) {
            const percent = (ct / dur) * 100;
            document.getElementById("progressBar").style.width = percent + "%";
            document.getElementById("sliderThumb").style.left = percent + "%";
        }
    }, 1000);
</script>
