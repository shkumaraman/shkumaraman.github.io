<style>
    :root {
        --light-bg: #f5f5f5;
        --dark-bg: #121212;
    }
    
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 35px;
        height: 35px;
        background: #ff5252;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    #miniPlayer:hover {
        transform: scale(1.1);
    }
    #miniPlayer i { 
        color: white; 
        font-size: 18px; 
    }

    .square-icon {
        width: 120px;
        height: 120px;
        background: #ff5252;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .square-icon img {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        object-fit: cover;
    }

    #fullPlayer {
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: var(--dark-bg);
        z-index: 999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .light-mode #fullPlayer {
        background: var(--light-bg);
    }

    #fullPlayer h3 { 
        margin-bottom:20px; 
        color: #ff5252;
    }
    
    .search-container {
        width: 90%;
        max-width: 550px;
        position: relative;
        margin-bottom: 20px;
    }
    
    #searchInput { 
        width: 100%;
        padding:12px 45px 12px 15px; 
        border: 2px solid #ccc;
        border-radius: 10px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: border-color 0.3s;
        box-sizing: border-box;
    }
    #searchInput:focus {
        outline: none;
        border-color: #ff5252;
    }
    
    #searchBtn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: #ff5252;
        border: none;
        border-radius: 10px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    
    #searchBtn:hover {
        background: #ff0000;
    }
    
    #searchBtn i {
        color: white;
        font-size: 14px;
    }
    
    #searchResults {
        width: 90%;
        max-width: 550px;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1001;
        margin-top: 5px;
    }
    
    .search-result-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    
    .search-result-item:hover {
        background: #f5f5f5;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .result-thumbnail {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        margin-right: 12px;
        object-fit: cover;
    }
    
    .result-info {
        flex: 1;
    }
    
    .result-title {
        font-size: 14px;
        color: #333;
        margin-bottom: 4px;
    }
    
    .result-channel {
        font-size: 12px;
        color: #666;
    }
    
    .control-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }
    .control-buttons button {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: #f0f0f0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .control-buttons button:hover {
        background: #e0e0e0;
    }
    .control-buttons button:active {
        transform: scale(0.95);
    }
    .control-buttons button i {
        font-size: 16px;
        color: #333;
    }
    #playPauseBtn {
        background: #ff5252;
    }
    #playPauseBtn i {
        color: white;
    }
    .slider { 
        width: 90%; 
        max-width: 550px;
        margin: 15px 0; 
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        outline: none;
        border-radius: 3px;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ff5252;
        cursor: pointer;
        transition: background 0.2s;
    }
    .slider::-webkit-slider-thumb:hover {
        background: #ff0000;
    }
    
    .slider::-webkit-slider-track {
        background: #ddd;
        border-radius: 3px;
    }
    
    .slider::-webkit-slider-progress {
        background: #ff5252;
        border-radius: 3px;
        height: 6px;
    }

    .time-display {
        margin-top: 10px;
        color: #666;
        font-size: 14px;
        font-family: monospace;
    }

    #player { 
        width:1px; 
        height:1px; 
        position:absolute; 
        left:-9999px; 
        opacity:0; 
    }
    
    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 90%;
        max-width: 550px;
        margin-bottom: 15px;
    }
    
    .now-playing {
        font-size: 14px;
        color: #666;
        font-style: italic;
        max-width: 300px;
    }
    
    .error-message {
        color: #ff5252;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
        display: none;
    }
    
    .loading {
        display: none;
        margin-top: 10px;
        color: #666;
    }
    
    #muteBtn.muted i {
        color: #ff5252 !important;
    }
</style>

<div id="miniPlayer" title="Open/Close Player"><i class="fas fa-music"></i></div>

<div id="fullPlayer">
    <div class="player-header">
        <h3>MusicPlay</h3>
        <div class="now-playing" id="nowPlaying">Not playing</div>
    </div>
  
    <div class="square-icon">
        <img id="videoThumbnail" src="/chat/logo.png" alt="Thumbnail" onerror="this.src='/chat/logo.png'">
    </div>

    <div class="search-container">
        <input id="searchInput" placeholder="Search YouTube music..." />
        <button id="searchBtn" title="Search">
            <i class="fas fa-search"></i>
        </button>
        <div id="searchResults"></div>
    </div>
    
    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="control-buttons">
        <button id="loopBtn" title="Loop On/Off">
            <i class="fas fa-repeat" id="loopIcon"></i>
        </button>
        <button id="prevBtn" title="Back 10 seconds">
            <i class="fas fa-backward-step"></i>
        </button>
        <button id="playPauseBtn" title="Play/Pause">
            <i class="fas fa-play" id="playPauseIcon"></i>
        </button>
        <button id="nextBtn" title="Forward 10 seconds">
            <i class="fas fa-forward-step"></i>
        </button>
        <button id="muteBtn" title="Mute/Unmute">
            <i class="fas fa-volume-up" id="muteIcon"></i>
        </button>
    </div>
    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0" step="1">
    <div class="time-display">
        <span id="curTime">0:00</span> / <span id="duration">0:00</span>
    </div>
</div>

<div id="player"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, off, remove, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const GROUP_NAME = (urlParams.get('group') || 'default').replace(/[^a-zA-Z0-9_-]/g, '_');
    const FIREBASE_PATH = `music/${GROUP_NAME}`;

    var musicPlayer = {
        player: null,
        ytReady: false,
        isPlaying: false,
        isMuted: false,
        isLooping: false,
        currentSongUrl: "",
        firebaseListener: null,
        currentVideoTitle: "",
        lastAutoUpdate: 0,
        groupName: GROUP_NAME,
        cleanupTimer: null,
        hasUserLeft: false,
        isBackgroundPaused: false,
        isRemoteUpdate: false,

        init: function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', this.setupPlayer.bind(this));
            } else {
                this.setupPlayer();
            }
            
            this.startCleanupChecker();
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    this.hasUserLeft = true;
                    this.isBackgroundPaused = true;
                } else {
                    this.hasUserLeft = false;
                    
                    setTimeout(() => {
                        this.isBackgroundPaused = false;
                        
                        if (this.ytReady && this.currentSongUrl) {
                            get(this.getFirebaseRef()).then((snapshot) => {
                                const data = snapshot.val();
                                if (data) {
                                    const { status, timestamp } = data;
                                    
                                    if (timestamp) {
                                        this.isRemoteUpdate = true;
                                        this.player.seekTo(timestamp, true);
                                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                                    }
                                    
                                    if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                                        this.isRemoteUpdate = true;
                                        this.player.playVideo();
                                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                                    } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                                        this.isRemoteUpdate = true;
                                        this.player.pauseVideo();
                                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                                    }
                                }
                            }).catch((error) => {
                                console.error("Firebase read error:", error);
                            });
                        }
                    }, 1000);
                }
            });
            
            window.addEventListener('beforeunload', () => {
                this.hasUserLeft = true;
                this.isBackgroundPaused = true;
                
                if (this.firebaseListener) {
                    off(this.getFirebaseRef(), 'value', this.firebaseListener);
                }
            });
        },
        
        startCleanupChecker: function() {
            this.cleanupTimer = setInterval(() => {
                this.cleanupEmptyGroups();
            }, 60000);
        },
        
        cleanupEmptyGroups: function() {
            if (!this.firebaseInitialized()) return;
            
            const sixHoursAgo = Date.now() - (6 * 60 * 60 * 1000);
            const dbRef = ref(database, 'music');
            
            get(dbRef).then((snapshot) => {
                const groups = snapshot.val() || {};
                
                Object.keys(groups).forEach(groupKey => {
                    const groupData = groups[groupKey];
                    const lastUpdate = groupData?.lastUpdate || 0;
                    
                    if (lastUpdate < sixHoursAgo) {
                        const groupRef = ref(database, `music/${groupKey}`);
                        remove(groupRef).catch((error) => {
                            console.error("Cleanup error:", error);
                        });
                    }
                });
            }).catch((error) => {
                console.error("Cleanup read error:", error);
            });
        },
        
        getFirebaseRef: function() {
            return ref(database, FIREBASE_PATH);
        },
        
        setupPlayer: function() {
            if (!database) {
                console.error("Firebase not initialized");
                return;
            }
            
            this.setupEventListeners();
            this.setupFirebaseListener();
            
            if (typeof YT !== 'undefined' && YT.loaded) {
                this.onYouTubeIframeAPIReady();
            } else {
                window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
            }
        },
        
        setupEventListeners: function() {
            const miniPlayer = document.getElementById('miniPlayer');
            const fullPlayer = document.getElementById('fullPlayer');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const searchResults = document.getElementById('searchResults');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const muteBtn = document.getElementById('muteBtn');
            const seekBar = document.getElementById('seekBar');
            const loopBtn = document.getElementById('loopBtn');
            
            miniPlayer.addEventListener('click', () => {
                fullPlayer.style.display = fullPlayer.style.display === 'flex' ? 'none' : 'flex';
            });
            
            searchBtn.addEventListener('click', this.handleSearch.bind(this));
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.handleSearch();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
                    searchResults.style.display = 'none';
                }
            });
            
            playPauseBtn.addEventListener('click', this.handlePlayPause.bind(this));
            prevBtn.addEventListener('click', this.handlePrev.bind(this));
            nextBtn.addEventListener('click', this.handleNext.bind(this));
            muteBtn.addEventListener('click', this.handleMute.bind(this));
            seekBar.addEventListener('input', this.handleSeek.bind(this));
            loopBtn.addEventListener('click', this.handleLoop.bind(this));
        },
        
        setupFirebaseListener: function() {
            if (!this.firebaseInitialized()) return;
            if (this.firebaseListener) {
                off(this.getFirebaseRef(), 'value', this.firebaseListener);
            }
            
            const stateRef = this.getFirebaseRef();
            
            this.firebaseListener = (snapshot) => {
                const data = snapshot.val();
                if (!data || !this.ytReady) return;

                const { currentSong, status, timestamp, lastUpdate, loop } = data;
                if (!currentSong) return;

                this.isLooping = !!loop;
                this.updateLoopIcon();

                const vid = currentSong;

                let actualTime = timestamp || 0;
                if (lastUpdate) {
                    const timeDiff = Math.floor((Date.now() - lastUpdate) / 1000);
                    actualTime = timestamp + timeDiff;
                    if (actualTime < 0) actualTime = 0;
                }

                const currentVid = this.player ? this.player.getVideoData().video_id : '';
                
                if (!currentVid || currentVid !== vid) {
                    this.isRemoteUpdate = true;
                    this.processNewSong(currentSong, status, actualTime);
                    setTimeout(() => { this.isRemoteUpdate = false; }, 2000);
                } else {
                    const currentTime = this.player.getCurrentTime();
                    if (Math.abs(currentTime - actualTime) > 3) {
                        this.isRemoteUpdate = true;
                        this.player.seekTo(actualTime, true);
                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                    }
                    
                    if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        this.isRemoteUpdate = true;
                        this.player.playVideo();
                        this.isPlaying = true;
                        this.updatePlayPauseIcon();
                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                    } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                        this.isRemoteUpdate = true;
                        this.player.pauseVideo();
                        this.isPlaying = false;
                        this.updatePlayPauseIcon();
                        setTimeout(() => { this.isRemoteUpdate = false; }, 1000);
                    }
                }
            };
            
            onValue(stateRef, this.firebaseListener);
        },
        
        onYouTubeIframeAPIReady: function() {
            if (this.player) return;
            
            this.player = new YT.Player('player', {
                height: '0', 
                width: '0', 
                videoId: '',
                playerVars: { controls: 0, modestbranding: 1, rel: 0, playsinline: 1 },
                events: { 
                    onReady: () => { 
                        this.ytReady = true; 
                        this.checkSavedState(); 
                        this.isMuted = this.player.isMuted();
                        this.updateMuteIcon();
                    },
                    onError: this.onPlayerError.bind(this),
                    onStateChange: this.onPlayerStateChange.bind(this)
                }
            });
        },
        
        onPlayerStateChange: function(event) {
            if (this.hasUserLeft || this.isRemoteUpdate) return;
            
            if (event.data === YT.PlayerState.PLAYING) {
                this.isPlaying = true;
                this.updatePlayPauseIcon();
                
                if (this.currentSongUrl) {
                    this.updateState('playing');
                }
            } else if (event.data === YT.PlayerState.PAUSED) {
                this.isPlaying = false;
                this.updatePlayPauseIcon();
                
                if (!this.isBackgroundPaused && this.currentSongUrl) {
                    this.updateState('paused');
                }
            } else if (event.data === YT.PlayerState.ENDED && this.isLooping) {
                this.player.seekTo(0, true);
                this.player.playVideo();
            }
        },
        
        updatePlayPauseIcon: function() {
            const icon = document.getElementById('playPauseIcon');
            icon.className = this.isPlaying ? 'fas fa-pause' : 'fas fa-play';
        },
        
        updateMuteIcon: function() {
            const icon = document.getElementById('muteIcon');
            const muteBtn = document.getElementById('muteBtn');
            if (this.isMuted) {
                icon.className = 'fas fa-volume-mute';
                muteBtn.classList.add('muted');
            } else {
                icon.className = 'fas fa-volume-up';
                muteBtn.classList.remove('muted');
            }
        },

        updateLoopIcon: function() {
            const icon = document.getElementById('loopIcon');
            icon.style.color = this.isLooping ? '#ff5252' : '#333';
        },
        
        onPlayerError: function(e) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = "Playback error.";
            errorMessage.style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
        },
        
        checkSavedState: function() {
            if (!this.firebaseInitialized()) return;
            const stateRef = this.getFirebaseRef();
            get(stateRef).then((snapshot) => {
                const data = snapshot.val();
                if (data && data.currentSong) {
                    const { currentSong, status, timestamp, lastUpdate, loop } = data;
                    
                    this.isLooping = !!loop;
                    this.updateLoopIcon();
                    
                    let effectiveTime = timestamp || 0;
                    if (lastUpdate) {
                        const timeDiff = Math.floor((Date.now() - lastUpdate) / 1000);
                        effectiveTime = timestamp + timeDiff;
                        if (effectiveTime < 0) effectiveTime = 0;
                    }
                    
                    this.isRemoteUpdate = true;
                    this.processNewSong(currentSong, status, effectiveTime);
                    setTimeout(() => { this.isRemoteUpdate = false; }, 2000);
                }
            }).catch((error) => {
                console.error("Check saved state error:", error);
            });
        },
        
        processNewSong: function(url, status, timestamp) {
            const vid = url;
            if (!vid) return;
            
            this.currentSongUrl = url;
            
            this.fetchVideoTitle(vid).then(title => {
                this.currentVideoTitle = title;
                document.getElementById('searchInput').value = title;
                document.getElementById('nowPlaying').textContent = 'Playing: ' + title;
            }).catch(() => {
                this.currentVideoTitle = "Unknown Title";
                document.getElementById('searchInput').value = url;
                document.getElementById('nowPlaying').textContent = 'Playing: Unknown Title';
            });

            document.getElementById('videoThumbnail').src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
            
            this.player.loadVideoById({ videoId: vid, startSeconds: timestamp || 0 });
            
            if (status === 'playing') {
                this.player.playVideo();
                this.isPlaying = true;
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
            }
            this.updatePlayPauseIcon();
        },
        
        fetchVideoTitle: function(videoId) {
            return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
                .then(response => response.json())
                .then(data => data.title)
                .catch(() => "Unknown Title");
        },
        
        updateState: function(status) {
            if (this.hasUserLeft || this.isRemoteUpdate) return;
            
            if (!this.firebaseInitialized() || !this.currentSongUrl) return;

            const now = Date.now();
            if (now - this.lastAutoUpdate < 2000) return;
            this.lastAutoUpdate = now;
            
            const currentTime = this.player ? Math.floor(this.player.getCurrentTime()) : 0;
            
            const stateObj = {
                currentSong: this.currentSongUrl,
                status: status,
                timestamp: currentTime,
                lastUpdate: now,
                loop: this.isLooping
            };
            
            const stateRef = this.getFirebaseRef();
            set(stateRef, stateObj).catch((error) => {
                console.error("Update state error:", error);
            });
        },
        
        handleSearch: function() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            fetch(`https://youtube-0vra.onrender.com/search/videos?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (data.ok && data.results && data.results.length > 0) {
                        this.displaySearchResults(data.results);
                    } else {
                        document.getElementById('errorMessage').textContent = "No results found.";
                        document.getElementById('errorMessage').style.display = 'block';
                    }
                })
                .catch(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('errorMessage').textContent = "Search failed.";
                    document.getElementById('errorMessage').style.display = 'block';
                });
        },
        
        displaySearchResults: function(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <img src="${result.thumbnail}" alt="Thumbnail" class="result-thumbnail" onerror="this.src='/chat/logo.png'">
                    <div class="result-info">
                        <div class="result-title">${result.title}</div>
                        <div class="result-channel">${result.channel}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectVideo(result);
                    searchResults.style.display = 'none';
                });
                
                searchResults.appendChild(item);
            });
            
            searchResults.style.display = 'block';
        },
        
        selectVideo: function(video) {
            this.currentSongUrl = video.videoId;
            document.getElementById('searchInput').value = video.title;
            document.getElementById('videoThumbnail').src = video.thumbnail || '/chat/logo.png';
            
            this.currentVideoTitle = video.title;
            document.getElementById('nowPlaying').textContent = 'Playing: ' + video.title;
            
            const vid = video.videoId;
            if (!vid) return;
            
            this.isRemoteUpdate = false;
            this.player.loadVideoById({ videoId: vid, startSeconds: 0 });
            this.player.playVideo();
            this.isPlaying = true;
            this.updatePlayPauseIcon();
            
            this.lastAutoUpdate = 0;
            this.updateState('playing');
        },
        
        handlePlayPause: function() {
            if (!this.ytReady) return;
            
            document.getElementById('errorMessage').style.display = 'none';
            
            if (!this.currentSongUrl) {
                document.getElementById('errorMessage').textContent = "Please search and select a video first.";
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
            
            this.isBackgroundPaused = false;
            
            if (!this.isPlaying) {
                this.player.playVideo();
            } else {
                this.player.pauseVideo();
            }
        },
        
        handleMute: function() {
            if (!this.player) return;
            if (this.player.isMuted()) {
                this.player.unMute();
                this.isMuted = false;
            } else {
                this.player.mute();
                this.isMuted = true;
            }
            this.updateMuteIcon();
        },
        
        handlePrev: function() {
            if (!this.player) return;
            const newTime = Math.max(0, this.player.getCurrentTime() - 10);
            this.player.seekTo(newTime, true);
            
            if (this.currentSongUrl && !this.hasUserLeft) {
                this.lastAutoUpdate = 0;
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        handleNext: function() {
            if (!this.player) return;
            const currentTime = this.player.getCurrentTime();
            const duration = this.player.getDuration();
            const newTime = Math.min(duration, currentTime + 10);
            this.player.seekTo(newTime, true);
            
            if (this.currentSongUrl && !this.hasUserLeft) {
                this.lastAutoUpdate = 0;
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        handleSeek: function() {
            if (!this.player) return;
            const sec = parseInt(document.getElementById('seekBar').value, 10);
            this.player.seekTo(sec, true);
            
            if (this.currentSongUrl && !this.hasUserLeft) {
                this.lastAutoUpdate = 0;
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },

        handleLoop: function() {
            this.isLooping = !this.isLooping;
            this.updateLoopIcon();
            
            if (this.currentSongUrl && !this.hasUserLeft) {
                this.lastAutoUpdate = 0;
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        updatePlayerUI: function() {
            if (!this.player) return;
            
            const t = Math.floor(this.player.getCurrentTime() || 0);
            const d = Math.floor(this.player.getDuration() || 0);
            
            document.getElementById('curTime').textContent = formatTime(t);
            document.getElementById('duration').textContent = formatTime(d);
            
            const seekBar = document.getElementById('seekBar');
            if (!seekBar.matches(':active')) {
                seekBar.max = d;
                seekBar.value = t;
            }
            
            const progress = d > 0 ? (t / d) * 100 : 0;
            seekBar.style.background = `linear-gradient(to right, #ff5252 ${progress}%, #ddd ${progress}%)`;
            
            if (this.isPlaying && this.firebaseInitialized() && this.currentSongUrl && !this.hasUserLeft && !this.isRemoteUpdate) {
                const now = Date.now();
                if (!this.lastAutoUpdate || (now - this.lastAutoUpdate) > 5000) {
                    this.lastAutoUpdate = now;
                    
                    const stateRef = this.getFirebaseRef();
                    update(stateRef, {
                        timestamp: t,
                        lastUpdate: now
                    }).catch((error) => {
                        console.error("Auto update error:", error);
                    });
                }
            }
        },
        
        firebaseInitialized: function() {
            return !!database && !!app;
        },
        
        destroy: function() {
            if (this.cleanupTimer) {
                clearInterval(this.cleanupTimer);
            }
            if (this.firebaseListener) {
                off(this.getFirebaseRef(), 'value', this.firebaseListener);
            }
        }
    };

    musicPlayer.init();

    setInterval(() => {
        if (musicPlayer.player) {
            musicPlayer.updatePlayerUI();
        }
    }, 1000);
</script>

<script>
    if (typeof YT === 'undefined') {
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
</script>
