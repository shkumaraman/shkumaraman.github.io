<style>
    :root {
        --light-bg: #f5f5f5;
        --dark-bg: #121212;
    }
    
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 35px;
        height: 35px;
        background: #ff5252;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    #miniPlayer:hover {
        transform: scale(1.1);
    }
    #miniPlayer i { 
        color: white; 
        font-size: 18px; 
    }

    .square-icon {
        width: 120px;
        height: 120px;
        background: #ff5252;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .square-icon img {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        object-fit: cover;
    }

    #fullPlayer {
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: var(--dark-bg);
        z-index: 999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }

     .light-mode #fullPlayer {
        background: var(--light-bg);
    }
    

    #fullPlayer h3 { 
        margin-bottom:20px; 
        color: #ff5252;
    }
    
    .search-container {
        width: 90%;
        max-width: 550px;
        position: relative;
        margin-bottom: 20px;
    }
    
    #searchInput { 
        width: 100%;
        padding:12px 45px 12px 15px; 
        border: 2px solid #ccc;
        border-radius: 10px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: border-color 0.3s;
        box-sizing: border-box;
    }
    #searchInput:focus {
        outline: none;
        border-color: #ff5252;
    }
    
    #searchBtn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: #ff5252;
        border: none;
        border-radius: 10px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    
    #searchBtn:hover {
        background: #ff0000;
    }
    
    #searchBtn i {
        color: white;
        font-size: 14px;
    }
    
    #searchResults {
        width: 90%;
        max-width: 550px;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1001;
        margin-top: 5px;
    }
    
    .search-result-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    
    .search-result-item:hover {
        background: #f5f5f5;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .result-thumbnail {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        margin-right: 12px;
        object-fit: cover;
    }
    
    .result-info {
        flex: 1;
        overflow: hidden;
    }
    
    .result-title {
        font-size: 14px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
    }
    
    .result-channel {
        font-size: 12px;
        color: #666;
    }
    
    .control-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }
    .control-buttons button {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: #f0f0f0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .control-buttons button:hover {
        background: #e0e0e0;
    }
    .control-buttons button:active {
        transform: scale(0.95);
    }
    .control-buttons button i {
        font-size: 16px;
        color: #333;
    }
    #playPauseBtn {
        background: #ff5252;
    }
    #playPauseBtn i {
        color: white;
    }
    .slider { 
        width: 90%; 
        max-width: 550px;
        margin: 15px 0; 
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        outline: none;
        border-radius: 3px;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ff5252;
        cursor: pointer;
        transition: background 0.2s;
    }
    .slider::-webkit-slider-thumb:hover {
        background: #ff0000;
    }
    
    .slider::-webkit-slider-track {
        background: #ddd;
        border-radius: 3px;
    }
    
    .slider::-webkit-slider-progress {
        background: #ff5252;
        border-radius: 3px;
        height: 6px;
    }

    .time-display {
        margin-top: 10px;
        color: #666;
        font-size: 14px;
        font-family: monospace;
    }

    #player { 
        width:1px; 
        height:1px; 
        position:absolute; 
        left:-9999px; 
        opacity:0; 
    }
    
    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 90%;
        max-width: 550px;
        margin-bottom: 15px;
    }
    
    .now-playing {
        font-size: 14px;
        color: #666;
        font-style: italic;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .error-message {
        color: #ff5252;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
        display: none;
    }
    
    .loading {
        display: none;
        margin-top: 10px;
        color: #666;
    }
    
    #muteBtn.muted i {
        color: #ff5252 !important;
    }

    .group-badge {
        background: #ff5252;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
    }
</style>

<!-- Mini player -->
<div id="miniPlayer" title="Open/Close Player"><i class="fas fa-music"></i></div>

<!-- Fullscreen Player -->
<div id="fullPlayer">
    <div class="player-header">
        <div style="display: flex; align-items: center;">
            <h3>MusicPlay</h3>
            <span id="groupBadge" class="group-badge"></span>
        </div>
        <div class="now-playing" id="nowPlaying">Not playing</div>
    </div>
  
    <div class="square-icon">
        <img id="videoThumbnail" src="/chat/logo.png" alt="Thumbnail" onerror="this.src='/chat/logo.png'">
    </div>

    <div class="search-container">
        <input id="searchInput" placeholder="Search YouTube music..." />
        <button id="searchBtn" title="Search">
            <i class="fas fa-search"></i>
        </button>
        <div id="searchResults"></div>
    </div>
    
    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="control-buttons">
        <button id="loopBtn" title="Loop On/Off">
            <i class="fas fa-repeat" id="loopIcon"></i>
        </button>
        <button id="prevBtn" title="Back 10 seconds">
            <i class="fas fa-backward-step"></i>
        </button>
        <button id="playPauseBtn" title="Play/Pause">
            <i class="fas fa-play" id="playPauseIcon"></i>
        </button>
        <button id="nextBtn" title="Forward 10 seconds">
            <i class="fas fa-forward-step"></i>
        </button>
        <button id="muteBtn" title="Mute/Unmute">
            <i class="fas fa-volume-up" id="muteIcon"></i>
        </button>
    </div>
    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0" step="1">
    <div class="time-display">
        <span id="curTime">0:00</span> / <span id="duration">0:00</span>
    </div>
</div>

<!-- Hidden player -->
<div id="player"></div>

<script>
    if (typeof YT === 'undefined') {
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Get group name from URL
    function getGroupFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('group') || 'default';
    }

    var musicPlayer = {
        player: null,
        ytReady: false,
        isPlaying: false,
        isMuted: false,
        isLooping: false,
        currentSongUrl: "",
        firebaseListener: null,
        currentVideoTitle: "",
        lastAutoUpdate: 0,
        group: getGroupFromUrl(), // Current group name
        cleanupInterval: null,

        getFirebasePath: function() {
            return `music/${this.group}`;
        },

        init: function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', this.setupPlayer.bind(this));
            } else {
                this.setupPlayer();
            }
        },
        
        setupPlayer: function() {
            if (typeof firebase === 'undefined') {
                console.error("Firebase not loaded");
                return;
            }
            
            // Display group badge
            document.getElementById('groupBadge').textContent = `Group: ${this.group}`;
            
            this.setupEventListeners();
            this.setupFirebaseListener();
            
            // Start cleanup check every hour
            this.cleanupInterval = setInterval(this.cleanupInactiveGroups.bind(this), 3600000); // 1 hour
            
            if (typeof YT !== 'undefined' && YT.loaded) {
                this.onYouTubeIframeAPIReady();
            } else {
                window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
            }
        },

        cleanupInactiveGroups: function() {
            if (!this.firebaseInitialized()) return;
            
            const musicRef = firebase.database().ref('music');
            musicRef.once('value').then((snapshot) => {
                const groups = snapshot.val();
                if (!groups) return;
                
                const sixHoursAgo = Date.now() - (6 * 60 * 60 * 1000); // 6 hours in milliseconds
                
                Object.keys(groups).forEach(groupName => {
                    const groupData = groups[groupName];
                    if (groupData && groupData.lastUpdate) {
                        if (groupData.lastUpdate < sixHoursAgo) {
                            // Delete inactive group
                            musicRef.child(groupName).remove()
                                .then(() => {
                                    console.log(`Deleted inactive group: ${groupName}`);
                                })
                                .catch(error => {
                                    console.error(`Error deleting group ${groupName}:`, error);
                                });
                        }
                    }
                });
            }).catch(error => {
                console.error('Error checking inactive groups:', error);
            });
        },
        
        setupEventListeners: function() {
            const miniPlayer = document.getElementById('miniPlayer');
            const fullPlayer = document.getElementById('fullPlayer');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const searchResults = document.getElementById('searchResults');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const muteBtn = document.getElementById('muteBtn');
            const seekBar = document.getElementById('seekBar');
            const loopBtn = document.getElementById('loopBtn');
            
            miniPlayer.addEventListener('click', () => {
                fullPlayer.style.display = fullPlayer.style.display === 'flex' ? 'none' : 'flex';
            });
            
            searchBtn.addEventListener('click', this.handleSearch.bind(this));
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.handleSearch();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
                    searchResults.style.display = 'none';
                }
            });
            
            playPauseBtn.addEventListener('click', this.handlePlayPause.bind(this));
            prevBtn.addEventListener('click', this.handlePrev.bind(this));
            nextBtn.addEventListener('click', this.handleNext.bind(this));
            muteBtn.addEventListener('click', this.handleMute.bind(this));
            seekBar.addEventListener('input', this.handleSeek.bind(this));
            loopBtn.addEventListener('click', this.handleLoop.bind(this));
        },
        
        setupFirebaseListener: function() {
            if (!this.firebaseInitialized()) return;
            if (this.firebaseListener) this.firebaseListener();
            
            const stateRef = firebase.database().ref(this.getFirebasePath());
            this.firebaseListener = stateRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                // If no data exists for this group, stop playback
                if (!data || !data.currentSong) {
                    if (this.player) {
                        this.player.stopVideo();
                        this.isPlaying = false;
                        this.currentSongUrl = null;
                        this.updatePlayPauseIcon();
                        document.getElementById('nowPlaying').textContent = 'Not playing';
                        document.getElementById('videoThumbnail').src = '/chat/logo.png';
                        document.getElementById('searchInput').value = '';
                    }
                    return;
                }

                if (!this.ytReady) return;

                const { currentSong, status, timestamp, lastUpdate, loop } = data;
                if (!currentSong) return;

                this.isLooping = !!loop;
                this.updateLoopIcon();

                const vid = currentSong;

                // Calculate actual time based on lastUpdate
                let actualTime = timestamp || 0;
                if (status === 'playing' && lastUpdate) {
                    const timeDiff = Math.floor((Date.now() - lastUpdate) / 1000);
                    actualTime = timestamp + timeDiff;
                    if (actualTime < 0) actualTime = 0;
                }

                const currentVid = this.player ? this.player.getVideoData().video_id : '';
                
                // If new song or different song
                if (!currentVid || currentVid !== vid) {
                    this.processNewSong(currentSong, status, actualTime);
                } else {
                    // Sync time if difference is significant
                    const currentTime = this.player.getCurrentTime();
                    if (Math.abs(currentTime - actualTime) > 1.5) { // 1.5 seconds threshold
                        this.player.seekTo(actualTime, true);
                    }
                    
                    // Sync play/pause state
                    if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        this.player.playVideo();
                        this.isPlaying = true;
                        this.updatePlayPauseIcon();
                    } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                        this.player.pauseVideo();
                        this.isPlaying = false;
                        this.updatePlayPauseIcon();
                    }
                }
            });
        },
        
        onYouTubeIframeAPIReady: function() {
            if (this.player) return;
            
            this.player = new YT.Player('player', {
                height: '0', 
                width: '0', 
                videoId: '',
                playerVars: { controls: 0, modestbranding: 1, rel: 0, playsinline: 1 },
                events: { 
                    onReady: () => { 
                        this.ytReady = true; 
                        this.checkSavedState(); 
                        this.isMuted = this.player.isMuted();
                        this.updateMuteIcon();
                    },
                    onError: this.onPlayerError.bind(this),
                    onStateChange: this.onPlayerStateChange.bind(this)
                }
            });
        },
        
        onPlayerStateChange: function(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                this.isPlaying = true;
                this.updatePlayPauseIcon();
                
                // Update Firebase when video starts playing
                if (this.currentSongUrl) {
                    this.updateState('playing');
                }
            } else if (event.data === YT.PlayerState.PAUSED) {
                this.isPlaying = false;
                this.updatePlayPauseIcon();
                
                // Update Firebase when video is paused
                if (this.currentSongUrl) {
                    this.updateState('paused');
                }
            } else if (event.data === YT.PlayerState.ENDED && this.isLooping) {
                this.player.seekTo(0, true);
                this.player.playVideo();
            }
        },
        
        updatePlayPauseIcon: function() {
            const icon = document.getElementById('playPauseIcon');
            if (this.isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        },
        
        updateMuteIcon: function() {
            const icon = document.getElementById('muteIcon');
            const muteBtn = document.getElementById('muteBtn');
            if (this.isMuted) {
                icon.className = 'fas fa-volume-mute';
                muteBtn.classList.add('muted');
            } else {
                icon.className = 'fas fa-volume-up';
                muteBtn.classList.remove('muted');
            }
        },

        updateLoopIcon: function() {
            const icon = document.getElementById('loopIcon');
            if (this.isLooping) {
                icon.style.color = '#ff5252';
            } else {
                icon.style.color = '#333';
            }
        },
        
        onPlayerError: function(e) {
            const errorMessage = document.getElementById('errorMessage');
            switch(e.data) {
                case 2: errorMessage.textContent = "Invalid video ID."; break;
                case 5: errorMessage.textContent = "HTML5 player error."; break;
                case 100: errorMessage.textContent = "Video not found."; break;
                case 101:
                case 150: errorMessage.textContent = "Video cannot be embedded."; break;
                default: errorMessage.textContent = "Playback error.";
            }
            errorMessage.style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
        },
        
        checkSavedState: function() {
            if (!this.firebaseInitialized()) return;
            const stateRef = firebase.database().ref(this.getFirebasePath());
            stateRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.currentSong) {
                    const { currentSong, status, timestamp, lastUpdate, loop } = data;
                    
                    this.isLooping = !!loop;
                    this.updateLoopIcon();
                    
                    let effectiveTime = timestamp || 0;
                    if (status === 'playing' && lastUpdate) {
                        const timeDiff = Math.floor((Date.now() - lastUpdate) / 1000);
                        effectiveTime = timestamp + timeDiff;
                        if (effectiveTime < 0) effectiveTime = 0;
                    }
                    
                    this.processNewSong(currentSong, status, effectiveTime);
                }
            });
        },
        
        processNewSong: function(url, status, timestamp) {
            const vid = url;
            if (!vid) return;
            
            this.currentSongUrl = url;
            document.getElementById('searchInput').value = url;
            
            // Update thumbnail
            document.getElementById('videoThumbnail').src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
            
            // Fetch and display video title
            this.fetchVideoTitle(vid).then(title => {
                this.currentVideoTitle = title;
                document.getElementById('nowPlaying').textContent = 'Playing: ' + title;
            }).catch(() => {
                this.currentVideoTitle = "Unknown Title";
                document.getElementById('nowPlaying').textContent = 'Playing: ' + url;
            });
            
            // Load and play/pause the video
            this.player.loadVideoById({ videoId: vid, startSeconds: timestamp || 0 });
            if (status === 'playing') {
                this.player.playVideo();
                this.isPlaying = true;
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
            }
            this.updatePlayPauseIcon();
            
            // Update Firebase with the new song state
            this.updateState(status);
        },
        
        fetchVideoTitle: function(videoId) {
            return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
                .then(response => response.json())
                .then(data => data.title);
        },
        
        updateState: function(status) {
            if (!this.firebaseInitialized() || !this.currentSongUrl) return;
            
            const currentTime = this.player ? Math.floor(this.player.getCurrentTime()) : 0;
            
            const stateObj = {
                currentSong: this.currentSongUrl,
                status: status,
                timestamp: currentTime,
                lastUpdate: Date.now(),
                loop: this.isLooping
            };
            
            firebase.database().ref(this.getFirebasePath()).set(stateObj).catch(error => {
                console.error('Firebase update error:', error);
            });
        },
        
        handleSearch: function() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            fetch(`https://youtube-0vra.onrender.com/search/videos?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (data.ok && data.results && data.results.length > 0) {
                        this.displaySearchResults(data.results);
                    } else {
                        document.getElementById('errorMessage').textContent = "No results found.";
                        document.getElementById('errorMessage').style.display = 'block';
                    }
                })
                .catch(error => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('errorMessage').textContent = "Search failed. Please try again.";
                    document.getElementById('errorMessage').style.display = 'block';
                    console.error('Search error:', error);
                });
        },
        
        displaySearchResults: function(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <img src="${result.thumbnail}" alt="Thumbnail" class="result-thumbnail" onerror="this.src='/chat/logo.png'">
                    <div class="result-info">
                        <div class="result-title">${result.title}</div>
                        <div class="result-channel">${result.channel}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectVideo(result);
                    searchResults.style.display = 'none';
                });
                
                searchResults.appendChild(item);
            });
            
            searchResults.style.display = 'block';
        },
        
        selectVideo: function(video) {
            this.currentSongUrl = video.videoId;
            document.getElementById('searchInput').value = video.title;
            
            // Update thumbnail
            document.getElementById('videoThumbnail').src = video.thumbnail || '/chat/logo.png';
            
            // Update title display
            this.currentVideoTitle = video.title;
            document.getElementById('nowPlaying').textContent = 'Playing: ' + video.title;
            
            const vid = video.videoId;
            if (!vid) return;
            
            // Load and play the video
            this.player.loadVideoById({ videoId: vid, startSeconds: 0 });
            this.player.playVideo();
            this.isPlaying = true;
            this.updatePlayPauseIcon();
            
            // Update Firebase
            this.updateState('playing');
        },
        
        handlePlayPause: function() {
            if (!this.ytReady) return alert('Player not ready yet!');
            
            document.getElementById('errorMessage').style.display = 'none';
            
            if (!this.currentSongUrl) {
                document.getElementById('errorMessage').textContent = "Please search and select a video first.";
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
            
            const currentTime = Math.floor(this.player.getCurrentTime() || 0);
            
            if (!this.isPlaying) {
                this.player.playVideo();
                this.isPlaying = true;
                this.updateState('playing');
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
                this.updateState('paused');
            }
            this.updatePlayPauseIcon();
        },
        
        handleMute: function() {
            if (!this.player) return;
            if (this.player.isMuted()) {
                this.player.unMute();
                this.isMuted = false;
            } else {
                this.player.mute();
                this.isMuted = true;
            }
            this.updateMuteIcon();
        },
        
        handlePrev: function() {
            if (!this.player) return;
            const newTime = Math.max(0, this.player.getCurrentTime() - 10);
            this.player.seekTo(newTime, true);
            
            // Update Firebase with new time
            if (this.currentSongUrl) {
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        handleNext: function() {
            if (!this.player) return;
            const currentTime = this.player.getCurrentTime();
            const duration = this.player.getDuration();
            const newTime = Math.min(duration, currentTime + 10);
            this.player.seekTo(newTime, true);
            
            // Update Firebase with new time
            if (this.currentSongUrl) {
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        handleSeek: function() {
            if (!this.player) return;
            const sec = parseInt(document.getElementById('seekBar').value, 10);
            this.player.seekTo(sec, true);
            
            // Immediately update Firebase with new time
            if (this.currentSongUrl) {
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },

        handleLoop: function() {
            this.isLooping = !this.isLooping;
            this.updateLoopIcon();
            
            // Update Firebase with loop state
            if (this.currentSongUrl) {
                this.updateState(this.isPlaying ? 'playing' : 'paused');
            }
        },
        
        updatePlayerUI: function() {
            if (!this.player) return;
            
            const t = Math.floor(this.player.getCurrentTime() || 0);
            const d = Math.floor(this.player.getDuration() || 0);
            
            document.getElementById('curTime').textContent = formatTime(t);
            document.getElementById('duration').textContent = formatTime(d);
            
            const seekBar = document.getElementById('seekBar');
            if (!seekBar.matches(':active')) {
                seekBar.max = d;
                seekBar.value = t;
            }
            
            const progress = (t / d) * 100;
            seekBar.style.background = `linear-gradient(to right, #ff5252 ${progress}%, #ddd ${progress}%)`;
            
            // Automatically update Firebase every 5 seconds when playing
            if (this.isPlaying && this.firebaseInitialized() && this.currentSongUrl) {
                const now = Date.now();
                if (!this.lastAutoUpdate || (now - this.lastAutoUpdate) > 5000) {
                    this.lastAutoUpdate = now;
                    
                    // Update only timestamp and lastUpdate to avoid conflicts
                    firebase.database().ref(this.getFirebasePath()).update({
                        timestamp: t,
                        lastUpdate: now
                    }).catch(error => {
                        console.error('Auto-update error:', error);
                    });
                }
            }
        },
        
        firebaseInitialized: function() {
            return typeof firebase !== 'undefined' && firebase.apps.length > 0;
        },

        // Clean up listeners when component is destroyed
        destroy: function() {
            if (this.firebaseListener) {
                firebase.database().ref(this.getFirebasePath()).off('value', this.firebaseListener);
            }
            if (this.cleanupInterval) {
                clearInterval(this.cleanupInterval);
            }
        }
    };

    musicPlayer.init();

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        musicPlayer.destroy();
    });

    setInterval(() => {
        if (musicPlayer.player) {
            musicPlayer.updatePlayerUI();
        }
    }, 1000);
</script>
