<style>
    /* Mini floating player */
    #miniPlayer {
        position: fixed;
        bottom: 60px;
        left: 12px;
        width: 35px;
        height: 35px;
        background: #ff5252;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    #miniPlayer:hover {
        transform: scale(1.1);
    }
    #miniPlayer i { 
        color: white; 
        font-size: 18px; 
    }

    /* Thumbnail container */
    .thumbnail-container {
        width: 180px;
        height: 120px;
        background: #f0f0f0;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 25px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        overflow: hidden;
        position: relative;
    }
  
    .thumbnail-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
  
    .thumbnail-container .placeholder {
        color: #ccc;
        font-size: 40px;
    }

    /* Fullscreen player overlay */
    #fullPlayer {
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(255, 255, 255, 0.95);
        z-index: 999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }

    #fullPlayer h3 { 
        margin-bottom:20px; 
        color: #333;
        font-family: 'Arial', sans-serif;
    }
    #urlInput { 
        width: 80%; 
        max-width: 500px;
        padding:12px 15px; 
        margin-bottom:20px; 
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: border-color 0.3s;
    }
    #urlInput:focus {
        outline: none;
        border-color: #ff5252;
    }
    .control-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }
    .control-buttons button {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: #f0f0f0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .control-buttons button:hover {
        background: #e0e0e0;
    }
    .control-buttons button:active {
        transform: scale(0.95);
    }
    .control-buttons button i {
        font-size: 16px;
        color: #333;
    }
    #playPauseBtn {
        background: #ff5252;
    }
    #playPauseBtn i {
        color: white;
    }
    .slider { 
        width: 80%; 
        max-width: 500px;
        margin: 15px 0; 
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        outline: none;
        border-radius: 3px;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ff5252;
        cursor: pointer;
        transition: background 0.2s;
    }
    .slider::-webkit-slider-thumb:hover {
        background: #ff0000;
    }

    .time-display {
        margin-top: 10px;
        color: #666;
        font-size: 14px;
        font-family: monospace;
    }

    #player { 
        width:1px; 
        height:1px; 
        position:absolute; 
        left:-9999px; 
        opacity:0; 
    }
    
    .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 80%;
        max-width: 500px;
        margin-bottom: 15px;
    }
    
    .now-playing {
        font-size: 14px;
        color: #666;
        font-style: italic;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .error-message {
        color: #ff5252;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
        display: none;
    }
    
    .loading {
        display: none;
        margin-top: 10px;
        color: #666;
    }
    
    /* Mute button styles */
    #muteBtn.muted i {
        color: #ff5252 !important;
    }
    
    /* Loop button styles */
    #loopBtn.looping {
        background: #ff5252;
    }
    #loopBtn.looping i {
        color: white !important;
    }
</style>

<!-- Mini player (no longer draggable) -->
<div id="miniPlayer" title="Open/Close Player"><i class="fas fa-music"></i></div>

<!-- Fullscreen Player -->
<div id="fullPlayer">
    <div class="player-header">
        <h3>MusicPlay</h3>
        <div class="now-playing" id="nowPlaying">Not playing</div>
    </div>
  
    <div class="thumbnail-container" id="thumbnailContainer">
        <div class="placeholder"><i class="fas fa-music"></i></div>
    </div>

    <input id="urlInput" placeholder="Paste YouTube URL here" />
    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="control-buttons">
        <button id="loopBtn" title="Toggle Loop">
            <i class="fas fa-repeat" id="loopIcon"></i>
        </button>
        <button id="prevBtn" title="Back 10 seconds">
            <i class="fas fa-backward-step"></i>
        </button>
        <button id="playPauseBtn" title="Play/Pause">
            <i class="fas fa-play" id="playPauseIcon"></i>
        </button>
        <button id="nextBtn" title="Forward 10 seconds">
            <i class="fas fa-forward-step"></i>
        </button>
        <button id="muteBtn" title="Mute/Unmute">
            <i class="fas fa-volume-up" id="muteIcon"></i>
        </button>
    </div>
    <input type="range" id="seekBar" class="slider" min="0" max="0" value="0" step="1">
    <div class="time-display">
        <span id="curTime">0:00</span> / <span id="duration">0:00</span>
    </div>
</div>

<!-- Hidden YouTube player -->
<div id="player"></div>

<!-- YouTube IFrame API -->
<script>
    if (typeof YT === 'undefined') {
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    function extractYouTubeID(url) {
        if (!url) return null;
        if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
        try {
            const u = new URL(url);
            if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
            if (u.searchParams.get("v")) return u.searchParams.get("v");
        } catch {}
        const m = url.match(/[a-zA-Z0-9_-]{11}/);
        return m ? m[0] : null;
    }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    var musicPlayer = {
        player: null,
        ytReady: false,
        isPlaying: false,
        isMuted: false,
        isLooping: false,
        currentSongUrl: "",
        firebaseListener: null,
        currentVideoTitle: "",

        init: function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', this.setupPlayer.bind(this));
            } else {
                this.setupPlayer();
            }
        },
        
        setupPlayer: function() {
            if (typeof firebase === 'undefined') {
                console.error("Firebase not loaded");
                return;
            }
            
            this.setupEventListeners();
            this.setupFirebaseListener();
            
            if (typeof YT !== 'undefined' && YT.loaded) {
                this.onYouTubeIframeAPIReady();
            } else {
                window.onYouTubeIframeAPIReady = this.onYouTubeIframeAPIReady.bind(this);
            }
        },
        
        setupEventListeners: function() {
            const miniPlayer = document.getElementById('miniPlayer');
            const fullPlayer = document.getElementById('fullPlayer');
            const urlInput = document.getElementById('urlInput');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const muteBtn = document.getElementById('muteBtn');
            const loopBtn = document.getElementById('loopBtn');
            const seekBar = document.getElementById('seekBar');
            
            miniPlayer.addEventListener('click', () => {
                if (fullPlayer.style.display === 'flex') {
                    fullPlayer.style.display = 'none';
                } else {
                    fullPlayer.style.display = 'flex';
                    setTimeout(() => urlInput.focus(), 100);
                }
            });
            
            playPauseBtn.addEventListener('click', this.handlePlayPause.bind(this));
            prevBtn.addEventListener('click', this.handlePrev.bind(this));
            nextBtn.addEventListener('click', this.handleNext.bind(this));
            muteBtn.addEventListener('click', this.handleMute.bind(this));
            loopBtn.addEventListener('click', this.handleLoop.bind(this));
            seekBar.addEventListener('input', this.handleSeek.bind(this));
            
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    playPauseBtn.click();
                }
            });
        },
        
        setupFirebaseListener: function() {
            if (!this.firebaseInitialized()) return;
            if (this.firebaseListener) this.firebaseListener();
            
            const stateRef = firebase.database().ref('music');
            this.firebaseListener = stateRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data || !this.ytReady) return;

                const { currentSong, status, timestamp, lastUpdate, loop } = data;
                if (!currentSong) return;

                document.getElementById('urlInput').value = currentSong;
                const vid = extractYouTubeID(currentSong);
                if (!vid) return;

                const now = Date.now();
                let effectiveTime = timestamp || 0;
                if (status === 'playing' && lastUpdate) {
                    effectiveTime += Math.floor((now - lastUpdate) / 1000);
                }

                // Update loop state
                this.isLooping = loop || false;
                this.updateLoopIcon();

                const currentVid = this.player ? this.player.getVideoData().video_id : '';
                if (!currentVid || currentVid !== vid) {
                    this.processNewSong(currentSong, status, effectiveTime);
                } else {
                    const currentTime = this.player.getCurrentTime();
                    if (Math.abs(currentTime - effectiveTime) > 2) {
                        this.player.seekTo(effectiveTime, true);
                    }
                    if (status === 'playing' && this.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        this.player.playVideo();
                        this.isPlaying = true;
                        this.updatePlayPauseIcon();
                    } else if (status === 'paused' && this.player.getPlayerState() !== YT.PlayerState.PAUSED) {
                        this.player.pauseVideo();
                        this.isPlaying = false;
                        this.updatePlayPauseIcon();
                    }
                }
            });
        },
        
        onYouTubeIframeAPIReady: function() {
            if (this.player) return;
            
            this.player = new YT.Player('player', {
                height: '0', 
                width: '0', 
                videoId: '',
                playerVars: { controls: 0, modestbranding: 1, rel: 0, playsinline: 1 },
                events: { 
                    onReady: () => { 
                        this.ytReady = true; 
                        this.checkSavedState(); 
                        // Check initial mute status
                        this.isMuted = this.player.isMuted();
                        this.updateMuteIcon();
                    },
                    onError: this.onPlayerError.bind(this),
                    onStateChange: this.onPlayerStateChange.bind(this)
                }
            });
        },
        
        onPlayerStateChange: function(event) {
            // Update play/pause button when player state changes
            if (event.data === YT.PlayerState.PLAYING) {
                this.isPlaying = true;
                this.updatePlayPauseIcon();
            } else if (event.data === YT.PlayerState.PAUSED) {
                this.isPlaying = false;
                this.updatePlayPauseIcon();
            } else if (event.data === YT.PlayerState.ENDED && this.isLooping) {
                // Handle looping
                this.player.seekTo(0, true);
                this.player.playVideo();
            }
        },
        
        updatePlayPauseIcon: function() {
            const icon = document.getElementById('playPauseIcon');
            if (this.isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        },
        
        updateMuteIcon: function() {
            const icon = document.getElementById('muteIcon');
            const muteBtn = document.getElementById('muteBtn');
            
            if (this.isMuted) {
                icon.className = 'fas fa-volume-mute';
                muteBtn.classList.add('muted');
            } else {
                icon.className = 'fas fa-volume-up';
                muteBtn.classList.remove('muted');
            }
        },
        
        updateLoopIcon: function() {
            const loopBtn = document.getElementById('loopBtn');
            if (this.isLooping) {
                loopBtn.classList.add('looping');
            } else {
                loopBtn.classList.remove('looping');
            }
        },
        
        updateThumbnail: function(videoId) {
            const thumbnailContainer = document.getElementById('thumbnailContainer');
            if (videoId) {
                thumbnailContainer.innerHTML = `<img src="https://i.ytimg.com/vi/${videoId}/mqdefault.jpg" alt="Video Thumbnail">`;
            } else {
                thumbnailContainer.innerHTML = '<div class="placeholder"><i class="fas fa-music"></i></div>';
            }
        },
        
        onPlayerError: function(e) {
            const errorMessage = document.getElementById('errorMessage');
            switch(e.data) {
                case 2: errorMessage.textContent = "Invalid video ID."; break;
                case 5: errorMessage.textContent = "HTML5 player error."; break;
                case 100: errorMessage.textContent = "Video not found."; break;
                case 101:
                case 150: errorMessage.textContent = "Video cannot be embedded."; break;
                default: errorMessage.textContent = "Playback error.";
            }
            errorMessage.style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
        },
        
        checkSavedState: function() {
            if (!this.firebaseInitialized()) return;
            const stateRef = firebase.database().ref('music');
            stateRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.currentSong) {
                    const now = Date.now();
                    let effectiveTime = data.timestamp || 0;
                    if (data.status === 'playing' && data.lastUpdate) {
                        effectiveTime += Math.floor((now - data.lastUpdate) / 1000);
                    }
                    
                    // Set loop state
                    this.isLooping = data.loop || false;
                    this.updateLoopIcon();
                    
                    this.processNewSong(data.currentSong, data.status, effectiveTime);
                }
            });
        },
        
        processNewSong: function(url, status, timestamp) {
            const vid = extractYouTubeID(url || '');
            if (!vid) return;
            
            this.currentSongUrl = url;
            document.getElementById('urlInput').value = url;
            
            // Update thumbnail
            this.updateThumbnail(vid);
            
            this.fetchVideoTitle(vid).then(title => {
                this.currentVideoTitle = title;
                document.getElementById('nowPlaying').textContent = 'Playing: ' + title;
            }).catch(() => {
                this.currentVideoTitle = "Unknown Title";
                document.getElementById('nowPlaying').textContent = 'Playing: ' + url;
            });
            
            this.player.loadVideoById({ videoId: vid, startSeconds: timestamp || 0 });
            if (status === 'playing') {
                this.player.playVideo();
                this.isPlaying = true;
            } else {
                this.player.pauseVideo();
                this.isPlaying = false;
            }
            this.updatePlayPauseIcon();
        },
        
        fetchVideoTitle: function(videoId) {
            return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
                .then(response => response.json())
                .then(data => data.title);
        },
        
        updateState: function(obj) {
            if (!this.firebaseInitialized()) return;
            obj.lastUpdate = Date.now();
            // Always include the current loop state
            obj.loop = this.isLooping;
            firebase.database().ref('music').set(obj).catch(error => {
                console.error('Firebase update error:', error);
            });
        },
        
        handlePlayPause: function() {
            const url = document.getElementById('urlInput').value.trim();
            const vid = extractYouTubeID(url);
            if (!vid) return alert('Please enter a valid YouTube URL');
            if (!this.ytReady) return alert('Player not ready yet!');
            
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const currentVid = this.player.getVideoData().video_id;
            let startTime = Math.floor(this.player.getCurrentTime() || 0);
            
            if (currentVid !== vid) {
                this.currentSongUrl = url;
                this.player.loadVideoById({ videoId: vid, startSeconds: 0 });
                this.player.playVideo();
                this.isPlaying = true;
                this.updatePlayPauseIcon();
                this.updateState({ currentSong: url, status: 'playing', timestamp: 0 });
                document.getElementById('loadingIndicator').style.display = 'none';
            } else {
                if (!this.isPlaying) {
                    this.player.playVideo();
                    this.isPlaying = true;
                    this.updateState({ currentSong: url, status: 'playing', timestamp: startTime });
                } else {
                    this.player.pauseVideo();
                    this.isPlaying = false;
                    this.updateState({ currentSong: url, status: 'paused', timestamp: startTime });
                }
                this.updatePlayPauseIcon();
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        },
        
        handleMute: function() {
            if (!this.player) return;
            
            if (this.player.isMuted()) {
                this.player.unMute();
                this.isMuted = false;
            } else {
                this.player.mute();
                this.isMuted = true;
            }
            
            this.updateMuteIcon();
        },
        
        handleLoop: function() {
            this.isLooping = !this.isLooping;
            this.updateLoopIcon();
            
            // Update Firebase with the new loop state
            if (this.currentSongUrl) {
                const currentTime = this.player.getCurrentTime();
                this.updateState({ 
                    currentSong: this.currentSongUrl, 
                    status: this.isPlaying ? 'playing' : 'paused', 
                    timestamp: currentTime
                });
            }
        },
        
        handlePrev: function() {
            if (!this.player) return;
            const newTime = Math.max(0, this.player.getCurrentTime() - 10);
            this.player.seekTo(newTime, true);
            this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: newTime, currentSong: this.currentSongUrl });
        },
        
        handleNext: function() {
            if (!this.player) return;
            const currentTime = this.player.getCurrentTime();
            const duration = this.player.getDuration();
            const newTime = Math.min(duration, currentTime + 10);
            this.player.seekTo(newTime, true);
            this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: newTime, currentSong: this.currentSongUrl });
        },
        
        handleSeek: function() {
            if (!this.player) return;
            const sec = parseInt(document.getElementById('seekBar').value, 10);
            this.player.seekTo(sec, true);
            this.updateState({ status: this.isPlaying ? 'playing' : 'paused', timestamp: sec, currentSong: this.currentSongUrl });
        },
        
        updatePlayerUI: function() {
            if (!this.player) return;
            const t = Math.floor(this.player.getCurrentTime() || 0);
            const d = Math.floor(this.player.getDuration() || 0);
            document.getElementById('curTime').textContent = formatTime(t);
            document.getElementById('duration').textContent = formatTime(d);
            const seekBar = document.getElementById('seekBar');
            if (!seekBar.matches(':active')) {
                seekBar.max = d;
                seekBar.value = t;
            }
        },
        
        firebaseInitialized: function() {
            return typeof firebase !== 'undefined' && firebase.apps.length > 0;
        }
    };

    musicPlayer.init();

    setInterval(() => {
        if (musicPlayer.player) {
            musicPlayer.updatePlayerUI();
        }
    }, 1000);
</script>
