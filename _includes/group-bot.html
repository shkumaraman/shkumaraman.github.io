<script>
class TalkRushBot {
    constructor() {
        this.bots = new Map();
        this.isInitialized = false;
        this.botMessagesRef = null;
        this.currentGroup = null;
        this.lastUserMessage = '';
        this.lastBotResponder = '';
    }

    async initialize() {
        if (this.isInitialized) return;
        
        try {
            await this.loadBotConfig();
            this.setupBotListener();
            this.isInitialized = true;
        } catch (error) {
            this.createSampleBot();
        }
    }

    async loadBotConfig() {
        try {
            const response = await fetch('bot.txt');
            const text = await response.text();
            this.parseBotConfig(text);
        } catch (error) {
            this.createSampleBot();
        }
    }

    parseBotConfig(configText) {
        const lines = configText.split('\n');
        let currentBot = null;
        let currentBotConfig = null;

        for (const line of lines) {
            const trimmedLine = line.trim();
            
            if (!trimmedLine) continue;
            
            if (trimmedLine.startsWith('#')) {
                if (currentBot && currentBotConfig) {
                    this.bots.set(currentBot, currentBotConfig);
                }
                
                const botName = trimmedLine.substring(1).trim();
                currentBot = botName;
                currentBotConfig = {
                    name: botName,
                    triggers: new Map(),
                    cooldown: 8000,
                    lastResponseTime: 0
                };
            } 
            else if (currentBotConfig && trimmedLine.includes('-')) {
                const parts = trimmedLine.split('-');
                if (parts.length >= 2) {
                    const trigger = parts[0].trim().toLowerCase();
                    const response = parts.slice(1).join('-').trim();
                    
                    if (trigger && response) {
                        currentBotConfig.triggers.set(trigger, response);
                    }
                }
            }
        }
        
        if (currentBot && currentBotConfig) {
            this.bots.set(currentBot, currentBotConfig);
        }
    }

    createSampleBot() {
        const priyaBot = {
            name: "Priya",
            triggers: new Map([
                ["hi", "Hey!"],
                ["hello", "Hi there"],
                ["how are you", "Good, you?"],
                ["name", "Priya"],
                ["hobby", "Reading"],
                ["bye", "Bye ðŸ‘‹"]
            ]),
            cooldown: 8000,
            lastResponseTime: 0
        };
        
        const anjaliBot = {
            name: "Anjali",
            triggers: new Map([
                ["hi", "Hello!"],
                ["hey", "Hi"],
                ["how are you", "I'm fine"],
                ["what's up", "Nothing much"],
                ["bye", "See ya"]
            ]),
            cooldown: 8000,
            lastResponseTime: 0
        };
        
        this.bots.set("Priya", priyaBot);
        this.bots.set("Anjali", anjaliBot);
    }

    setupBotListener() {
        this.currentGroup = this.getGroupFromURL();
        
        this.botMessagesRef = firebase.database().ref(`groups/${this.currentGroup}/messages`).orderByChild("timestamp");
        
        this.botMessagesRef.on('child_added', (snapshot) => {
            const message = snapshot.val();
            this.processMessage(message);
        });
    }

    processMessage(message) {
        if (this.isBotMessage(message)) return;
        if (!message.text || message.text.trim() === '') return;
        
        const messageText = message.text.toLowerCase().trim();
        
        if (this.lastUserMessage === messageText) return;
        this.lastUserMessage = messageText;
        
        const availableBots = Array.from(this.bots.entries()).filter(([_, config]) => {
            const now = Date.now();
            return now - config.lastResponseTime >= config.cooldown;
        });
        
        if (availableBots.length === 0) return;
        
        const respondingBot = this.selectRespondingBot(availableBots, messageText);
        if (!respondingBot) return;
        
        const [botName, botConfig] = respondingBot;
        const response = this.getBotResponse(botConfig, messageText);
        
        if (response) {
            const delay = Math.random() * 5000 + 3000;
            
            setTimeout(() => {
                if (this.lastUserMessage === messageText) {
                    this.sendBotResponse(botName, response);
                    botConfig.lastResponseTime = Date.now();
                    this.lastBotResponder = botName;
                }
            }, delay);
        }
    }

    selectRespondingBot(availableBots, messageText) {
        const botsWithResponse = availableBots.filter(([_, config]) => 
            this.getBotResponse(config, messageText)
        );
        
        if (botsWithResponse.length === 0) return null;
        
        if (this.lastBotResponder) {
            const otherBots = botsWithResponse.filter(([name]) => name !== this.lastBotResponder);
            if (otherBots.length > 0) {
                return otherBots[Math.floor(Math.random() * otherBots.length)];
            }
        }
        
        return botsWithResponse[Math.floor(Math.random() * botsWithResponse.length)];
    }

    getBotResponse(botConfig, messageText) {
        if (botConfig.triggers.has(messageText)) {
            return botConfig.triggers.get(messageText);
        }
        
        for (const [trigger, response] of botConfig.triggers) {
            if (messageText.includes(trigger)) {
                return response;
            }
        }
        
        return null;
    }

    isBotMessage(message) {
        if (!message.nickname) return false;
        return this.bots.has(message.nickname);
    }

    sendBotResponse(botName, responseText) {
        const timestamp = Date.now();
        const message = {
            text: responseText,
            timestamp: timestamp,
            nickname: botName
        };
        
        const newMsgRef = firebase.database().ref(`groups/${this.currentGroup}/messages`).push();
        newMsgRef.set(message);
    }

    getGroupFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('group') || 'general';
    }
}

window.talkRushBot = new TalkRushBot();

window.addEventListener('load', () => {
    setTimeout(() => {
        window.talkRushBot.initialize();
    }, 2000);
});
</script>
