<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Size Reducer</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@2.15.0/dist/pdf-lib.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
</head>
<body>

<div>
    <input type="file" id="pdfInput" accept=".pdf">
</div>

<div id="pdfContainer">
    <!-- Your PDF content will be displayed here -->
</div>

<div>
    <input type="range" id="qualitySlider" min="0" max="1" step="0.01" value="1">
</div>

<button onclick="reduceAndDownloadPdf()">Reduce PDF Size and Download</button>

<script>
    function handleFile() {
        const fileInput = document.getElementById('pdfInput');
        const pdfContainer = document.getElementById('pdfContainer');
        const qualitySlider = document.getElementById('qualitySlider');

        const file = fileInput.files[0];
        if (!file) {
            showErrorDialog('Please select a PDF file.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            const content = e.target.result;
            renderPdf(content, pdfContainer, qualitySlider.value);
        };

        reader.onerror = function () {
            showErrorDialog('Error reading the PDF file.');
        };

        reader.readAsArrayBuffer(file);
    }

    async function renderPdf(data, container, quality) {
        const pdfContainer = container;
        const qualityValue = quality;

        const pdfDoc = await PDFLib.PDFDocument.load(data);
        const firstPage = pdfDoc.getPages()[0];

        if (!firstPage) {
            showErrorDialog('Error loading the PDF content.');
            return;
        }

        const { width, height } = firstPage.getSize();
        const imgData = await firstPage.render({ quality: qualityValue }).asBase64();

        pdfContainer.innerHTML = `<img src="data:image/png;base64,${imgData}" alt="PDF Preview" width="${width}" height="${height}" />`;
    }

    async function reduceAndDownloadPdf() {
        const pdfContainer = document.getElementById("pdfContainer");
        const qualitySlider = document.getElementById('qualitySlider');

        if (!pdfContainer.firstChild) {
            showErrorDialog('No PDF content to reduce.');
            return;
        }

        const canvas = await html2canvas(pdfContainer, { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', qualitySlider.value);

        const pdfDoc = await PDFLib.PDFDocument.create();
        const pdfPage = await pdfDoc.addPage();

        if (!pdfPage) {
            showErrorDialog('Error creating the PDF page.');
            return;
        }

        const img = await pdfDoc.embedPng(imgData);
        const { width, height } = img.scale(1);

        pdfPage.drawImage(img, {
            x: 0,
            y: 0,
            width: width,
            height: height,
        });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'reduced_pdf.pdf';
        link.click();
    }

    function showErrorDialog(message) {
        alert('Error: ' + message);
    }

    document.getElementById('pdfInput').addEventListener('change', handleFile);
</script>

</body>
</html>
