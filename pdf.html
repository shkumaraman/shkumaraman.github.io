<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="PDF converter, file conversion, image to PDF, online converter">
    <meta name="description"
        content="Convert images to PDF online with this simple and efficient file converter. Choose your image, click Convert, and download the converted PDF.">
    <title>PDF Converter</title>
    <script src="https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
    <style>
        /* Your existing styles remain unchanged */

        #pageCountInput {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h2>PDF Converter</h2>
    <hr class="line">
    <p>Click To Upload Your Image Here ðŸ‘‡</p>
    <!-- Update the file input to support multiple files -->
    <label for="fileInput">Browse File</label>
    <input type="file" id="fileInput" accept=".jpg, .jpeg, .png, .gif, .bmp, .webp" multiple>
    <br>
    <label for="pageCountInput">Number of Pages:</label>
    <input type="number" id="pageCountInput" min="1" value="1">
    <br>
    <button id="convertButton" onclick="convertFile()">Convert</button>

    <div id="loadingScreen">
        <div id="loadingContainer">
            <div class="loader"></div>
        </div>
    </div>

    <div id="outputContainer">
        <a id="outputLink" download="converted_file">Download Converted File</a>
        <!-- Display the merged PDF link -->
        <a id="mergeOutputLink" download="merged_file">Download Merged PDF</a>
    </div>

    <script>
        async function convertFile() {
            const fileInput = document.getElementById('fileInput');
            const pageCountInput = document.getElementById('pageCountInput');
            const outputContainer = document.getElementById('outputContainer');
            const outputLink = document.getElementById('outputLink');
            const mergeOutputLink = document.getElementById('mergeOutputLink');
            const loadingScreen = document.getElementById('loadingScreen');

            if (fileInput.files.length === 0) {
                alert('Please choose at least one file.');
                return;
            }

            loadingScreen.style.display = 'flex';

            const inputFiles = fileInput.files;
            const pageCount = parseInt(pageCountInput.value) || 1;

            const convertedFile = await convertToPDF(inputFiles, pageCount);

            if (convertedFile) {
                const blobUrl = URL.createObjectURL(convertedFile);
                outputLink.href = blobUrl;
                outputLink.style.display = 'inline-block';
                outputContainer.style.display = 'block';

                // Display the merged PDF link
                mergeOutputLink.href = blobUrl;
                mergeOutputLink.style.display = 'inline-block';
            }

            loadingScreen.style.display = 'none';
        }

        function convertToPDF(imageFiles, pageCount) {
            return new Promise(resolve => {
                const promises = Array.from(imageFiles).map(imageFile => {
                    return new Promise(innerResolve => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const img = new Image();
                            img.src = reader.result;

                            img.onload = () => {
                                const canvases = Array(pageCount).fill(null).map(() => {
                                    const canvas = document.createElement('canvas');
                                    let maxWidth = 800; // Adjust this value as needed
                                    let maxHeight = 1000; // Adjust this value as needed

                                    if (img.width > maxWidth || img.height > maxHeight) {
                                        const aspectRatio = img.width / img.height;
                                        if (aspectRatio > 1) {
                                            canvas.width = maxWidth;
                                            canvas.height = maxWidth / aspectRatio;
                                        } else {
                                            canvas.width = maxHeight * aspectRatio;
                                            canvas.height = maxHeight;
                                        }
                                    } else {
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                    }

                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                                    return canvas;
                                });

                                // Resolve the promise with the canvases
                                innerResolve(canvases);
                            };
                        };

                        reader.readAsDataURL(imageFile);
                    });
                });

                // Wait for all promises to resolve
                Promise.all(promises).then(allCanvases => {
                    // Merge canvases or handle as needed
                    const mergedCanvases = mergeCanvases(allCanvases);

                    // Perform PDF conversion on the merged canvases
                    html2pdf(mergedCanvases, {
                        margin: 10,
                        filename: 'merged_file.pdf',
                        jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' },
                        image: { type: 'jpeg', quality: 1 },
                        output: 'blob',
                        html2canvas: { scale: 1 }
                    }).then(pdf => {
                        resolve(pdf);
                    });
                });
            });
        }

        function mergeCanvases(allCanvases) {
            const mergedCanvas = document.createElement('canvas');
            const context = mergedCanvas.getContext('2d');

            // Set canvas size based on the first canvas dimensions
            mergedCanvas.width = allCanvases[0][0].width;
            mergedCanvas.height = allCanvases[0].reduce((totalHeight, canvas) => totalHeight + canvas.height, 0);

            allCanvases.forEach(canvases => {
                canvases.forEach(canvas => {
                    context.drawImage(canvas, 0, mergedCanvas.height);
                    mergedCanvas.height += canvas.height;
                });
            });

            return mergedCanvas;
        }
    </script>
</body>

</html>
