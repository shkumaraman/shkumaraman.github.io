<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicPlay - JioSaavn Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --accent-color: #1db954;
            --text-primary: #ffffff;
            --text-secondary: #bbbbbb;
            --track-height: 50px;
            --header-height: 50px;
            --tab-height: 50px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: calc(var(--header-height) + var(--tab-height) + 5px);
            padding-bottom: 180px;
            line-height: 1.6;
            position: relative;
        }
        
        /* Fixed Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .brand {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-color);
        }
        
        /* Tabs */
        .tabs {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            height: var(--tab-height);
            display: flex;
            background: rgba(18, 18, 18, 0.9);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .tab-content {
            display: none;
            padding: 10px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        #search-container {
            display: flex;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 30px;
            overflow: hidden;
            background: var(--bg-secondary);
            height: 40px;
        }
        
        #search {
            flex: 1;
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }
        
        #search::placeholder {
            color: #888;
        }
        
        #search-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            margin: 2px;
        }
        
        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border-radius: 15px;
            background: var(--bg-secondary);
            border: 1px solid #333;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        #results, #trending-results, #played-results {
            margin-top: 10px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }
        
        .track {
            display: flex;
            align-items: center;
            height: var(--track-height);
            margin: 8px 0;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .track:hover {
            background: #2a2a2a;
            transform: translateY(-2px);
        }
        
        .track.playing {
            background: #1db95433;
            border-left: 4px solid var(--accent-color);
        }
        
        .track img {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            margin-right: 12px;
            object-fit: cover;
        }
        
        .track-info {
            flex: 1;
            overflow: hidden;
        }
        
        .track-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-channel {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .playlist-dropdown {
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: none;
        }
        
        .playlist-dropdown.active {
            display: block;
        }
        
        .playlist-track {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .playlist-track:hover {
            background: #2a2a2a;
        }
        
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        
        .close-playlist {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
        }
        
        .player-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            padding: 12px 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .player-bg-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            z-index: -1;
            filter: blur(8px);
        }
        
        .player-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .now-playing {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }
        
        .now-playing img {
            width: 45px;
            height: 45px;
            border-radius: 5px;
            margin-right: 12px;
        }
        
        .track-details {
            flex: 1;
            min-width: 0;
        }
        
        .track-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .channel-name {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 2;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            margin: 0 8px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .play-pause {
            background: var(--accent-color);
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .play-pause:hover {
            background: #1ed760;
        }
        
        .player-options {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
            gap: 15px;
        }
        
        #player {
            display: none;
        }
        
        .progress-container {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 8px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 2px;
            width: 0%;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .error-message {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        /* Fullscreen player styles */
        .fullscreen-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .fullscreen-player.active {
            opacity: 1;
            visibility: visible;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 2001;
        }
        
        .fullscreen-thumbnail {
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .fullscreen-track-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .fullscreen-track-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .fullscreen-channel-name {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .fullscreen-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .fullscreen-control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            margin: 0 15px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .fullscreen-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .fullscreen-play-pause {
            background: var(--accent-color);
            width: 60px;
            height: 60px;
            font-size: 20px;
        }
        
        .fullscreen-play-pause:hover {
            background: #1ed760;
        }
        
        .fullscreen-progress-container {
            width: 80%;
            max-width: 500px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .fullscreen-progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            width: 0%;
        }
        
        .fullscreen-time-display {
            display: flex;
            justify-content: space-between;
            width: 80%;
            max-width: 500px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .fullscreen-options {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 80%;
            max-width: 500px;
            margin: 20px auto 0;
        }
        
        .mute-btn.active {
            color: var(--accent-color);
        }
        
        .auto-play-btn.active {
            color: var(--accent-color);
        }

        .inactive {
            opacity: 0.5;
            pointer-events: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .player-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .now-playing, .player-controls, .player-options {
                width: 100%;
                justify-content: center;
            }
            
            .track-name {
                max-width: 150px;
            }
            
            .brand {
                font-size: 1.3rem;
            }
            
            .fullscreen-thumbnail {
                width: 90%;
            }
            
            .fullscreen-control-btn {
                margin: 0 10px;
            }
            
            .player-options {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header">
        <div class="brand">MusicPlay - JioSaavn</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="trending">Trending</div>
        <div class="tab" data-tab="search">Search</div>
        <div class="tab" data-tab="played">Played</div>
    </div>

    <div class="container">
        <!-- Trending Tab Content -->
        <div class="tab-content active" id="trending-tab">
            <div id="trending-results"></div>
        </div>

        <!-- Search Tab Content -->
        <div class="tab-content" id="search-tab">
            <div id="search-container">
                <input type="text" id="search" placeholder="Search for a song or artist...">
                <button id="search-btn" onclick="searchContent()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="search-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="songs">Songs</button>
                <button class="filter-btn" data-filter="albums">Albums</button>
                <button class="filter-btn" data-filter="playlists">Playlists</button>
                <button class="filter-btn" data-filter="artists">Artists</button>
            </div>
            <div id="playlist-dropdown" class="playlist-dropdown"></div>
            <div id="results"></div>
        </div>

        <!-- Played Tab Content -->
        <div class="tab-content" id="played-tab">
            <div id="played-results"></div>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
    </div>

    <div class="player-section">
        <div class="player-bg-thumbnail" id="bg-thumbnail"></div>
        <div class="player-container">
            <div class="now-playing" id="open-fullscreen">
                <img id="current-thumbnail" src="https://placehold.co/600x400@2x.png" alt="Now playing">
                <div class="track-details">
                    <div id="current-title" class="track-name">Nothing playing</div>
                    <div id="current-channel" class="channel-name">Select a song to begin</div>
                </div>
            </div>

            <div class="player-controls">
                <button class="control-btn" onclick="shuffleTracks()" title="Shuffle">
                    <i class="fas fa-random"></i>
                </button>
                <button class="control-btn" onclick="previousTrack()" title="Previous">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-pause" onclick="togglePlay()" title="Play/Pause" id="play-pause-btn">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" onclick="nextTrack()" title="Next">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-btn" onclick="toggleLoop()" title="Loop" id="loop-btn">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <div class="player-options">
                <button class="control-btn auto-play-btn" id="auto-play-btn" onclick="toggleAutoPlay()" title="Auto Play">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <button class="control-btn mute-btn" id="mute-btn" onclick="toggleMute()" title="Mute">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="time-display">
            <span id="current-time">0:00</span>
            <span id="duration">0:00</span>
        </div>
    </div>

    <!-- Fullscreen Player -->
    <div class="fullscreen-player" id="fullscreen-player">
        <button class="fullscreen-close" onclick="closeFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        <img class="fullscreen-thumbnail" id="fullscreen-thumbnail" src="https://placehold.co/600x400@2x.png" alt="Track thumbnail">
        <div class="fullscreen-track-info">
            <div class="fullscreen-track-name" id="fullscreen-track-name"></div>
            <div class="fullscreen-channel-name" id="fullscreen-channel-name"></div>
        </div>
        <div class="fullscreen-controls">
            <button class="fullscreen-control-btn" onclick="shuffleTracks()" title="Shuffle">
                <i class="fas fa-random"></i>
            </button>
            <button class="fullscreen-control-btn" onclick="previousTrack()" title="Previous">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="fullscreen-control-btn fullscreen-play-pause" onclick="togglePlay()" title="Play/Pause" id="fullscreen-play-pause-btn">
                <i class="fas fa-play"></i>
            </button>
            <button class="fullscreen-control-btn" onclick="nextTrack()" title="Next">
                <i class="fas fa-step-forward"></i>
            </button>
            <button class="fullscreen-control-btn" onclick="toggleLoop()" title="Loop" id="fullscreen-loop-btn">
                <i class="fas fa-redo"></i>
            </button>
        </div>
        <div class="fullscreen-progress-container" id="fullscreen-progress-container">
            <div class="fullscreen-progress-bar" id="fullscreen-progress-bar"></div>
        </div>
        <div class="fullscreen-time-display">
            <span id="fullscreen-current-time">0:00</span>
            <span id="fullscreen-duration">0:00</span>
        </div>
        <div class="fullscreen-options">
            <button class="fullscreen-control-btn auto-play-btn" id="fullscreen-auto-play-btn" onclick="toggleAutoPlay()" title="Auto Play">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            <button class="fullscreen-control-btn mute-btn" id="fullscreen-mute-btn" onclick="toggleMute()" title="Mute">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    </div>

    <audio id="player" controls></audio>

    <script>
        // Global variables
        var player = document.getElementById('player');
        var currentTrackIndex = 0;
        var tracks = [];
        var isShuffled = false;
        var isLooping = false;
        var isAutoPlay = false;
        var isMuted = false;
        var isPlaying = false;
        var originalTracksOrder = [];
        var trendingSongs = [];
        var searchTimeout = null;
        var appConfig = {};
        var playedSongs = [];
        var currentFilter = 'all';
        var currentPlaylistId = null;
        var playlistItems = [];
        var currentTrackSource = null; // 'trending', 'search', 'playlist', 'played'
        var apiBaseUrl = 'https://jiosaavn-ygm1.onrender.com';

        // Track type constants
        const TRACK_TYPES = {
            TRENDING: 'trending',
            SEARCH: 'search',
            PLAYLIST: 'playlist',
            PLAYED: 'played'
        };

        // Load configuration from manage.json
        async function loadConfig() {
            try {
                const response = await fetch('manage.json');
                appConfig = await response.json();
                
                // Set API base URL if specified in config
                if (appConfig.jiosaavnConfig && appConfig.jiosaavnConfig.apiBaseUrl) {
                    apiBaseUrl = appConfig.jiosaavnConfig.apiBaseUrl;
                }
            } catch (error) {
                console.error("Error loading configuration:", error);
                showError("Configuration error. Please try again later.");
            }
        }

        // Tab switching functionality
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // Load content based on tab
                    if (tabName === 'played') {
                        loadPlayedSongs();
                    } else if (tabName === 'trending') {
                        if (trendingSongs.length === 0) {
                            loadTrendingSongs();
                        }
                    }
                });
            });
        }

        // Switch to search tab
        function switchToSearchTab() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === 'search') {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === 'search-tab') {
                    content.classList.add('active');
                }
            });
        }

        // Initialize player
        function initPlayer() {
            player.addEventListener('timeupdate', updateProgressBar);
            player.addEventListener('ended', onPlayerEnded);
            player.addEventListener('play', onPlayerPlay);
            player.addEventListener('pause', onPlayerPause);
            
            // Load configuration
            loadConfig().then(() => {
                // Setup tabs
                setupTabs();
                
                // Setup search filters
                setupSearchFilters();
                
                // Load trending songs when player is ready
                loadTrendingSongs();
                
                // Add debounce to search input
                document.getElementById("search").addEventListener("input", function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        if (document.getElementById("search").value.trim() !== "") {
                            searchContent();
                        }
                    }, 500);
                });
                
                // Add click event to open fullscreen player
                document.getElementById("open-fullscreen").addEventListener("click", openFullscreen);
                
                // Add click event to fullscreen progress bar
                document.getElementById("fullscreen-progress-container").addEventListener('click', function(e) {
                    if (!player.duration) return;
                    
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const seekTime = (clickX / width) * player.duration;
                    
                    player.currentTime = seekTime;
                });
            });
        }

        // Setup search filter buttons
        function setupSearchFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active filter
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentFilter = this.getAttribute('data-filter');
                    
                    // If we have a search query, perform search with new filter
                    const query = document.getElementById("search").value;
                    if (query) {
                        searchContent();
                    }
                });
            });
        }

        function onPlayerEnded() {
            if (isLooping) {
                player.play();
            } else if (isAutoPlay) {
                nextTrack();
            }
        }

        function onPlayerPlay() {
            isPlaying = true;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            document.getElementById('fullscreen-play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
        }

        function onPlayerPause() {
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
            document.getElementById('fullscreen-play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
        }

        // Cache management functions
        function setCache(key, data, expiryHours = 6) {
            const now = new Date();
            const item = {
                value: data,
                expiry: now.getTime() + (expiryHours * 60 * 60 * 1000),
            };
            localStorage.setItem(key, JSON.stringify(item));
        }

        function getCache(key) {
            const itemStr = localStorage.getItem(key);
            if (!itemStr) return null;
            
            const item = JSON.parse(itemStr);
            const now = new Date();
            
            if (now.getTime() > item.expiry) {
                localStorage.removeItem(key);
                return null;
            }
            return item.value;
        }

        // Extract track info from different data structures
        function extractTrackInfo(track, source) {
            let id, title, artist, thumbnail, mediaUrl, duration;
            
            switch(source) {
                case TRACK_TYPES.PLAYLIST:
                    id = track.id;
                    title = track.title || track.song;
                    artist = track.primary_artists || track.artist;
                    thumbnail = track.image || track.thumbnail;
                    mediaUrl = track.media_url || track.perma_url;
                    duration = track.duration || 0;
                    break;
                    
                case TRACK_TYPES.PLAYED:
                    id = track.id;
                    title = track.title || track.song;
                    artist = track.primary_artists || track.artist;
                    thumbnail = track.image || track.thumbnail;
                    mediaUrl = track.media_url || track.perma_url;
                    duration = track.duration || 0;
                    break;
                    
                default: // TRENDING and SEARCH
                    id = track.id;
                    title = track.title || track.song;
                    artist = track.primary_artists || track.artist || (track.more_info && track.more_info.artistMap && track.more_info.artistMap.artists && track.more_info.artistMap.artists[0] && track.more_info.artistMap.artists[0].name);
                    thumbnail = track.image || track.thumbnail;
                    mediaUrl = track.media_url || track.perma_url || (track.more_info && track.more_info.encrypted_media_url);
                    duration = track.duration || 0;
            }
            
            return { id, title, artist, thumbnail, mediaUrl, duration };
        }

        // Create track element
        function createTrackElement(track, index, source, isPlaylistItem = false) {
            const { title, artist, thumbnail } = extractTrackInfo(track, source);
            
            const trackElement = document.createElement("div");
            trackElement.className = isPlaylistItem ? "playlist-track" : "track";
            trackElement.dataset.index = index;

            const img = document.createElement("img");
            img.src = thumbnail || 'https://placehold.co/600x400@2x.png';
            if (isPlaylistItem) {
                img.style.width = "30px";
                img.style.height = "30px";
                img.style.marginRight = "10px";
            }

            const trackInfo = document.createElement("div");
            trackInfo.className = "track-info";

            const titleDiv = document.createElement("div");
            titleDiv.className = "track-title";
            titleDiv.textContent = title || 'Unknown Title';
            if (isPlaylistItem) {
                titleDiv.style.fontSize = "13px";
            }

            const channelDiv = document.createElement("div");
            channelDiv.className = "track-channel";
            channelDiv.textContent = artist || 'Unknown Artist';
            if (isPlaylistItem) {
                channelDiv.style.fontSize = "11px";
            }

            trackInfo.appendChild(titleDiv);
            trackInfo.appendChild(channelDiv);

            trackElement.appendChild(img);
            trackElement.appendChild(trackInfo);

            return trackElement;
        }

        // Save played song to history
        function savePlayedSong(track, source) {
            const playedSongsStr = localStorage.getItem('playedSongs');
            let playedSongs = playedSongsStr ? JSON.parse(playedSongsStr) : [];
            
            const trackWithSource = { ...track, source: source };

            const existingIndex = playedSongs.findIndex(song => song.id === track.id);

            if (existingIndex !== -1) {
                playedSongs.splice(existingIndex, 1);
            }

            playedSongs.unshift(trackWithSource);

            // History limit from manage.json
            const limit = appConfig.jiosaavnConfig?.settings?.playedSongsLimit || 50;
            if (playedSongs.length > limit) {
                playedSongs = playedSongs.slice(0, limit);
            }

            localStorage.setItem('playedSongs', JSON.stringify(playedSongs));
        }

        // Load played songs from history
        function loadPlayedSongs() {
            const playedSongsStr = localStorage.getItem('playedSongs');
            const playedSongs = playedSongsStr ? JSON.parse(playedSongsStr) : [];
            
            const playedDiv = document.getElementById("played-results");
            playedDiv.innerHTML = "";
            
            if (playedSongs.length === 0) {
                playedDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No recently played songs</div>';
                return;
            }
            
            playedSongs.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, TRACK_TYPES.PLAYED);
                
                trackElement.onclick = () => {
                    // Set the tracks array to played songs
                    tracks = playedSongs;
                    originalTracksOrder = [...tracks];
                    currentTrackSource = TRACK_TYPES.PLAYED;
                    playTrack(index);
                };

                playedDiv.appendChild(trackElement);
            });
        }

        // API call with retry logic
        async function fetchWithRetry(url, retries = 3, backoff = 300) {
            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, retries - 1, backoff * 2);
                } else {
                    throw error;
                }
            }
        }

        // Load trending songs
        async function loadTrendingSongs() {
            const cacheKey = 'trending_songs';
            const cachedData = getCache(cacheKey);
            
            if (cachedData) {
                displayTrendingSongs(cachedData);
                return;
            }
            
            try {
                document.getElementById("trending-results").innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                
                const url = `${apiBaseUrl}/topcharts/`;
                const data = await fetchWithRetry(url);
                
                if (data && data.songs) {
                    setCache(cacheKey, data.songs);
                    displayTrendingSongs(data.songs);
                } else {
                    throw new Error("No trending songs found");
                }
            } catch (error) {
                console.error("Error loading trending songs:", error);
                showError("Unable to load songs. Please try again later.");
                document.getElementById("trending-results").innerHTML = "";
            }
        }

        function displayTrendingSongs(songs) {
            const trendingDiv = document.getElementById("trending-results");
            trendingDiv.innerHTML = "";
            
            trendingSongs = songs;
            
            songs.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, TRACK_TYPES.TRENDING);
                
                trackElement.onclick = () => {
                    // Set the tracks array to trending songs
                    tracks = trendingSongs;
                    originalTracksOrder = [...tracks];
                    currentTrackSource = TRACK_TYPES.TRENDING;
                    playTrack(index);
                };

                trendingDiv.appendChild(trackElement);
            });
        }

        // Search for content
        async function searchContent() {
            const query = document.getElementById("search").value;
            if (!query) return;

            // Switch to search tab
            switchToSearchTab();
            
            // Check cache first
            const cacheKey = `search_${query}_${currentFilter}`;
            const cachedData = getCache(cacheKey);
            
            if (cachedData) {
                displaySearchResults(cachedData);
                return;
            }
            
            try {
                document.getElementById("results").innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                hideError();
                
                let url;
                if (currentFilter === 'all') {
                    url = `${apiBaseUrl}/result/?query=${encodeURIComponent(query)}`;
                } else if (currentFilter === 'songs') {
                    url = `${apiBaseUrl}/result/?query=${encodeURIComponent(query)}`;
                } else if (currentFilter === 'albums') {
                    url = `${apiBaseUrl}/album/?query=${encodeURIComponent(query)}`;
                } else if (currentFilter === 'playlists') {
                    url = `${apiBaseUrl}/playlist/?query=${encodeURIComponent(query)}`;
                } else if (currentFilter === 'artists') {
                    url = `${apiBaseUrl}/artist/?query=${encodeURIComponent(query)}`;
                }
                
                const data = await fetchWithRetry(url);
                
                if (data && (data.songs || data.albums || data.playlists || data.artists)) {
                    setCache(cacheKey, data);
                    displaySearchResults(data);
                } else {
                    throw new Error("No results found");
                }
            } catch (error) {
                console.error("Error searching content:", error);
                showError("Unable to search. Please check your connection and try again.");
                document.getElementById("results").innerHTML = "";
            }
        }

        function displaySearchResults(data) {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";

            // Hide playlist dropdown
            document.getElementById('playlist-dropdown').classList.remove('active');
            currentPlaylistId = null;

            if (currentFilter === 'playlists' && data.playlists) {
                // Display playlists
                data.playlists.forEach((item, index) => {
                    const playlistId = item.id;
                    const title = item.title;
                    const artist = "Playlist";
                    const thumbnail = item.image;

                    const trackElement = document.createElement("div");
                    trackElement.className = "track";
                    trackElement.dataset.playlistId = playlistId;

                    const img = document.createElement("img");
                    img.src = thumbnail || 'https://placehold.co/600x400@2x.png';
                    img.style.width = "40px";
                    img.style.height = "40px";
                    img.style.borderRadius = "5px";
                    img.style.marginRight = "12px";

                    const trackInfo = document.createElement("div");
                    trackInfo.className = "track-info";

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "track-title";
                    titleDiv.textContent = title || 'Unknown Playlist';

                    const channelDiv = document.createElement("div");
                    channelDiv.className = "track-channel";
                    channelDiv.textContent = artist;

                    trackInfo.appendChild(titleDiv);
                    trackInfo.appendChild(channelDiv);

                    trackElement.appendChild(img);
                    trackElement.appendChild(trackInfo);

                    trackElement.onclick = () => {
                        loadPlaylistItems(playlistId);
                    };

                    resultsDiv.appendChild(trackElement);
                });
            } else if (currentFilter === 'albums' && data.albums) {
                // Display albums
                data.albums.forEach((item, index) => {
                    const albumId = item.id;
                    const title = item.title;
                    const artist = item.primary_artists;
                    const thumbnail = item.image;

                    const trackElement = document.createElement("div");
                    trackElement.className = "track";
                    trackElement.dataset.albumId = albumId;

                    const img = document.createElement("img");
                    img.src = thumbnail || 'https://placehold.co/600x400@2x.png';
                    img.style.width = "40px";
                    img.style.height = "40px";
                    img.style.borderRadius = "5px";
                    img.style.marginRight = "12px";

                    const trackInfo = document.createElement("div");
                    trackInfo.className = "track-info";

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "track-title";
                    titleDiv.textContent = title || 'Unknown Album';

                    const channelDiv = document.createElement("div");
                    channelDiv.className = "track-channel";
                    channelDiv.textContent = artist || 'Unknown Artist';

                    trackInfo.appendChild(titleDiv);
                    trackInfo.appendChild(channelDiv);

                    trackElement.appendChild(img);
                    trackElement.appendChild(trackInfo);

                    trackElement.onclick = () => {
                        loadAlbumSongs(albumId);
                    };

                    resultsDiv.appendChild(trackElement);
                });
            } else if (currentFilter === 'artists' && data.artists) {
                // Display artists
                data.artists.forEach((item, index) => {
                    const artistId = item.id;
                    const title = item.title;
                    const thumbnail = item.image;

                    const trackElement = document.createElement("div");
                    trackElement.className = "track";
                    trackElement.dataset.artistId = artistId;

                    const img = document.createElement("img");
                    img.src = thumbnail || 'https://placehold.co/600x400@2x.png';
                    img.style.width = "40px";
                    img.style.height = "40px";
                    img.style.borderRadius = "5px";
                    img.style.marginRight = "12px";

                    const trackInfo = document.createElement("div");
                    trackInfo.className = "track-info";

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "track-title";
                    titleDiv.textContent = title || 'Unknown Artist';

                    const channelDiv = document.createElement("div");
                    channelDiv.className = "track-channel";
                    channelDiv.textContent = "Artist";

                    trackInfo.appendChild(titleDiv);
                    trackInfo.appendChild(channelDiv);

                    trackElement.appendChild(img);
                    trackElement.appendChild(trackInfo);

                    trackElement.onclick = () => {
                        loadArtistSongs(artistId);
                    };

                    resultsDiv.appendChild(trackElement);
                });
            } else if ((currentFilter === 'all' || currentFilter === 'songs') && data.songs) {
                // Display songs
                tracks = data.songs;
                originalTracksOrder = [...tracks];
                currentTrackSource = TRACK_TYPES.SEARCH;

                data.songs.forEach((item, index) => {
                    const trackElement = createTrackElement(item, index, TRACK_TYPES.SEARCH);
                    
                    trackElement.onclick = () => {
                        playTrack(index);
                    };

                    resultsDiv.appendChild(trackElement);
                });
            } else {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No results found</div>';
            }
        }

        // Load playlist items
        async function loadPlaylistItems(playlistId) {
            try {
                document.getElementById("playlist-dropdown").innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                document.getElementById("playlist-dropdown").classList.add('active');
                
                const cacheKey = `playlist_${playlistId}`;
                const cachedData = getCache(cacheKey);
                
                if (cachedData) {
                    displayPlaylistItems(cachedData, playlistId);
                    return;
                }
                
                const url = `${apiBaseUrl}/playlist/?query=${playlistId}`;
                const data = await fetchWithRetry(url);
                
                if (data && data.songs) {
                    setCache(cacheKey, data.songs);
                    displayPlaylistItems(data.songs, playlistId);
                } else {
                    throw new Error("No playlist items found");
                }
            } catch (error) {
                console.error("Error loading playlist items:", error);
                showError("Unable to load playlist. Please try again later.");
            }
        }

        function displayPlaylistItems(songs, playlistId) {
            const playlistDropdown = document.getElementById("playlist-dropdown");
            playlistDropdown.innerHTML = "";
            
            playlistItems = songs;
            
            // Create header with playlist title and close button
            const header = document.createElement("div");
            header.className = "playlist-header";
            
            const title = document.createElement("h3");
            title.textContent = "Playlist Tracks";
            title.style.margin = "0";
            title.style.fontSize = "14px";
            
            const closeBtn = document.createElement("button");
            closeBtn.className = "close-playlist";
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = () => {
                playlistDropdown.classList.remove('active');
                currentPlaylistId = null;
            };
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            playlistDropdown.appendChild(header);
            
            // Add playlist items
            songs.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, TRACK_TYPES.PLAYLIST, true);
                
                trackElement.onclick = () => {
                    // Set tracks to playlist items and play
                    tracks = playlistItems;
                    originalTracksOrder = [...tracks];
                    currentTrackSource = TRACK_TYPES.PLAYLIST;
                    currentPlaylistId = playlistId;
                    playTrack(index);
                    
                    // Close playlist dropdown
                    playlistDropdown.classList.remove('active');
                };

                playlistDropdown.appendChild(trackElement);
            });
            
            currentPlaylistId = playlistId;
        }

        // Load album songs
        async function loadAlbumSongs(albumId) {
            try {
                document.getElementById("playlist-dropdown").innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                document.getElementById("playlist-dropdown").classList.add('active');
                
                const cacheKey = `album_${albumId}`;
                const cachedData = getCache(cacheKey);
                
                if (cachedData) {
                    displayAlbumSongs(cachedData, albumId);
                    return;
                }
                
                const url = `${apiBaseUrl}/album/?query=${albumId}`;
                const data = await fetchWithRetry(url);
                
                if (data && data.songs) {
                    setCache(cacheKey, data.songs);
                    displayAlbumSongs(data.songs, albumId);
                } else {
                    throw new Error("No album songs found");
                }
            } catch (error) {
                console.error("Error loading album songs:", error);
                showError("Unable to load album. Please try again later.");
            }
        }

        function displayAlbumSongs(songs, albumId) {
            const playlistDropdown = document.getElementById("playlist-dropdown");
            playlistDropdown.innerHTML = "";
            
            playlistItems = songs;
            
            // Create header with album title and close button
            const header = document.createElement("div");
            header.className = "playlist-header";
            
            const title = document.createElement("h3");
            title.textContent = "Album Tracks";
            title.style.margin = "0";
            title.style.fontSize = "14px";
            
            const closeBtn = document.createElement("button");
            closeBtn.className = "close-playlist";
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = () => {
                playlistDropdown.classList.remove('active');
                currentPlaylistId = null;
            };
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            playlistDropdown.appendChild(header);
            
            // Add album songs
            songs.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, TRACK_TYPES.PLAYLIST, true);
                
                trackElement.onclick = () => {
                    // Set tracks to album songs and play
                    tracks = playlistItems;
                    originalTracksOrder = [...tracks];
                    currentTrackSource = TRACK_TYPES.PLAYLIST;
                    currentPlaylistId = albumId;
                    playTrack(index);
                    
                    // Close playlist dropdown
                    playlistDropdown.classList.remove('active');
                };

                playlistDropdown.appendChild(trackElement);
            });
            
            currentPlaylistId = albumId;
        }

        // Load artist songs
        async function loadArtistSongs(artistId) {
            try {
                document.getElementById("playlist-dropdown").innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                document.getElementById("playlist-dropdown").classList.add('active');
                
                const cacheKey = `artist_${artistId}`;
                const cachedData = getCache(cacheKey);
                
                if (cachedData) {
                    displayArtistSongs(cachedData, artistId);
                    return;
                }
                
                const url = `${apiBaseUrl}/artist/?query=${artistId}`;
                const data = await fetchWithRetry(url);
                
                if (data && data.topSongs) {
                    setCache(cacheKey, data.topSongs);
                    displayArtistSongs(data.topSongs, artistId);
                } else {
                    throw new Error("No artist songs found");
                }
            } catch (error) {
                console.error("Error loading artist songs:", error);
                showError("Unable to load artist. Please try again later.");
            }
        }

        function displayArtistSongs(songs, artistId) {
            const playlistDropdown = document.getElementById("playlist-dropdown");
            playlistDropdown.innerHTML = "";
            
            playlistItems = songs;
            
            // Create header with artist title and close button
            const header = document.createElement("div");
            header.className = "playlist-header";
            
            const title = document.createElement("h3");
            title.textContent = "Artist Top Songs";
            title.style.margin = "0";
            title.style.fontSize = "14px";
            
            const closeBtn = document.createElement("button");
            closeBtn.className = "close-playlist";
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = () => {
                playlistDropdown.classList.remove('active');
                currentPlaylistId = null;
            };
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            playlistDropdown.appendChild(header);
            
            // Add artist songs
            songs.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, TRACK_TYPES.PLAYLIST, true);
                
                trackElement.onclick = () => {
                    // Set tracks to artist songs and play
                    tracks = playlistItems;
                    originalTracksOrder = [...tracks];
                    currentTrackSource = TRACK_TYPES.PLAYLIST;
                    currentPlaylistId = artistId;
                    playTrack(index);
                    
                    // Close playlist dropdown
                    playlistDropdown.classList.remove('active');
                };

                playlistDropdown.appendChild(trackElement);
            });
            
            currentPlaylistId = artistId;
        }

        // Error handling functions
        function showError(message) {
            const errorDiv = document.getElementById("error-message");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
        }

        function hideError() {
            document.getElementById("error-message").style.display = "none";
        }

        // Enable search on Enter key
        document.getElementById("search").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                clearTimeout(searchTimeout);
                searchContent();
            }
        });

        // Play a specific track
        function playTrack(index) {
            if (tracks.length === 0) return;
            
            // Remove playing class from all tracks
            document.querySelectorAll('.track').forEach(track => {
                track.classList.remove('playing');
            });
            
            // Add playing class to current track
            const allTracks = document.querySelectorAll('.track');
            if (allTracks[index]) {
                allTracks[index].classList.add('playing');
            }
            
            currentTrackIndex = index;
            
            const { title, artist, thumbnail, mediaUrl } = extractTrackInfo(tracks[index], currentTrackSource);
            
            // Set audio source
            player.src = mediaUrl;
            player.play();
            
            // Update UI
            document.getElementById('current-title').textContent = title || 'Unknown Title';
            document.getElementById('current-channel').textContent = artist || 'Unknown Artist';
            document.getElementById('current-thumbnail').src = thumbnail || 'https://placehold.co/600x400@2x.png';
            
            // Update fullscreen player
            document.getElementById('fullscreen-track-name').textContent = title || 'Unknown Title';
            document.getElementById('fullscreen-channel-name').textContent = artist || 'Unknown Artist';
            document.getElementById('fullscreen-thumbnail').src = thumbnail || 'https://placehold.co/600x400@2x.png';
            
            // Set background thumbnail with blur effect
            document.getElementById('bg-thumbnail').style.backgroundImage = `url(${thumbnail || 'https://placehold.co/600x400@2x.png'})`;
            
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            document.getElementById('fullscreen-play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
            
            // Save to played history
            savePlayedSong(tracks[index], currentTrackSource);
        }

        // Toggle play/pause
        function togglePlay() {
            if (!player.src) {
                if (tracks.length > 0) {
                    playTrack(0);
                }
                return;
            }
            
            if (isPlaying) {
                player.pause();
            } else {
                player.play();
            }
        }

        // Play next track
        function nextTrack() {
            if (tracks.length === 0) return;
            
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= tracks.length) {
                nextIndex = 0;
            }
            
            playTrack(nextIndex);
        }

        // Play previous track
        function previousTrack() {
            if (tracks.length === 0) return;
            
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) {
                prevIndex = tracks.length - 1;
            }
            
            playTrack(prevIndex);
        }

        // Toggle loop
        function toggleLoop() {
            isLooping = !isLooping;
            const loopBtn = document.getElementById('loop-btn');
            const fullscreenLoopBtn = document.getElementById('fullscreen-loop-btn');
            const autoPlayBtn = document.getElementById('auto-play-btn');
            const fullscreenAutoPlayBtn = document.getElementById('fullscreen-auto-play-btn');

            if (isLooping) {
                loopBtn.style.color = 'var(--accent-color)';
                fullscreenLoopBtn.style.color = 'var(--accent-color)';

                // Disable autoplay
                isAutoPlay = false;
                autoPlayBtn.classList.remove('active');
                fullscreenAutoPlayBtn.classList.remove('active');
                autoPlayBtn.classList.add('inactive');
                fullscreenAutoPlayBtn.classList.add('inactive');
            } else {
                loopBtn.style.color = '';
                fullscreenLoopBtn.style.color = '';

                // Enable autoplay button again
                autoPlayBtn.classList.remove('inactive');
                fullscreenAutoPlayBtn.classList.remove('inactive');
            }
        }

        // Toggle autoplay
        function toggleAutoPlay() {
            isAutoPlay = !isAutoPlay;
            const autoPlayBtn = document.getElementById('auto-play-btn');
            const fullscreenAutoPlayBtn = document.getElementById('fullscreen-auto-play-btn');
            const loopBtn = document.getElementById('loop-btn');
            const fullscreenLoopBtn = document.getElementById('fullscreen-loop-btn');

            if (isAutoPlay) {
                autoPlayBtn.classList.add('active');
                fullscreenAutoPlayBtn.classList.add('active');

                // Disable loop
                isLooping = false;
                loopBtn.style.color = '';
                fullscreenLoopBtn.style.color = '';
                loopBtn.classList.add('inactive');
                fullscreenLoopBtn.classList.add('inactive');
            } else {
                autoPlayBtn.classList.remove('active');
                fullscreenAutoPlayBtn.classList.remove('active');

                // Enable loop button again
                loopBtn.classList.remove('inactive');
                fullscreenLoopBtn.classList.remove('inactive');
            }
        }

        // Toggle mute
        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('mute-btn');
            const fullscreenMuteBtn = document.getElementById('fullscreen-mute-btn');
            
            if (isMuted) {
                player.muted = true;
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                fullscreenMuteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                muteBtn.classList.add('active');
                fullscreenMuteBtn.classList.add('active');
            } else {
                player.muted = false;
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                fullscreenMuteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                muteBtn.classList.remove('active');
                fullscreenMuteBtn.classList.remove('active');
            }
        }

        // Toggle shuffle
        function shuffleTracks() {
            if (tracks.length === 0) return;
            
            isShuffled = !isShuffled;
            
            if (isShuffled) {
                // Shuffle the tracks array
                for (let i = tracks.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tracks[i], tracks[j]] = [tracks[j], tracks[i]];
                }
            } else {
                // Restore original order
                tracks = [...originalTracksOrder];
            }
            
            // Update the UI to reflect new order
            const resultsDiv = document.getElementById("results");
            const trendingDiv = document.getElementById("trending-results");
            const playedDiv = document.getElementById("played-results");
            
            // Clear and rebuild result lists
            if (resultsDiv.innerHTML !== "") {
                resultsDiv.innerHTML = "";
                rebuildTrackList(resultsDiv);
            }
            
            if (trendingDiv.innerHTML !== "") {
                trendingDiv.innerHTML = "";
                rebuildTrackList(trendingDiv);
            }
            
            if (playedDiv.innerHTML !== "") {
                playedDiv.innerHTML = "";
                rebuildTrackList(playedDiv);
            }
        }

        function rebuildTrackList(container) {
            tracks.forEach((item, index) => {
                const trackElement = createTrackElement(item, index, currentTrackSource);
                
                if (index === currentTrackIndex) {
                    trackElement.classList.add("playing");
                }
                
                trackElement.onclick = () => {
                    playTrack(index);
                };

                container.appendChild(trackElement);
            });
        }

        // Update progress bar
        function updateProgressBar() {
            if (!player.duration) return;
            
            const progressBar = document.getElementById('progress-bar');
            const fullscreenProgressBar = document.getElementById('fullscreen-progress-bar');
            const currentTimeElement = document.getElementById('current-time');
            const durationElement = document.getElementById('duration');
            const fullscreenCurrentTimeElement = document.getElementById('fullscreen-current-time');
            const fullscreenDurationElement = document.getElementById('fullscreen-duration');
            
            const duration = player.duration;
            const currentTime = player.currentTime;
            
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            fullscreenProgressBar.style.width = `${progressPercent}%`;
            
            // Format time displays
            currentTimeElement.textContent = formatTime(currentTime);
            durationElement.textContent = formatTime(duration);
            fullscreenCurrentTimeElement.textContent = formatTime(currentTime);
            fullscreenDurationElement.textContent = formatTime(duration);
        }

        // Format time in minutes:seconds
        function formatTime(time) {
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Seek functionality
        document.getElementById('progress-container').addEventListener('click', function(e) {
            if (!player.duration) return;
            
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const seekTime = (clickX / width) * player.duration;
            
            player.currentTime = seekTime;
        });

        // Fullscreen player functions
        function openFullscreen() {
            if (!player.src) return;
            
            document.getElementById('fullscreen-player').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-player').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close fullscreen when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });

        // Initialize the player when page loads
        window.onload = initPlayer;
    </script>
</body>
</html>
