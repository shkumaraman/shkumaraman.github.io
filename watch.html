<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>watch together · sync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
background:#f1f5f9;
font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
}
.frame{
max-width:600px;
width:100%;
padding:15px;
}
.link-bar{
display:flex;
gap:12px;
margin-bottom:20px;
flex-wrap:wrap;
}
.link-field{
flex:1;
display:flex;
align-items:center;
background:#f8fafc;
border:1px solid #e2e8f0;
border-radius:60px;
padding:0 18px;
}
#videoLink{
width:100%;
padding:14px 0;
border:none;
background:transparent;
font-size:1rem;
outline:none;
}
.load-btn{
background:#2563eb;
color:white;
border:none;
border-radius:60px;
padding:0 28px;
font-weight:600;
font-size:1rem;
cursor:pointer;
}
.player-box{
background:#0b1120;
border-radius:24px;
overflow:hidden;
margin-bottom:18px;
}
#player{
width:100%;
aspect-ratio:16/9;
border:none;
}
.toolbar{
display:flex;
justify-content:space-between;
margin:16px 0;
}
.live-badge{
background:#e6f7e6;
border-radius:40px;
padding:8px 20px;
display:flex;
gap:8px;
font-size:0.9rem;
color:#166534;
border:1px solid #86efac;
}
.chat-area{
background:#f8fafc;
border-radius:24px;
border:1px solid #e2e8f0;
overflow:hidden;
}
.chat-header{
padding:16px;
font-weight:500;
}
.msg-window{
background:white;
padding:16px;
height:200px;
overflow-y:auto;
display:flex;
flex-direction:column;
gap:8px;
}
.chat-message{
background:transparent;
padding:4px 0;
font-size:0.95rem;
border-bottom:1px solid #e9eef3;
}
.chat-input-row{
display:flex;
padding:12px;
background:#f8fafc;
}
.chat-field{
flex:1;
}
#chatMessage{
width:100%;
padding:12px;
border-radius:20px;
border:1px solid #cbd5e1;
}
.send-btn{
background:#2563eb;
border:none;
color:white;
border-radius:50%;
width:44px;
height:44px;
margin-left:8px;
cursor:pointer;
}
</style>
</head>
<body>
<div class="frame">
<div class="link-bar">
<div class="link-field">
<i class="fas fa-link"></i>
<input id="videoLink" placeholder="Paste YouTube link or video url (mp4, webm)">
</div>
<button class="load-btn" id="loadBtn">
<i class="fas fa-play"></i> Load
</button>
</div>
<div class="player-box">
<iframe id="player" allowfullscreen allow="autoplay"></iframe>
</div>
<div class="toolbar">
<div class="live-badge">
<i class="fas fa-cloud"></i>
<span id="syncStatus">connecting...</span>
</div>
</div>
<div class="chat-area">
<div class="chat-header">
<i class="fas fa-comment"></i> Group Chat
</div>
<div id="chatMessages" class="msg-window"></div>
<div class="chat-input-row">
<div class="chat-field">
<input id="chatMessage" placeholder="Say something...">
</div>
<button id="sendChatBtn" class="send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
const firebaseConfig = {
databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const roomRef = ref(db, "watch");
const player = document.getElementById("player");
const input = document.getElementById("videoLink");
const loadBtn = document.getElementById("loadBtn");
const syncStatus = document.getElementById("syncStatus");
const chatBox = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatMessage");
const sendBtn = document.getElementById("sendChatBtn");
let localUpdate = false;
let currentLink = "";
let currentState = { playing: false, time: 0 };
let seeking = false;
let lastSeek = 0;
function extractYouTubeId(url) {
if (!url) return null;
const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
const match = url.match(regExp);
return (match && match[2] && match[2].length === 11) ? match[2] : null;
}
function isDirectVideoFile(url) {
try {
const parsed = new URL(url);
const path = parsed.pathname.toLowerCase();
if (parsed.hostname.includes('drive.google.com')) return false;
return path.endsWith('.mp4') || path.endsWith('.webm') || path.endsWith('.ogg') || path.endsWith('.mov');
} catch {
return false;
}
}
function loadVideo(link) {
const ytId = extractYouTubeId(link);
if (ytId) {
player.src = `https://www.youtube.com/embed/${ytId}?enablejsapi=1&origin=${encodeURIComponent(window.location.origin)}`;
currentLink = link;
return;
}
if (isDirectVideoFile(link)) {
player.src = link;
currentLink = link;
return;
}
alert("Only YouTube or direct video file (mp4, webm) — Google Drive not allowed");
}
function syncToFirebase(partial) {
localUpdate = true;
update(roomRef, partial).finally(() => { localUpdate = false; });
}
loadBtn.onclick = () => {
const link = input.value.trim();
if (!link) return;
if (link.includes('drive.google.com')) {
alert("Google Drive not supported");
return;
}
syncToFirebase({ link, updated: Date.now() });
};
input.onkeypress = e => {
if (e.key === "Enter") loadBtn.click();
};
window.addEventListener('message', (e) => {
try {
if (!e.data || typeof e.data !== 'object') return;
if (e.data.event === 'onReady' && player.src) {
setTimeout(() => {
player.contentWindow.postMessage('{"event":"command","func":"getCurrentTime","args":""}', '*');
player.contentWindow.postMessage('{"event":"command","func":"getPlayerState","args":""}', '*');
}, 500);
}
if (e.data.event === 'infoDelivery') {
if (e.data.info && e.data.info.currentTime !== undefined && !seeking) {
const t = Math.floor(e.data.info.currentTime);
if (Math.abs(t - currentState.time) > 1.5) {
currentState.time = t;
if (!localUpdate) syncToFirebase({ time: t, playing: currentState.playing });
}
}
if (e.data.info && e.data.info.playerState !== undefined) {
const ps = e.data.info.playerState;
const isPlaying = (ps === 1);
if (isPlaying !== currentState.playing) {
currentState.playing = isPlaying;
if (!localUpdate) syncToFirebase({ playing: isPlaying, time: currentState.time });
}
}
}
} catch (er) {}
});
setInterval(() => {
if (!player.src || !player.contentWindow || seeking) return;
player.contentWindow.postMessage('{"event":"command","func":"getCurrentTime","args":""}', '*');
player.contentWindow.postMessage('{"event":"command","func":"getPlayerState","args":""}', '*');
}, 3000);
function applyRemoteState(data) {
if (!data || !player.src) return;
if (data.link && data.link !== currentLink) {
input.value = data.link;
loadVideo(data.link);
}
if (player.tagName === 'IFRAME' && player.src.includes('youtube')) {
if (data.playing !== undefined) {
const cmd = data.playing ? 'playVideo' : 'pauseVideo';
player.contentWindow.postMessage(`{"event":"command","func":"${cmd}","args":""}`, '*');
}
if (data.time !== undefined && Math.abs(data.time - currentState.time) > 2) {
currentState.time = data.time;
player.contentWindow.postMessage(`{"event":"command","func":"seekTo","args":[${data.time}, true]}`, '*');
}
}
}
onValue(roomRef, (snap) => {
if (localUpdate) return;
const data = snap.val();
if (!data) return;
syncStatus.innerText = 'Synced ' + new Date().toLocaleTimeString();
applyRemoteState(data);
}, { onlyOnce: false });
async function sendChat() {
const text = chatInput.value.trim();
if (!text) return;
await push(ref(db, 'watch/messages'), { text, time: Date.now() });
chatInput.value = "";
}
sendBtn.onclick = sendChat;
chatInput.onkeypress = e => {
if (e.key === "Enter") sendChat();
};
onValue(ref(db, 'watch/messages'), (snap) => {
chatBox.innerHTML = "";
const data = snap.val();
if (!data) return;
Object.values(data).forEach(msg => {
const div = document.createElement("div");
div.className = "chat-message";
div.innerText = (typeof msg === 'object' && msg.text) ? msg.text : (typeof msg === 'string' ? msg : '');
chatBox.appendChild(div);
});
chatBox.scrollTop = chatBox.scrollHeight;
});
</script>
</body>
</html>
