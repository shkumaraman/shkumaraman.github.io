<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>watch together Â· sync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
background:#0f172a;
font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
}
.frame{
max-width:700px;
width:100%;
padding:15px;
}
.link-bar{
display:flex;
gap:12px;
margin-bottom:20px;
flex-wrap:wrap;
}
.link-field{
flex:1;
display:flex;
align-items:center;
background:#1e293b;
border:1px solid #334155;
border-radius:60px;
padding:0 18px;
}
#videoLink{
width:100%;
padding:14px 0;
border:none;
background:transparent;
font-size:1rem;
outline:none;
color:white;
}
#videoLink::placeholder{color:#64748b}
.load-btn{
background:#3b82f6;
color:white;
border:none;
border-radius:60px;
padding:0 28px;
font-weight:600;
font-size:1rem;
cursor:pointer;
transition:0.2s;
}
.load-btn:hover{background:#2563eb}
.player-box{
background:#000000;
border-radius:24px;
overflow:hidden;
margin-bottom:18px;
border:1px solid #334155;
}
#player{
width:100%;
aspect-ratio:16/9;
border:none;
background:#000;
}
.video-controls{
background:#0f172a;
padding:15px 20px;
display:flex;
align-items:center;
gap:15px;
flex-wrap:wrap;
border-top:1px solid #334155;
}
.control-btn{
background:#1e293b;
border:none;
color:#94a3b8;
width:45px;
height:45px;
border-radius:50%;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
font-size:1.2rem;
transition:all 0.2s;
}
.control-btn:hover{
background:#3b82f6;
color:white;
transform:scale(1.05);
}
.progress-area{
flex:1;
display:flex;
align-items:center;
gap:15px;
min-width:250px;
}
.progress-bar{
flex:1;
height:6px;
background:#1e293b;
border-radius:3px;
cursor:pointer;
position:relative;
}
.progress-fill{
height:100%;
background:#3b82f6;
border-radius:3px;
width:0%;
position:relative;
transition:width 0.1s linear;
}
.progress-fill::after{
content:'';
position:absolute;
right:-6px;
top:-4px;
width:14px;
height:14px;
background:#3b82f6;
border-radius:50%;
opacity:0;
transition:opacity 0.2s;
}
.progress-bar:hover .progress-fill::after{
opacity:1;
}
.time-display{
color:#94a3b8;
font-size:0.95rem;
font-family:monospace;
min-width:110px;
}
.toolbar{
display:flex;
justify-content:space-between;
margin:16px 0;
}
.live-badge{
background:#1e293b;
border-radius:40px;
padding:8px 20px;
display:flex;
gap:8px;
font-size:0.9rem;
color:#4ade80;
border:1px solid #22c55e;
}
.chat-area{
background:#1e293b;
border-radius:24px;
border:1px solid #334155;
overflow:hidden;
}
.chat-header{
padding:16px;
font-weight:500;
color:white;
border-bottom:1px solid #334155;
}
.msg-window{
background:#0f172a;
padding:16px;
height:220px;
overflow-y:auto;
display:flex;
flex-direction:column;
gap:10px;
}
.msg-bubble{
background:#1e293b;
padding:10px 16px;
border-radius:18px;
max-width:80%;
color:white;
border:1px solid #334155;
}
.chat-input-row{
display:flex;
padding:12px;
background:#1e293b;
gap:8px;
}
.chat-field{
flex:1;
}
#chatMessage{
width:100%;
padding:12px 16px;
border-radius:25px;
border:1px solid #334155;
background:#0f172a;
color:white;
outline:none;
}
#chatMessage::placeholder{color:#64748b}
.send-btn{
background:#3b82f6;
border:none;
color:white;
border-radius:50%;
width:44px;
height:44px;
cursor:pointer;
transition:0.2s;
}
.send-btn:hover{background:#2563eb;transform:scale(1.05)}
</style>
</head>
<body>
<div class="frame">
<div class="link-bar">
<div class="link-field">
<input id="videoLink" placeholder="Paste YouTube link or video URL (mp4, webm, avi, mkv etc.)" autofocus>
</div>
<button class="load-btn" id="loadBtn">
<i class="fas fa-play"></i> Load
</button>
</div>

<div class="player-box">
<iframe id="player" allow="autoplay; fullscreen" allowfullscreen></iframe>
<div class="video-controls">
<button class="control-btn" id="playPauseBtn" title="Play/Pause">
<i class="fas fa-play"></i>
</button>
<div class="progress-area">
<div class="progress-bar" id="progressBar">
<div class="progress-fill" id="progressFill"></div>
</div>
<span class="time-display" id="timeDisplay">0:00 / 0:00</span>
</div>
</div>
</div>

<div class="toolbar">
<div class="live-badge">
<i class="fas fa-wifi"></i>
<span id="syncStatus">connecting to server...</span>
</div>
</div>

<div class="chat-area">
<div class="chat-header">
<i class="fas fa-comment"></i> Group Chat â€¢ Real-time
</div>
<div id="chatMessages" class="msg-window"></div>
<div class="chat-input-row">
<div class="chat-field">
<input id="chatMessage" placeholder="Type a message...">
</div>
<button id="sendChatBtn" class="send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const watchRef = ref(db, "watch");
const chatRef = ref(db, "watch/messages");

const player = document.getElementById("player");
const input = document.getElementById("videoLink");
const loadBtn = document.getElementById("loadBtn");
const syncStatus = document.getElementById("syncStatus");
const chatBox = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatMessage");
const sendBtn = document.getElementById("sendChatBtn");
const playPauseBtn = document.getElementById("playPauseBtn");
const progressFill = document.getElementById("progressFill");
const progressBar = document.getElementById("progressBar");
const timeDisplay = document.getElementById("timeDisplay");

// State management
let currentLink = "";
let isYouTube = false;
let playerReady = false;
let localUpdate = false;
let lastSyncTime = 0;
let userName = "User" + Math.floor(Math.random() * 1000);

// Helper Functions
function extractYouTubeId(url) {
const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
const match = url.match(regExp);
return (match && match[2].length === 11) ? match[2] : null;
}

function isVideoFile(url) {
try {
const parsed = new URL(url);
const path = parsed.pathname.toLowerCase();
return path.match(/\.(mp4|webm|ogg|avi|mkv|mov|flv|wmv)$/i) !== null;
} catch {
return false;
}
}

function formatTime(seconds) {
if (!seconds || isNaN(seconds)) return "0:00";
const hrs = Math.floor(seconds / 3600);
const mins = Math.floor((seconds % 3600) / 60);
const secs = Math.floor(seconds % 60);
if (hrs > 0) {
return `${hrs}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
}
return `${mins}:${secs.toString().padStart(2,'0')}`;
}

// Video Loading
function loadVideo(link) {
const ytId = extractYouTubeId(link);
isYouTube = !!ytId;
currentLink = link;
playerReady = true;

if (ytId) {
// YouTube
player.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&enablejsapi=1&origin=${window.location.origin}`;
syncStatus.innerText = "ðŸ“º YouTube loaded";
} else if (isVideoFile(link)) {
// Direct video
player.src = link;
syncStatus.innerText = "ðŸŽ¬ Video loaded";
} else {
alert("âŒ Link not supported. Use YouTube or direct video (mp4, webm, avi, mkv)");
playerReady = false;
}
}

// YouTube API Communication
window.addEventListener('message', (event) => {
if (!isYouTube || !event.data || typeof event.data !== 'string') return;

if (event.data.includes('ready')) {
playerReady = true;
// Get initial state
const infoMessage = JSON.stringify({event: 'listening', id: 1});
player.contentWindow.postMessage(infoMessage, '*');
}

if (event.data.includes('infoDelivery')) {
try {
const data = JSON.parse(event.data);
if (data.info && data.info.currentTime) {
const currentTime = data.info.currentTime;
const duration = data.info.duration || 0;
progressFill.style.width = (currentTime / duration * 100) + '%';
timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
}
} catch (e) {}
}
});

// HTML5 Video Events
player.addEventListener('load', () => {
if (!isYouTube && playerReady) {
setupHTML5Video();
}
});

function setupHTML5Video() {
const video = player.contentDocument?.querySelector('video') || player;
if (!video) return;

video.addEventListener('play', () => {
if (!localUpdate) {
update(watchRef, {
playing: true,
timestamp: Date.now()
});
}
updatePlayPauseIcon(true);
});

video.addEventListener('pause', () => {
if (!localUpdate) {
update(watchRef, {
playing: false,
timestamp: Date.now()
});
}
updatePlayPauseIcon(false);
});

video.addEventListener('timeupdate', () => {
if (!localUpdate && video.duration) {
const progress = (video.currentTime / video.duration) * 100;
progressFill.style.width = progress + '%';
timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
}
});

video.addEventListener('seeked', () => {
if (!localUpdate && video.duration) {
update(watchRef, {
time: video.currentTime,
timestamp: Date.now()
});
}
});
}

// UI Updates
function updatePlayPauseIcon(isPlaying) {
const icon = playPauseBtn.querySelector('i');
icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
}

// Load Button
loadBtn.onclick = () => {
const link = input.value.trim();
if (!link) {
alert("Please paste a video link");
return;
}
update(watchRef, {
link: link,
updated: Date.now()
});
syncStatus.innerText = "ðŸ”„ Loading video...";
};

input.onkeypress = e => {
if (e.key === "Enter") loadBtn.click();
};

// Play/Pause Control
playPauseBtn.onclick = () => {
if (!playerReady) return;

localUpdate = true;
if (isYouTube) {
// Get current state
const getMessage = JSON.stringify({event: 'command', func: 'getCurrentTime'});
player.contentWindow.postMessage(getMessage, '*');

// Toggle
const command = playPauseBtn.querySelector('i').className.includes('fa-play') ? 'playVideo' : 'pauseVideo';
const message = JSON.stringify({event: 'command', func: command});
player.contentWindow.postMessage(message, '*');
} else {
const video = player.contentDocument?.querySelector('video') || player;
if (video) {
if (video.paused) {
video.play();
} else {
video.pause();
}
}
}
localUpdate = false;
};

// Progress Bar Click
progressBar.onclick = (e) => {
if (!playerReady) return;

const rect = progressBar.getBoundingClientRect();
const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));

localUpdate = true;
if (isYouTube) {
const video = player.contentDocument?.querySelector('video');
if (video && video.duration) {
const seekTime = video.duration * percent;
const message = JSON.stringify({event: 'command', func: 'seekTo', args: [seekTime, true]});
player.contentWindow.postMessage(message, '*');
update(watchRef, {time: seekTime, timestamp: Date.now()});
}
} else {
const video = player.contentDocument?.querySelector('video') || player;
if (video && video.duration) {
video.currentTime = video.duration * percent;
}
}
localUpdate = false;
};

// Firebase Sync
onValue(watchRef, (snap) => {
const data = snap.val();
if (!data) return;

const now = Date.now();
syncStatus.innerText = `âœ… Synced ${new Date().toLocaleTimeString()}`;

// Load new video
if (data.link && data.link !== currentLink) {
input.value = data.link;
loadVideo(data.link);
}

// Sync play/pause
if (!localUpdate && data.playing !== undefined && playerReady) {
if (isYouTube) {
const command = data.playing ? 'playVideo' : 'pauseVideo';
const message = JSON.stringify({event: 'command', func: command});
player.contentWindow.postMessage(message, '*');
} else {
const video = player.contentDocument?.querySelector('video') || player;
if (video) {
if (data.playing && video.paused) video.play();
else if (!data.playing && !video.paused) video.pause();
}
}
updatePlayPauseIcon(data.playing);
}

// Sync time (if difference > 2 seconds)
if (!localUpdate && data.time !== undefined && playerReady) {
let currentTime = 0;
if (isYouTube) {
// For YouTube we need to get current time via API
// This is simplified - in production you'd use YouTube API
} else {
const video = player.contentDocument?.querySelector('video') || player;
currentTime = video?.currentTime || 0;
}
if (Math.abs(data.time - currentTime) > 2) {
if (isYouTube) {
const message = JSON.stringify({event: 'command', func: 'seekTo', args: [data.time, true]});
player.contentWindow.postMessage(message, '*');
} else {
const video = player.contentDocument?.querySelector('video') || player;
if (video) video.currentTime = data.time;
}
}
}
});

// Chat Functions
async function sendChat() {
const text = chatInput.value.trim();
if (!text) return;

await push(chatRef, {
text: text,
user: userName,
time: Date.now()
});
chatInput.value = "";
}

sendBtn.onclick = sendChat;
chatInput.onkeypress = e => {
if (e.key === "Enter") sendChat();
};

// Display Messages
onValue(chatRef, (snap) => {
chatBox.innerHTML = "";
const data = snap.val();
if (!data) return;

Object.values(data).reverse().slice(0, 50).reverse().forEach(msg => {
const div = document.createElement("div");
div.className = "msg-bubble";
const user = msg.user || "Anonymous";
const time = msg.time ? new Date(msg.time).toLocaleTimeString() : "";
div.innerHTML = `<small style="color:#94a3b8">${user} ${time}</small><br>${msg.text || msg}`;
chatBox.appendChild(div);
});
chatBox.scrollTop = chatBox.scrollHeight;
});

// Initial sync
update(watchRef, {connected: true, timestamp: Date.now()});

console.log("âœ… Watch Together Synced - All features active");
</script>
</body>
</html>
