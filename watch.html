<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together Sync</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>

body{
background:#0f172a;
color:white;
font-family:system-ui;
display:flex;
justify-content:center;
padding:20px;
}

.frame{
width:600px;
max-width:100%;
}

input{
width:100%;
padding:12px;
border-radius:8px;
border:none;
margin-bottom:10px;
}

button{
padding:10px 15px;
border:none;
border-radius:8px;
background:#2563eb;
color:white;
cursor:pointer;
}

.player-box{
background:black;
border-radius:12px;
overflow:hidden;
}

iframe,video{
width:100%;
aspect-ratio:16/9;
border:none;
}

.controls{
display:flex;
align-items:center;
gap:10px;
padding:10px;
}

.progress{
flex:1;
height:5px;
background:#334155;
cursor:pointer;
}

.fill{
height:100%;
background:#2563eb;
width:0%;
}

.chat{
margin-top:15px;
background:#1e293b;
padding:10px;
border-radius:10px;
}

.msgs{
height:150px;
overflow:auto;
}

</style>
</head>
<body>

<div class="frame">

<input id="linkInput"
placeholder="Paste YouTube or video link">

<button id="loadBtn">Load</button>

<div class="player-box">

<iframe id="yt"
allow="autoplay"
style="display:none"></iframe>

<video id="video"
controls
style="display:none"></video>

<div class="controls">

<button id="playBtn">
<i class="fas fa-play"></i>
</button>

<div class="progress" id="progress">
<div class="fill" id="fill"></div>
</div>

<span id="time">0:00 / 0:00</span>

</div>
</div>


<div class="chat">

<div class="msgs" id="msgs"></div>

<input id="msgInput"
placeholder="message">

<button id="sendBtn">Send</button>

</div>

</div>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getDatabase,
ref,
onValue,
update,
push
}
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const config={
databaseURL:
"https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app=initializeApp(config);

const db=getDatabase(app);

const watchRef=ref(db,"watch");
const controlRef=ref(db,"watch/control");
const chatRef=ref(db,"watch/chat");


const yt=document.getElementById("yt");
const video=document.getElementById("video");

const linkInput=document.getElementById("linkInput");

const playBtn=document.getElementById("playBtn");

const progress=document.getElementById("progress");
const fill=document.getElementById("fill");

const timeText=document.getElementById("time");

const msgs=document.getElementById("msgs");

let isYT=false;
let ready=false;
let duration=0;
let current="";
let local=false;


function ytID(url){

const reg=
/(?:youtube\.com.*v=|youtu\.be\/)([^&]+)/;

const m=url.match(reg);

return m?m[1]:null;

}


function load(link){

const id=ytID(link);

current=link;

if(id){

isYT=true;

video.style.display="none";
yt.style.display="block";

yt.src=
`https://www.youtube.com/embed/${id}?enablejsapi=1`;

}else{

isYT=false;

yt.style.display="none";
video.style.display="block";

video.src=link;

video.load();

}

ready=true;

}


function send(state){

if(local)return;

local=true;

update(controlRef,{
...state,
t:Date.now()
}).finally(()=>{
local=false;
});

}


function play(){

if(isYT){

yt.contentWindow.postMessage(JSON.stringify({
event:"command",
func:"playVideo"
}),"*");

}else{

video.play();

}

send({playing:true});

}


function pause(){

if(isYT){

yt.contentWindow.postMessage(JSON.stringify({
event:"command",
func:"pauseVideo"
}),"*");

}else{

video.pause();

}

send({playing:false});

}


function seek(time){

if(isYT){

yt.contentWindow.postMessage(JSON.stringify({
event:"command",
func:"seekTo",
args:[time,true]
}),"*");

}else{

video.currentTime=time;

}

send({time:time});

}


playBtn.onclick=()=>{

if(isYT){

play();

}else{

video.paused?play():pause();

}

};


progress.onclick=e=>{

if(!ready)return;

const rect=progress.getBoundingClientRect();

const percent=
(e.clientX-rect.left)/rect.width;

seek(duration*percent);

};


video.addEventListener("timeupdate",()=>{

duration=video.duration||0;

const t=video.currentTime||0;

fill.style.width=(t/duration*100)+"%";

timeText.innerText=
format(t)+" / "+format(duration);

});


function format(s){

const m=Math.floor(s/60);

const sec=Math.floor(s%60);

return `${m}:${sec.toString().padStart(2,"0")}`;

}


document.getElementById("loadBtn").onclick=()=>{

const link=linkInput.value.trim();

if(!link)return;

update(watchRef,{
link:link
});

};


onValue(watchRef,snap=>{

const d=snap.val();

if(!d)return;

if(d.link && d.link!==current){

load(d.link);

}

});


onValue(controlRef,snap=>{

if(local)return;

const d=snap.val();

if(!d)return;

local=true;

if(d.playing!==undefined){

d.playing?play():pause();

}

if(d.time!==undefined){

seek(d.time);

}

local=false;

});


setInterval(()=>{

if(!ready)return;

if(!isYT){

send({
time:video.currentTime
});

}

},2000);


// CHAT

document.getElementById("sendBtn").onclick=()=>{

const text=
document.getElementById("msgInput").value;

if(!text)return;

push(chatRef,{
text:text
});

document.getElementById("msgInput").value="";

};


onValue(chatRef,snap=>{

msgs.innerHTML="";

snap.forEach(c=>{

const div=document.createElement("div");

div.innerText=c.val().text;

msgs.appendChild(div);

});

msgs.scrollTop=msgs.scrollHeight;

});

</script>

</body>
</html>
