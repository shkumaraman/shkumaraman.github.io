<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>watch together sync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
background:#0f172a;
font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
}
.frame{
max-width:700px;
width:100%;
padding:15px;
}
.link-bar{
display:flex;
gap:12px;
margin-bottom:20px;
flex-wrap:wrap;
}
.link-field{
flex:1;
display:flex;
align-items:center;
background:#1e293b;
border:1px solid #334155;
border-radius:60px;
padding:0 18px;
}
#videoLink{
width:100%;
padding:14px 0;
border:none;
background:transparent;
font-size:1rem;
outline:none;
color:white;
}
#videoLink::placeholder{color:#64748b}
.load-btn{
background:#3b82f6;
color:white;
border:none;
border-radius:60px;
padding:0 28px;
font-weight:600;
font-size:1rem;
cursor:pointer;
transition:0.2s;
}
.load-btn:hover{background:#2563eb}
.player-box{
background:#000000;
border-radius:24px;
overflow:hidden;
margin-bottom:18px;
border:1px solid #334155;
}
#player{
width:100%;
aspect-ratio:16/9;
border:none;
background:#000;
}
.video-controls{
background:#0f172a;
padding:15px 20px;
display:flex;
align-items:center;
gap:15px;
flex-wrap:wrap;
border-top:1px solid #334155;
}
.control-btn{
background:#1e293b;
border:none;
color:#94a3b8;
width:45px;
height:45px;
border-radius:50%;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
font-size:1.2rem;
transition:all 0.2s;
}
.control-btn:hover{
background:#3b82f6;
color:white;
transform:scale(1.05);
}
.progress-area{
flex:1;
display:flex;
align-items:center;
gap:15px;
min-width:250px;
}
.progress-bar{
flex:1;
height:6px;
background:#1e293b;
border-radius:3px;
cursor:pointer;
position:relative;
}
.progress-fill{
height:100%;
background:#3b82f6;
border-radius:3px;
width:0%;
position:relative;
transition:width 0.1s linear;
}
.progress-fill::after{
content:'';
position:absolute;
right:-6px;
top:-4px;
width:14px;
height:14px;
background:#3b82f6;
border-radius:50%;
opacity:0;
transition:opacity 0.2s;
}
.progress-bar:hover .progress-fill::after{
opacity:1;
}
.time-display{
color:#94a3b8;
font-size:0.95rem;
font-family:monospace;
min-width:110px;
}
.toolbar{
display:flex;
justify-content:space-between;
margin:16px 0;
}
.live-badge{
background:#1e293b;
border-radius:40px;
padding:8px 20px;
display:flex;
gap:8px;
font-size:0.9rem;
color:#4ade80;
border:1px solid #22c55e;
}
.chat-area{
background:#1e293b;
border-radius:24px;
border:1px solid #334155;
overflow:hidden;
}
.chat-header{
padding:16px;
font-weight:500;
color:white;
border-bottom:1px solid #334155;
}
.msg-window{
background:#0f172a;
padding:16px;
height:220px;
overflow-y:auto;
display:flex;
flex-direction:column;
gap:8px;
}
.msg-text{
color:white;
font-size:0.95rem;
line-height:1.4;
}
.chat-input-row{
display:flex;
padding:12px;
background:#1e293b;
gap:8px;
}
.chat-field{
flex:1;
}
#chatMessage{
width:100%;
padding:12px 16px;
border-radius:25px;
border:1px solid #334155;
background:#0f172a;
color:white;
outline:none;
}
#chatMessage::placeholder{color:#64748b}
.send-btn{
background:#3b82f6;
border:none;
color:white;
border-radius:50%;
width:44px;
height:44px;
cursor:pointer;
transition:0.2s;
}
.send-btn:hover{background:#2563eb;transform:scale(1.05)}
</style>
</head>
<body>
<div class="frame">
<div class="link-bar">
<div class="link-field">
<input id="videoLink" placeholder="Paste YouTube link or video URL" autofocus>
</div>
<button class="load-btn" id="loadBtn">
<i class="fas fa-play"></i> Load
</button>
</div>

<div class="player-box">
<iframe id="player" allow="autoplay; fullscreen" allowfullscreen></iframe>
<div class="video-controls">
<button class="control-btn" id="prevBtn" title="Back 10 seconds">
<i class="fas fa-backward"></i>
</button>
<button class="control-btn" id="playPauseBtn" title="Play/Pause">
<i class="fas fa-play"></i>
</button>
<button class="control-btn" id="nextBtn" title="Forward 10 seconds">
<i class="fas fa-forward"></i>
</button>
<div class="progress-area">
<div class="progress-bar" id="progressBar">
<div class="progress-fill" id="progressFill"></div>
</div>
<span class="time-display" id="timeDisplay">0:00 / 0:00</span>
</div>
</div>
</div>

<div class="toolbar">
<div class="live-badge">
<i class="fas fa-wifi"></i>
<span id="syncStatus">connecting to server...</span>
</div>
</div>

<div class="chat-area">
<div class="chat-header">
<i class="fas fa-comment"></i> Group Chat
</div>
<div id="chatMessages" class="msg-window"></div>
<div class="chat-input-row">
<div class="chat-field">
<input id="chatMessage" placeholder="Type a message...">
</div>
<button id="sendChatBtn" class="send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
databaseURL: "https://talkrush-76259-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const watchRef = ref(db, "watch");
const chatRef = ref(db, "watch/messages");

const player = document.getElementById("player");
const input = document.getElementById("videoLink");
const loadBtn = document.getElementById("loadBtn");
const syncStatus = document.getElementById("syncStatus");
const chatBox = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatMessage");
const sendBtn = document.getElementById("sendChatBtn");
const playPauseBtn = document.getElementById("playPauseBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const progressFill = document.getElementById("progressFill");
const progressBar = document.getElementById("progressBar");
const timeDisplay = document.getElementById("timeDisplay");

let currentLink = "";
let isYouTube = false;
let playerReady = false;
let localUpdate = false;
let hasUserLeft = false;
let currentVideoTime = 0;
let videoDuration = 0;
let lastFirebaseUpdate = 0;
let isPlaying = false;
let userName = "User" + Math.floor(Math.random() * 1000);
let youtubeInterval = null;

function extractYouTubeId(url) {
const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
const match = url.match(regExp);
return (match && match[2].length === 11) ? match[2] : null;
}

function isVideoFile(url) {
try {
const parsed = new URL(url);
const path = parsed.pathname.toLowerCase();
return path.match(/\.(mp4|webm|ogg|avi|mkv|mov|flv|wmv)$/i) !== null;
} catch {
return false;
}
}

function formatTime(seconds) {
if (!seconds || isNaN(seconds)) return "0:00";
const mins = Math.floor(seconds / 60);
const secs = Math.floor(seconds % 60);
return `${mins}:${secs.toString().padStart(2,'0')}`;
}

function loadVideo(link) {
const ytId = extractYouTubeId(link);
isYouTube = !!ytId;
currentLink = link;
playerReady = true;

if (youtubeInterval) {
clearInterval(youtubeInterval);
youtubeInterval = null;
}

if (ytId) {
player.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&enablejsapi=1&origin=${window.location.origin}`;
syncStatus.innerText = "YouTube loaded";
setupYouTubeAPI();
} else if (isVideoFile(link)) {
player.src = link;
syncStatus.innerText = "Video loaded";
setupHTML5Video();
} else {
alert("Link not supported. Use YouTube or direct video");
playerReady = false;
return;
}

update(watchRef, {
link: link,
time: 0,
playing: true,
timestamp: Date.now(),
lastUpdate: Date.now()
});
}

function setupYouTubeAPI() {
youtubeInterval = setInterval(() => {
if (!isYouTube || !player || !player.contentWindow) return;
const message = JSON.stringify({event: 'listening', id: 1});
player.contentWindow.postMessage(message, '*');
}, 1000);

window.addEventListener('message', function onYouTubeMessage(event) {
if (!isYouTube || !event.data || typeof event.data !== 'string') return;

try {
const data = JSON.parse(event.data);
if (data.event === 'infoDelivery' && data.info) {
if (data.info.currentTime !== undefined && data.info.duration !== undefined) {
currentVideoTime = data.info.currentTime;
videoDuration = data.info.duration || 0;
updateProgressAndTime();

if (data.info.playerState !== undefined) {
const wasPlaying = isPlaying;
isPlaying = (data.info.playerState === 1);
if (wasPlaying !== isPlaying) {
updatePlayPauseIcon();
}
}
}
}
} catch (e) {}
});
}

function setupHTML5Video() {
const checkVideo = () => {
const video = player.contentDocument?.querySelector('video');
if (video) {
video.addEventListener('play', () => {
isPlaying = true;
updatePlayPauseIcon();
if (!localUpdate && !hasUserLeft) {
update(watchRef, {
playing: true,
timestamp: Date.now(),
lastUpdate: Date.now()
});
}
});

video.addEventListener('pause', () => {
isPlaying = false;
updatePlayPauseIcon();
if (!localUpdate && !hasUserLeft) {
update(watchRef, {
playing: false,
timestamp: Date.now(),
lastUpdate: Date.now()
});
}
});

video.addEventListener('timeupdate', () => {
if (video.duration) {
currentVideoTime = video.currentTime;
videoDuration = video.duration;
updateProgressAndTime();
}
});

video.addEventListener('seeked', () => {
if (!localUpdate && video.duration && !hasUserLeft) {
update(watchRef, {
time: video.currentTime,
timestamp: Date.now(),
lastUpdate: Date.now()
});
}
});
} else {
setTimeout(checkVideo, 500);
}
};
checkVideo();
}

function updateProgressAndTime() {
if (videoDuration > 0) {
const progress = (currentVideoTime / videoDuration) * 100;
progressFill.style.width = progress + '%';
timeDisplay.textContent = `${formatTime(currentVideoTime)} / ${formatTime(videoDuration)}`;
}
}

function updatePlayPauseIcon() {
const icon = playPauseBtn.querySelector('i');
icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
}

function getCurrentTime() {
if (isYouTube) {
return currentVideoTime;
} else {
const video = player.contentDocument?.querySelector('video');
return video ? video.currentTime : 0;
}
}

function getDuration() {
if (isYouTube) {
return videoDuration;
} else {
const video = player.contentDocument?.querySelector('video');
return video ? video.duration : 0;
}
}

function controlVideo(action, value) {
if (!playerReady || !currentLink) return;

localUpdate = true;

if (isYouTube) {
let command = '';
let args = [];
switch(action) {
case 'play':
command = 'playVideo';
break;
case 'pause':
command = 'pauseVideo';
break;
case 'seek':
command = 'seekTo';
args = [value, true];
break;
case 'forward':
command = 'seekTo';
args = [value, true];
break;
case 'backward':
command = 'seekTo';
args = [value, true];
break;
}
const message = JSON.stringify({event: 'command', func: command, args: args});
player.contentWindow.postMessage(message, '*');

if (action === 'play') isPlaying = true;
if (action === 'pause') isPlaying = false;

setTimeout(() => {
localUpdate = false;
}, 100);
} else {
const video = player.contentDocument?.querySelector('video') || player;
if (video) {
switch(action) {
case 'play':
video.play();
isPlaying = true;
break;
case 'pause':
video.pause();
isPlaying = false;
break;
case 'seek':
video.currentTime = value;
break;
case 'forward':
video.currentTime = value;
break;
case 'backward':
video.currentTime = value;
break;
}
updatePlayPauseIcon();
localUpdate = false;
}
}

if (!hasUserLeft && (action === 'seek' || action === 'forward' || action === 'backward')) {
update(watchRef, {
time: value,
timestamp: Date.now(),
lastUpdate: Date.now()
});
}
}

setInterval(() => {
if (!hasUserLeft && playerReady && currentLink && !localUpdate) {
const now = Date.now();
if (now - lastFirebaseUpdate > 3000) {
lastFirebaseUpdate = now;
const currentTime = getCurrentTime();
update(watchRef, {
time: currentTime,
playing: isPlaying,
timestamp: now,
lastUpdate: now
}).catch(() => {});
}
}
}, 3000);

loadBtn.onclick = () => {
const link = input.value.trim();
if (!link) {
alert("Please paste a video link");
return;
}
loadVideo(link);
syncStatus.innerText = "Loading video...";
};

input.onkeypress = e => {
if (e.key === "Enter") loadBtn.click();
};

playPauseBtn.onclick = () => {
controlVideo(isPlaying ? 'pause' : 'play');
};

prevBtn.onclick = () => {
const currentTime = getCurrentTime();
const newTime = Math.max(0, currentTime - 10);
controlVideo('backward', newTime);
};

nextBtn.onclick = () => {
const currentTime = getCurrentTime();
const duration = getDuration();
const newTime = Math.min(duration, currentTime + 10);
controlVideo('forward', newTime);
};

progressBar.onclick = (e) => {
if (!playerReady || !currentLink) return;

const rect = progressBar.getBoundingClientRect();
const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));

if (videoDuration > 0) {
const seekTime = videoDuration * percent;
controlVideo('seek', seekTime);
}
};

document.addEventListener('visibilitychange', () => {
if (document.hidden) {
hasUserLeft = true;
} else {
hasUserLeft = false;
}
});

onValue(watchRef, (snap) => {
const data = snap.val();
if (!data || hasUserLeft) return;

const now = Date.now();
syncStatus.innerText = `Synced ${new Date().toLocaleTimeString()}`;

if (data.link && data.link !== currentLink) {
input.value = data.link;
loadVideo(data.link);
return;
}

if (!playerReady || !currentLink) return;

let targetTime = data.time || 0;
if (data.lastUpdate && data.playing) {
const timeDiff = Math.floor((now - data.lastUpdate) / 1000);
targetTime = data.time + timeDiff;
if (targetTime > getDuration() && getDuration() > 0) {
targetTime = getDuration();
}
}

if (!localUpdate) {
const currentTime = getCurrentTime();

if (data.playing !== undefined && data.playing !== isPlaying) {
controlVideo(data.playing ? 'play' : 'pause');
}

if (data.time !== undefined && Math.abs(targetTime - currentTime) > 1.5) {
controlVideo('seek', targetTime);
}
}
});

async function sendChat() {
const text = chatInput.value.trim();
if (!text) return;

await push(chatRef, {
text: text,
user: userName,
time: Date.now()
});
chatInput.value = "";
}

sendBtn.onclick = sendChat;
chatInput.onkeypress = e => {
if (e.key === "Enter") sendChat();
};

onValue(chatRef, (snap) => {
chatBox.innerHTML = "";
const data = snap.val();
if (!data) return;

Object.values(data).reverse().slice(0, 50).reverse().forEach(msg => {
const div = document.createElement("div");
div.className = "msg-text";
div.textContent = msg.text || msg;
chatBox.appendChild(div);
});
chatBox.scrollTop = chatBox.scrollHeight;
});

update(watchRef, {connected: true, timestamp: Date.now()});

console.log("Watch Together Synced");
</script>
</body>
</html>
